#!/usr/bin/env bash
# =============================================================================
# REALM OF TRAINING - Pre-commit Hook
# =============================================================================
# This hook prevents accidental commit of hardcoded paths.
#
# To install:
#   git config core.hooksPath .githooks
#
# To bypass (use sparingly):
#   git commit --no-verify
# =============================================================================

set -e

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo -e "${GREEN}Running pre-commit checks...${NC}"

# Get list of staged files (excluding deleted files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=d)

if [ -z "$STAGED_FILES" ]; then
    echo "No files staged for commit"
    exit 0
fi

# Check for hardcoded home paths
echo -n "Checking for hardcoded paths... "

HARDCODE_FOUND=0
HARDCODE_FILES=""

for file in $STAGED_FILES; do
    # Skip binary files, images, and specific patterns
    if [[ "$file" == *.png ]] || [[ "$file" == *.jpg ]] || [[ "$file" == *.db ]]; then
        continue
    fi

    # Skip gitignore'd patterns (these shouldn't be staged anyway)
    if [[ "$file" == config/hosts.json ]] || \
       [[ "$file" == config/devices.json ]] || \
       [[ "$file" == config/storage_zones.json ]] || \
       [[ "$file" == .env ]]; then
        echo ""
        echo -e "${RED}ERROR: $file should not be committed (contains personal config)${NC}"
        echo "Add to .gitignore or use: git reset HEAD $file"
        exit 1
    fi

    # Check for hardcoded home paths (but allow documentation and test examples)
    if git show ":$file" 2>/dev/null | grep -q "/home/[a-z]"; then
        # Check if it's in allowed locations (docs, scratch, tests, experiments, analysis)
        if [[ "$file" == *.md ]] || \
           [[ "$file" == scratch/* ]] || \
           [[ "$file" == archive/* ]] || \
           [[ "$file" == tests/* ]] || \
           [[ "$file" == tools/experiments/* ]] || \
           [[ "$file" == tools/analysis/* ]] || \
           [[ "$file" == tools/adaptive_curriculum/* ]]; then
            continue  # Allow in documentation and test files
        fi

        # Check if it's a code file with hardcodes
        if [[ "$file" == *.py ]] || [[ "$file" == *.sh ]] || \
           [[ "$file" == *.json ]] || [[ "$file" == *.yaml ]] || [[ "$file" == *.yml ]]; then
            HARDCODE_FOUND=1
            HARDCODE_FILES="$HARDCODE_FILES\n  - $file"
        fi
    fi
done

if [ $HARDCODE_FOUND -eq 1 ]; then
    echo -e "${RED}FAILED${NC}"
    echo ""
    echo -e "${RED}=== HARDCODED PATHS DETECTED ===${NC}"
    echo -e "The following files contain hardcoded home paths (/home/<user>/):"
    echo -e "$HARDCODE_FILES"
    echo ""
    echo "Please fix these before committing:"
    echo "  1. Use environment variables (e.g., TRAINING_BASE_DIR)"
    echo "  2. Use core.paths.get_base_dir() in Python"
    echo "  3. Use relative paths"
    echo ""
    echo "To bypass this check (not recommended):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

echo -e "${GREEN}OK${NC}"

# Check for large files
echo -n "Checking for large files... "
LARGE_FILES=""
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file" 2>/dev/null || echo 0)
        if [ "$size" -gt 10485760 ]; then  # 10MB
            LARGE_FILES="$LARGE_FILES\n  - $file ($(numfmt --to=iec $size))"
        fi
    fi
done

if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}WARNING${NC}"
    echo -e "Large files detected:$LARGE_FILES"
    echo "Consider adding them to .gitignore"
else
    echo -e "${GREEN}OK${NC}"
fi

echo -e "${GREEN}Pre-commit checks passed!${NC}"
exit 0
