#!/bin/bash
# Branch Officer launcher script
#
# Start a Branch Officer daemon on a remote zone
#
# Usage:
#   branch_officer 3090    # Start on 3090 with config from hosts.json
#   branch_officer nas     # Start on NAS with config from hosts.json
#   branch_officer --help  # Show help

set -e

BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
SCRIPT="$BASE_DIR/vault/branch_officer.py"
HOSTS_CONFIG="$BASE_DIR/config/hosts.json"

show_help() {
    echo "Branch Officer Launcher"
    echo ""
    echo "Usage:"
    echo "  branch_officer <zone>           Start Branch Officer for a zone"
    echo "  branch_officer <zone> --daemon  Run in background"
    echo "  branch_officer --help           Show this help"
    echo ""
    echo "Zones are configured in config/hosts.json"
    echo ""
    echo "Examples:"
    echo "  # Start on 3090 (run this ON the 3090):"
    echo "  branch_officer 3090"
    echo ""
    echo "  # Start on 3090 in background:"
    echo "  branch_officer 3090 --daemon"
    echo ""
    echo "Endpoints (once running):"
    echo "  GET  /status       Zone health and status"
    echo "  GET  /assets       List local assets"
    echo "  GET  /fetch/<id>   Get asset details/transfer info"
    echo "  POST /scan         Scan for new assets"
    echo "  POST /receive      Prepare to receive asset"
}

if [ "$1" == "--help" ] || [ "$1" == "-h" ]; then
    show_help
    exit 0
fi

if [ -z "$1" ]; then
    echo "Error: Zone required"
    echo ""
    show_help
    exit 1
fi

ZONE="$1"
DAEMON="$2"

# Check if hosts.json exists
if [ ! -f "$HOSTS_CONFIG" ]; then
    echo "Error: config/hosts.json not found"
    echo "Copy config/hosts.example.json to config/hosts.json and customize"
    exit 1
fi

# Extract zone config from hosts.json using Python
CONFIG=$(python3 -c "
import json
import sys
with open('$HOSTS_CONFIG') as f:
    config = json.load(f)
hosts = config.get('hosts', {})
zone = hosts.get('$ZONE')
if not zone:
    print('ERROR: Zone not found', file=sys.stderr)
    sys.exit(1)
models_dir = zone.get('models_dir', '~/models')
# Expand ~ if present
import os
models_dir = os.path.expanduser(models_dir)
print(f'--zone $ZONE --port 8768 --base-dir {models_dir}')
" 2>&1)

if echo "$CONFIG" | grep -q "ERROR:"; then
    echo "Error: Zone '$ZONE' not found in config/hosts.json"
    echo "Available zones:"
    python3 -c "
import json
with open('$HOSTS_CONFIG') as f:
    config = json.load(f)
for zone_id in config.get('hosts', {}).keys():
    print(f'  {zone_id}')
"
    exit 1
fi

if [ "$DAEMON" == "--daemon" ]; then
    LOG_DIR="$BASE_DIR/logs"
    mkdir -p "$LOG_DIR"
    echo "Starting Branch Officer '$ZONE' in background..."
    nohup python3 "$SCRIPT" $CONFIG > "$LOG_DIR/branch_officer_$ZONE.log" 2>&1 &
    PID=$!
    echo "Started with PID $PID"
    echo "Log: $LOG_DIR/branch_officer_$ZONE.log"
else
    echo "Starting Branch Officer '$ZONE'..."
    exec python3 "$SCRIPT" $CONFIG
fi
