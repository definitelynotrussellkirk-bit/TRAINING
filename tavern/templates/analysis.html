<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Archaeology - Realm of Training</title>
    <!-- Shared theme -->
    <link rel="stylesheet" href="/static/css/theme.css?v=1">
    <link rel="stylesheet" href="/static/css/game.css?v=3">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MODEL ARCHAEOLOGY - Layer Drift Analysis
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           ARCHAEOLOGY BANNER
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .archaeology-banner {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            border: 1px solid var(--border-color);
            border-bottom: 3px solid #8b5cf6;
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.25rem;
            position: relative;
            overflow: hidden;
        }

        .archaeology-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at 20% 50%, rgba(139, 92, 246, 0.2) 0%, transparent 60%);
            pointer-events: none;
        }

        .banner-icon-frame {
            position: relative;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
            flex-shrink: 0;
        }

        .banner-icon-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 3px solid #8b5cf6;
            border-radius: 50%;
            animation: archGlow 3s ease-in-out infinite;
        }

        @keyframes archGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(139, 92, 246, 0.3); }
            50% { box-shadow: 0 0 25px rgba(139, 92, 246, 0.6); }
        }

        .banner-icon {
            font-size: 2.5rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }

        .banner-info {
            flex: 1;
            z-index: 1;
            min-width: 0;
        }

        .banner-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            color: var(--color-gold);
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .banner-subtitle {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .banner-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            z-index: 1;
            flex-shrink: 0;
        }

        .control-select {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            min-width: 140px;
        }

        .control-select:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        .banner-btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: rgba(255,255,255,0.05);
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .banner-btn:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: #8b5cf6;
            color: #a78bfa;
        }

        .banner-btn.primary {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border-color: #8b5cf6;
            color: #fff;
            font-weight: 600;
        }

        .banner-btn.primary:hover {
            filter: brightness(1.1);
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           MAIN LAYOUT
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .analysis-main {
            padding: 1.5rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           SUMMARY CARDS
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .summary-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #8b5cf6, #a78bfa);
        }

        .summary-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--color-gold);
            font-family: 'Courier New', monospace;
        }

        .summary-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 0.25rem;
            letter-spacing: 0.5px;
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           MAIN GRID
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 1.5rem;
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           SECTION CARDS
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .section-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, transparent 100%);
            border-bottom: 1px solid var(--border-color);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-family: var(--font-display);
            font-size: 1.1rem;
            color: var(--color-gold);
            margin: 0;
        }

        .section-icon {
            font-size: 1.2rem;
        }

        .section-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .section-body {
            padding: 1.25rem;
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           HEATMAP
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .heatmap-container {
            position: relative;
            overflow-x: auto;
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 0.5rem;
        }

        #driftHeatmap {
            min-height: 400px;
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 1rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .legend-gradient {
            width: 150px;
            height: 12px;
            background: linear-gradient(90deg, #1e3a5f, #3b82f6, #22c55e, #f59e0b, #ef4444);
            border-radius: 6px;
        }

        /* Layer Detail Panel */
        .layer-detail {
            margin-top: 1.25rem;
            padding: 1rem;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            display: none;
        }

        .layer-detail.active {
            display: block;
        }

        .layer-detail-header {
            font-family: monospace;
            font-size: 0.9rem;
            color: #a78bfa;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(139, 92, 246, 0.3);
        }

        .layer-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }

        .layer-stat {
            padding: 0.5rem;
            background: var(--bg-dark);
            border-radius: 6px;
            text-align: center;
        }

        .layer-stat-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .layer-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           SIDEBAR - MOVERS & CHECKPOINTS
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .sidebar-stack {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .movers-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .mover-list {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .mover-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-surface);
            border-radius: 6px;
            border-left: 3px solid transparent;
        }

        .mover-item.hot {
            border-left-color: #ef4444;
        }

        .mover-item.cold {
            border-left-color: #22c55e;
        }

        .mover-rank {
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-dark);
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .mover-item.hot .mover-rank {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .mover-item.cold .mover-rank {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .mover-name {
            flex: 1;
            font-size: 0.8rem;
            font-family: monospace;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .mover-bar-container {
            width: 60px;
            height: 6px;
            background: var(--bg-dark);
            border-radius: 3px;
            overflow: hidden;
        }

        .mover-bar {
            height: 100%;
            border-radius: 3px;
        }

        .mover-bar.hot {
            background: linear-gradient(90deg, #f59e0b, #ef4444);
        }

        .mover-bar.cold {
            background: linear-gradient(90deg, #22c55e, #3b82f6);
        }

        .mover-value {
            font-size: 0.7rem;
            color: var(--text-muted);
            width: 45px;
            text-align: right;
            font-family: monospace;
        }

        /* Checkpoints Section */
        .checkpoint-list {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 250px;
            overflow-y: auto;
        }

        .checkpoint-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-surface);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .checkpoint-item:hover {
            border-left-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }

        .checkpoint-item.selected {
            border-left-color: var(--color-gold);
            background: rgba(245, 158, 11, 0.1);
        }

        .checkpoint-step {
            font-weight: 600;
            color: var(--color-gold);
            font-size: 0.9rem;
            min-width: 60px;
        }

        .checkpoint-meta {
            flex: 1;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .checkpoint-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .checkpoint-badge.drift {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .checkpoint-badge.clean {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           EMPTY STATE
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .empty-state code {
            display: block;
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--bg-dark);
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.85rem;
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           LOADING
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--text-muted);
            gap: 0.75rem;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           MODAL
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem;
            background: rgba(139, 92, 246, 0.1);
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-family: var(--font-display);
            color: var(--color-gold);
            font-size: 1.2rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: 50vh;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        .form-hint {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 6px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            background: rgba(0,0,0,0.2);
            border-top: 1px solid var(--border-color);
        }

        .modal-btn {
            padding: 0.6rem 1.25rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .modal-btn-cancel {
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .modal-btn-cancel:hover {
            border-color: var(--text-muted);
        }

        .modal-btn-submit {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border: none;
            color: #fff;
            font-weight: 600;
        }

        .modal-btn-submit:hover {
            filter: brightness(1.1);
        }

        .modal-btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           RESPONSIVE
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 1200px) {
            .analysis-grid {
                grid-template-columns: 1fr;
            }
            .sidebar-stack {
                display: grid;
                grid-template-columns: 1fr 1fr;
            }
            .layer-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .summary-row {
                grid-template-columns: 1fr 1fr;
            }
            .sidebar-stack {
                grid-template-columns: 1fr;
            }
            .banner-controls {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- TITLE BAR -->
    <header class="game-header">
        <div class="header-left">
            <h1 class="game-title">Archaeology</h1>
        </div>
        <div class="header-center">
            <div class="resource-bar">
                <div class="resource">
                    <span class="resource-icon">ğŸ”¬</span>
                    <span class="resource-label">SCHOOL</span>
                    <span class="resource-value">Archaeology</span>
                </div>
                <div class="resource">
                    <span class="resource-icon">ğŸ“Š</span>
                    <span class="resource-label">ANALYZED</span>
                    <span class="resource-value" id="headerAnalyzed">0</span>
                </div>
            </div>
        </div>
        <div class="header-right">
            <div class="time-display" id="timeDisplay">--:--:--</div>
        </div>
    </header>

    <!-- ARCHAEOLOGY BANNER -->
    <div class="archaeology-banner">
        <div class="banner-icon-frame">
            <div class="banner-icon-ring"></div>
            <span class="banner-icon">ğŸ”¬</span>
        </div>
        <div class="banner-info">
            <h2 class="banner-title">Model Archaeology</h2>
            <p class="banner-subtitle">Layer drift analysis and weight evolution tracking</p>
        </div>
        <div class="banner-controls">
            <select class="control-select" id="heroSelect">
                <option value="">Loading heroes...</option>
            </select>
            <select class="control-select" id="campaignSelect">
                <option value="">Loading campaigns...</option>
            </select>
            <button class="banner-btn" onclick="loadData()">Refresh</button>
            <button class="banner-btn primary" onclick="showRunAnalysisModal()">
                + Run Analysis
            </button>
        </div>
    </div>

    <!-- MAIN -->
    <main class="analysis-main">
        <!-- Summary Cards -->
        <div class="summary-row">
            <div class="summary-card">
                <div class="summary-value" id="statCheckpoints">--</div>
                <div class="summary-label">Checkpoints Analyzed</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="statLayers">--</div>
                <div class="summary-label">Layers Tracked</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="statMostChanged">--</div>
                <div class="summary-label">Most Active Layer</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="statAvgDrift">--</div>
                <div class="summary-label">Avg Drift (L2)</div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="analysis-grid">
            <!-- Heatmap -->
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">ğŸ—ºï¸</span>
                        Layer Drift Heatmap
                    </h3>
                    <span class="section-hint">Hover for details | Click to select layer</span>
                </div>
                <div class="section-body">
                    <div class="heatmap-container">
                        <canvas id="driftHeatmap"></canvas>
                    </div>
                    <div class="heatmap-legend">
                        <span>Low drift</span>
                        <div class="legend-gradient"></div>
                        <span>High drift</span>
                    </div>

                    <!-- Layer Detail Panel -->
                    <div class="layer-detail" id="layerDetail">
                        <div class="layer-detail-header" id="layerDetailName">--</div>
                        <div class="layer-stats-grid">
                            <div class="layer-stat">
                                <div class="layer-stat-value" id="layerTotalDrift">--</div>
                                <div class="layer-stat-label">Total Drift (L2)</div>
                            </div>
                            <div class="layer-stat">
                                <div class="layer-stat-value" id="layerAvgCosine">--</div>
                                <div class="layer-stat-label">Avg Cosine Sim</div>
                            </div>
                            <div class="layer-stat">
                                <div class="layer-stat-value" id="layerMaxDrift">--</div>
                                <div class="layer-stat-label">Max Step Drift</div>
                            </div>
                            <div class="layer-stat">
                                <div class="layer-stat-value" id="layerCheckpoints">--</div>
                                <div class="layer-stat-label">Checkpoints</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar-stack">
                <!-- Top Movers -->
                <div class="movers-card">
                    <div class="section-header">
                        <h3 class="section-title">
                            <span class="section-icon">ğŸ”¥</span>
                            Most Changed
                        </h3>
                    </div>
                    <div class="mover-list" id="topMoversList">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            Loading...
                        </div>
                    </div>
                </div>

                <!-- Most Stable -->
                <div class="movers-card">
                    <div class="section-header">
                        <h3 class="section-title">
                            <span class="section-icon">ğŸ§Š</span>
                            Most Stable
                        </h3>
                    </div>
                    <div class="mover-list" id="stableMoversList">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            Loading...
                        </div>
                    </div>
                </div>

                <!-- Analyzed Checkpoints -->
                <div class="movers-card">
                    <div class="section-header">
                        <h3 class="section-title">
                            <span class="section-icon">ğŸ“¦</span>
                            Analyzed Checkpoints
                        </h3>
                    </div>
                    <div class="checkpoint-list" id="checkpointList">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            Loading...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="game-nav" id="bottomNav"></nav>
    <script src="/static/js/nav.js"></script>

    <!-- Run Analysis Modal -->
    <div class="modal-overlay" id="analysisModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <span>ğŸ”¬</span>
                    Run Layer Analysis
                </h3>
                <button class="modal-close" onclick="hideRunAnalysisModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="analysisCheckpoint">Checkpoint to Analyze</label>
                    <select id="analysisCheckpoint">
                        <option value="">Loading checkpoints...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="analysisReference">Reference Checkpoint (for drift comparison)</label>
                    <select id="analysisReference">
                        <option value="">None - Weight stats only</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="analysisActivations" checked style="width: auto;">
                        Compute activation statistics (slower but more detailed)
                    </label>
                </div>
                <div class="form-hint">
                    Analysis will be queued as a job. GPU required for activation stats.
                    Results will appear when the job completes.
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="hideRunAnalysisModal()">Cancel</button>
                <button class="modal-btn modal-btn-submit" id="submitAnalysisBtn" onclick="submitAnalysis()">
                    Submit Job
                </button>
            </div>
        </div>
    </div>

    <script>
        // State
        let campaignId = null;
        let heroId = null;
        let timelineData = null;
        let moversData = null;
        let checkpointData = null;

        // Time display
        function updateTime() {
            const now = new Date();
            document.getElementById('timeDisplay').textContent = now.toLocaleTimeString();
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Load campaigns for dropdown
        async function loadCampaigns() {
            try {
                const resp = await fetch('/api/campaigns');
                const data = await resp.json();
                const campaignSelect = document.getElementById('campaignSelect');
                const heroSelect = document.getElementById('heroSelect');

                // Set from active campaign
                if (data.active) {
                    campaignId = data.active.id;
                    heroId = data.active.hero_id;
                }

                // Build hero list from campaign data
                const heroes = Object.keys(data.campaigns || {});
                heroSelect.innerHTML = heroes.map(h => `
                    <option value="${h}" ${h === heroId ? 'selected' : ''}>
                        ${h.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}
                    </option>
                `).join('');

                if (heroes.length === 0) {
                    heroSelect.innerHTML = '<option value="">No heroes</option>';
                }

                // Build campaign list
                const campaigns = [];
                for (const [hId, heroCampaigns] of Object.entries(data.campaigns || {})) {
                    for (const c of heroCampaigns) {
                        if (c.status !== 'archived') {
                            campaigns.push({ ...c, hero_id: hId });
                        }
                    }
                }

                campaignSelect.innerHTML = campaigns.map(c => `
                    <option value="${c.id}" data-hero="${c.hero_id}" ${c.id === campaignId ? 'selected' : ''}>
                        ${c.name}
                    </option>
                `).join('');

                if (campaigns.length === 0) {
                    campaignSelect.innerHTML = '<option value="">No campaigns</option>';
                }

                // Sync hero dropdown when campaign changes
                campaignSelect.addEventListener('change', () => {
                    const selectedOption = campaignSelect.selectedOptions[0];
                    if (selectedOption && selectedOption.dataset.hero) {
                        heroSelect.value = selectedOption.dataset.hero;
                    }
                });

            } catch (err) {
                console.error('Failed to load campaigns:', err);
            }
        }

        // Load all analysis data
        async function loadData() {
            campaignId = document.getElementById('campaignSelect').value || campaignId;
            heroId = document.getElementById('heroSelect').value || heroId;

            if (!campaignId || !heroId) {
                console.warn('No campaign or hero selected');
                return;
            }

            await Promise.all([
                loadTimeline(),
                loadMovers(),
                loadCheckpoints()
            ]);
        }

        // Load drift timeline for heatmap
        async function loadTimeline() {
            try {
                const resp = await fetch(
                    `/api/analysis/${campaignId}/drift_timeline?hero_id=${heroId}&max_layers=30`
                );

                if (!resp.ok) {
                    if (resp.status === 404) {
                        showEmptyState();
                        return;
                    }
                    throw new Error(`HTTP ${resp.status}`);
                }

                timelineData = await resp.json();
                renderHeatmap();
                updateSummaryStats();

            } catch (err) {
                console.error('Failed to load timeline:', err);
                showEmptyState();
            }
        }

        // Load top movers
        async function loadMovers() {
            try {
                const resp = await fetch(
                    `/api/analysis/${campaignId}/top_movers?hero_id=${heroId}&n=8`
                );

                if (!resp.ok) return;

                moversData = await resp.json();
                renderMovers();

            } catch (err) {
                console.error('Failed to load movers:', err);
            }
        }

        // Load checkpoint list
        async function loadCheckpoints() {
            try {
                const resp = await fetch(
                    `/api/analysis/${campaignId}/layer_stats?hero_id=${heroId}`
                );

                if (!resp.ok) return;

                checkpointData = await resp.json();
                renderCheckpoints();

            } catch (err) {
                console.error('Failed to load checkpoints:', err);
            }
        }

        // Render heatmap using canvas
        function renderHeatmap() {
            const canvas = document.getElementById('driftHeatmap');
            const ctx = canvas.getContext('2d');

            if (!timelineData || !timelineData.checkpoints.length) {
                showEmptyState();
                return;
            }

            const layers = Object.keys(timelineData.layers);
            const checkpoints = timelineData.checkpoints;

            // Canvas sizing
            const cellWidth = 40;
            const cellHeight = 16;
            const labelWidth = 180;
            const topMargin = 60;

            canvas.width = labelWidth + (checkpoints.length * cellWidth) + 20;
            canvas.height = topMargin + (layers.length * cellHeight) + 20;

            // Clear
            ctx.fillStyle = getComputedStyle(document.documentElement)
                .getPropertyValue('--bg-dark').trim() || '#0a0c10';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Find max drift for normalization
            let maxDrift = 0;
            for (const layer of Object.values(timelineData.layers)) {
                for (const d of layer.drift_l2) {
                    if (d > maxDrift) maxDrift = d;
                }
            }

            // Draw checkpoint labels (rotated)
            ctx.save();
            ctx.font = '10px monospace';
            ctx.fillStyle = '#6b7280';
            for (let i = 0; i < checkpoints.length; i++) {
                const x = labelWidth + (i * cellWidth) + cellWidth / 2;
                ctx.save();
                ctx.translate(x, topMargin - 5);
                ctx.rotate(-Math.PI / 4);
                ctx.textAlign = 'left';
                ctx.fillText(`${checkpoints[i]}`, 0, 0);
                ctx.restore();
            }
            ctx.restore();

            // Draw layer labels and cells
            ctx.font = '11px monospace';
            let rowIndex = 0;

            for (const [layerName, layerData] of Object.entries(timelineData.layers)) {
                const y = topMargin + (rowIndex * cellHeight);

                // Layer name (truncated)
                ctx.fillStyle = '#9ca3af';
                ctx.textAlign = 'right';
                const displayName = layerName.length > 25
                    ? '...' + layerName.slice(-22)
                    : layerName;
                ctx.fillText(displayName, labelWidth - 10, y + 12);

                // Drift cells
                for (let i = 0; i < layerData.drift_l2.length; i++) {
                    const drift = layerData.drift_l2[i];
                    const norm = maxDrift > 0 ? drift / maxDrift : 0;
                    const color = getHeatmapColor(norm);

                    const x = labelWidth + (i * cellWidth);

                    ctx.fillStyle = color;
                    ctx.fillRect(x + 1, y + 1, cellWidth - 2, cellHeight - 2);
                }

                rowIndex++;
            }

            // Add tooltip handling
            canvas.onmousemove = (e) => handleHeatmapHover(e, checkpoints, layers);
            canvas.onclick = (e) => handleHeatmapClick(e, checkpoints, layers);
        }

        function getHeatmapColor(value) {
            const colors = [
                [30, 58, 95],
                [59, 130, 246],
                [34, 197, 94],
                [245, 158, 11],
                [239, 68, 68]
            ];

            const idx = Math.min(Math.floor(value * (colors.length - 1)), colors.length - 2);
            const t = (value * (colors.length - 1)) - idx;

            const r = Math.round(colors[idx][0] + t * (colors[idx + 1][0] - colors[idx][0]));
            const g = Math.round(colors[idx][1] + t * (colors[idx + 1][1] - colors[idx][1]));
            const b = Math.round(colors[idx][2] + t * (colors[idx + 1][2] - colors[idx][2]));

            return `rgb(${r}, ${g}, ${b})`;
        }

        function handleHeatmapHover(e, checkpoints, layers) {
            const canvas = e.target;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const labelWidth = 180;
            const topMargin = 60;
            const cellWidth = 40;
            const cellHeight = 16;

            const col = Math.floor((x - labelWidth) / cellWidth);
            const row = Math.floor((y - topMargin) / cellHeight);

            if (col >= 0 && col < checkpoints.length && row >= 0 && row < layers.length) {
                const layerName = layers[row];
                const step = checkpoints[col];
                const layer = timelineData.layers[layerName];
                const drift = layer?.drift_l2[col] || 0;

                canvas.title = `${layerName}\nStep ${step}\nDrift: ${drift.toFixed(4)}`;
            } else {
                canvas.title = '';
            }
        }

        function handleHeatmapClick(e, checkpoints, layers) {
            const canvas = e.target;
            const rect = canvas.getBoundingClientRect();
            const y = e.clientY - rect.top;

            const topMargin = 60;
            const cellHeight = 16;

            const row = Math.floor((y - topMargin) / cellHeight);

            if (row >= 0 && row < layers.length) {
                showLayerDetail(layers[row]);
            }
        }

        function showLayerDetail(layerName) {
            const detail = document.getElementById('layerDetail');
            detail.classList.add('active');

            document.getElementById('layerDetailName').textContent = layerName;

            const layer = timelineData.layers[layerName];
            if (!layer) return;

            const driftL2 = layer.drift_l2;
            const total = driftL2.reduce((a, b) => a + b, 0);
            const max = Math.max(...driftL2);
            const avgCosine = layer.drift_cosine.reduce((a, b) => a + b, 0) / layer.drift_cosine.length;

            document.getElementById('layerTotalDrift').textContent = total.toFixed(4);
            document.getElementById('layerAvgCosine').textContent = avgCosine.toFixed(4);
            document.getElementById('layerMaxDrift').textContent = max.toFixed(4);
            document.getElementById('layerCheckpoints').textContent = driftL2.length;
        }

        function renderMovers() {
            if (!moversData) return;

            // Top movers
            const topList = document.getElementById('topMoversList');
            const maxDrift = moversData.top_movers[0]?.total_drift || 1;

            topList.innerHTML = moversData.top_movers.map((m, i) => `
                <div class="mover-item hot">
                    <div class="mover-rank">${i + 1}</div>
                    <div class="mover-name" title="${m.layer}">${formatLayerName(m.layer)}</div>
                    <div class="mover-bar-container">
                        <div class="mover-bar hot" style="width: ${(m.total_drift / maxDrift * 100)}%"></div>
                    </div>
                    <div class="mover-value">${m.total_drift.toFixed(2)}</div>
                </div>
            `).join('') || '<div style="color: var(--text-muted); text-align: center; padding: 1rem;">No data</div>';

            // Stable layers
            const stableList = document.getElementById('stableMoversList');

            stableList.innerHTML = moversData.most_stable.map((m, i) => `
                <div class="mover-item cold">
                    <div class="mover-rank">${i + 1}</div>
                    <div class="mover-name" title="${m.layer}">${formatLayerName(m.layer)}</div>
                    <div class="mover-bar-container">
                        <div class="mover-bar cold" style="width: ${Math.min(m.total_drift / (maxDrift * 0.1) * 100, 100)}%"></div>
                    </div>
                    <div class="mover-value">${m.total_drift.toFixed(4)}</div>
                </div>
            `).join('') || '<div style="color: var(--text-muted); text-align: center; padding: 1rem;">No data</div>';
        }

        function formatLayerName(name) {
            return name
                .replace('model.layers.', 'L')
                .replace('.self_attn.', '.attn.')
                .replace('.mlp.', '.')
                .replace('_proj', '');
        }

        function renderCheckpoints() {
            const list = document.getElementById('checkpointList');

            if (!checkpointData || !checkpointData.stats.length) {
                list.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 1rem;">No checkpoints analyzed yet</div>';
                return;
            }

            // Sort by step descending
            const sorted = [...checkpointData.stats].sort((a, b) => b.checkpoint_step - a.checkpoint_step);

            // Update header count
            document.getElementById('headerAnalyzed').textContent = sorted.length;

            list.innerHTML = sorted.map(c => `
                <div class="checkpoint-item" onclick="loadCheckpointDetail(${c.checkpoint_step})">
                    <div class="checkpoint-step">${c.checkpoint_step.toLocaleString()}</div>
                    <div class="checkpoint-meta">
                        ${c.num_layers} layers
                        ${c.compute_duration_sec ? ` | ${c.compute_duration_sec.toFixed(1)}s` : ''}
                    </div>
                    <div class="checkpoint-badge ${c.has_drift ? 'drift' : 'clean'}">
                        ${c.has_drift ? 'DRIFT' : 'CLEAN'}
                    </div>
                </div>
            `).join('');
        }

        async function loadCheckpointDetail(step) {
            try {
                const resp = await fetch(
                    `/api/analysis/${campaignId}/layer_stats/${step}?hero_id=${heroId}`
                );

                if (!resp.ok) return;

                const data = await resp.json();
                console.log('Checkpoint detail:', data);

                alert(`Checkpoint ${step}\n\n` +
                    `Layers: ${Object.keys(data.weight_stats || {}).length}\n` +
                    `Has drift: ${!!data.drift_stats}\n` +
                    `Most changed: ${data.global_drift_stats?.most_changed_layer || 'N/A'}`);

            } catch (err) {
                console.error('Failed to load checkpoint detail:', err);
            }
        }

        function updateSummaryStats() {
            if (!timelineData) return;

            const layers = Object.keys(timelineData.layers);
            const checkpoints = timelineData.checkpoints;

            document.getElementById('statCheckpoints').textContent = checkpoints.length;
            document.getElementById('statLayers').textContent = layers.length;

            // Calculate most changed layer
            let maxTotalDrift = 0;
            let mostChangedLayer = '--';

            for (const [name, layer] of Object.entries(timelineData.layers)) {
                const total = layer.drift_l2.reduce((a, b) => a + b, 0);
                if (total > maxTotalDrift) {
                    maxTotalDrift = total;
                    mostChangedLayer = formatLayerName(name);
                }
            }

            document.getElementById('statMostChanged').textContent = mostChangedLayer;

            // Calculate average drift
            let totalDrift = 0;
            let driftCount = 0;
            for (const layer of Object.values(timelineData.layers)) {
                for (const d of layer.drift_l2) {
                    totalDrift += d;
                    driftCount++;
                }
            }
            const avgDrift = driftCount > 0 ? totalDrift / driftCount : 0;
            document.getElementById('statAvgDrift').textContent = avgDrift.toFixed(4);
        }

        function showEmptyState() {
            const container = document.querySelector('.heatmap-container');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ”¬</div>
                    <h3>No Analysis Data Yet</h3>
                    <p>Click "+ Run Analysis" to analyze a checkpoint, or run manually:</p>
                    <code>python3 scripts/run_layer_stats.py local --checkpoint checkpoint-183000</code>
                </div>
            `;
        }

        // ===============================
        // Run Analysis Modal Functions
        // ===============================

        let availableCheckpoints = [];

        async function showRunAnalysisModal() {
            document.getElementById('analysisModal').classList.add('active');
            await loadAvailableCheckpoints();
        }

        function hideRunAnalysisModal() {
            document.getElementById('analysisModal').classList.remove('active');
        }

        async function loadAvailableCheckpoints() {
            const checkpointSelect = document.getElementById('analysisCheckpoint');
            const referenceSelect = document.getElementById('analysisReference');

            try {
                const params = new URLSearchParams();
                if (heroId) params.set('hero_id', heroId);
                if (campaignId) params.set('campaign_id', campaignId);
                params.set('limit', '30');

                const resp = await fetch(`/api/analysis/checkpoints?${params}`);
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

                const data = await resp.json();
                availableCheckpoints = data.checkpoints || [];

                checkpointSelect.innerHTML = availableCheckpoints.map(c => {
                    const lossStr = c.train_loss ? ` (loss: ${c.train_loss.toFixed(4)})` : '';
                    const analyzedStr = c.has_analysis ? ' âœ“' : '';
                    return `<option value="${c.step}">Step ${c.step.toLocaleString()}${lossStr}${analyzedStr}</option>`;
                }).join('');

                if (availableCheckpoints.length === 0) {
                    checkpointSelect.innerHTML = '<option value="">No checkpoints available</option>';
                }

                referenceSelect.innerHTML = '<option value="">None - Weight stats only</option>' +
                    availableCheckpoints.map(c => {
                        const lossStr = c.train_loss ? ` (loss: ${c.train_loss.toFixed(4)})` : '';
                        return `<option value="${c.step}">Step ${c.step.toLocaleString()}${lossStr}</option>`;
                    }).join('');

            } catch (err) {
                console.error('Failed to load checkpoints:', err);
                checkpointSelect.innerHTML = '<option value="">Error loading checkpoints</option>';
            }
        }

        async function submitAnalysis() {
            const checkpointStep = document.getElementById('analysisCheckpoint').value;
            const referenceStep = document.getElementById('analysisReference').value;
            const computeActivations = document.getElementById('analysisActivations').checked;
            const submitBtn = document.getElementById('submitAnalysisBtn');

            if (!checkpointStep) {
                alert('Please select a checkpoint to analyze');
                return;
            }

            if (!campaignId || !heroId) {
                alert('Please select a campaign and hero first');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                const payload = {
                    checkpoint_step: parseInt(checkpointStep),
                    campaign_id: campaignId,
                    hero_id: heroId,
                    compute_activations: computeActivations,
                };

                if (referenceStep) {
                    payload.reference_step = parseInt(referenceStep);
                }

                const resp = await fetch('/api/analysis/trigger', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                const result = await resp.json();

                if (result.success) {
                    alert(`Analysis job submitted!\n\nJob ID: ${result.job_id}\nQueue position: ${result.queue_position || 'unknown'}\n\nResults will appear when the job completes.`);
                    hideRunAnalysisModal();
                } else {
                    alert(`Failed to submit job: ${result.error || 'Unknown error'}`);
                }

            } catch (err) {
                console.error('Failed to submit analysis:', err);
                alert(`Error: ${err.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Job';
            }
        }

        // Close modal on backdrop click
        document.getElementById('analysisModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                hideRunAnalysisModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideRunAnalysisModal();
            }
        });

        // Campaign/hero select change handlers
        document.getElementById('campaignSelect').addEventListener('change', loadData);
        document.getElementById('heroSelect').addEventListener('change', loadData);

        // Initial load
        loadCampaigns().then(() => loadData());
    </script>
</body>
</html>
