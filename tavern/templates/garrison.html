<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garrison | Realm of Training</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        body {
            background: #1a1a2e;
            color: #e0e0e0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #333;
        }

        h1 {
            margin: 0;
            color: #ffd700;
            font-size: 1.8rem;
        }

        .nav-links a {
            color: #888;
            text-decoration: none;
            margin-left: 16px;
            transition: color 0.2s;
        }

        .nav-links a:hover {
            color: #ffd700;
        }

        /* Status banner */
        .status-banner {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 16px 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            font-size: 1.1rem;
        }

        .status-healthy {
            background: linear-gradient(135deg, #1a3a1a 0%, #0d2a0d 100%);
            border: 2px solid #4CAF50;
        }
        .status-warning {
            background: linear-gradient(135deg, #3a3a1a 0%, #2a2a0d 100%);
            border: 2px solid #ffa726;
        }
        .status-critical {
            background: linear-gradient(135deg, #3a1a1a 0%, #2a0d0d 100%);
            border: 2px solid #f44336;
        }
        .status-unknown {
            background: #252538;
            border: 2px solid #666;
        }

        .status-icon {
            font-size: 2rem;
        }

        /* Host grid */
        .hosts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .host-card {
            background: #252538;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #333;
        }

        .host-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #333;
        }

        .host-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: #fff;
        }

        .host-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .host-status.healthy { background: #1b5e20; color: #a5d6a7; }
        .host-status.warning { background: #e65100; color: #ffcc80; }
        .host-status.critical { background: #b71c1c; color: #ef9a9a; }
        .host-status.unknown { background: #424242; color: #bdbdbd; }

        .host-ip {
            color: #888;
            font-size: 0.9rem;
            margin-top: 4px;
        }

        /* Metrics grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .metric-box {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 12px;
        }

        .metric-label {
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 1.4rem;
            font-weight: 600;
            color: #fff;
        }

        .metric-value.warning { color: #ffa726; }
        .metric-value.critical { color: #f44336; }
        .metric-value.good { color: #4CAF50; }

        .metric-detail {
            font-size: 0.8rem;
            color: #666;
            margin-top: 2px;
        }

        /* Progress bars */
        .progress-bar {
            height: 6px;
            background: #333;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .progress-fill.good { background: #4CAF50; }
        .progress-fill.warning { background: #ffa726; }
        .progress-fill.critical { background: #f44336; }

        /* Services list */
        .services-section {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid #333;
        }

        .services-title {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 8px;
        }

        .services-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .service-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .service-badge.up { background: #1b5e20; color: #a5d6a7; }
        .service-badge.down { background: #b71c1c; color: #ef9a9a; }
        .service-badge.error { background: #e65100; color: #ffcc80; }

        /* Issues list */
        .issues-section {
            margin-top: 12px;
        }

        .issue-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: #3a2a1a;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #ffcc80;
            margin-bottom: 6px;
        }

        /* Uptime */
        .uptime {
            font-size: 0.85rem;
            color: #666;
            margin-top: 8px;
        }

        /* Last updated */
        .last-updated {
            text-align: center;
            color: #666;
            font-size: 0.85rem;
            margin-top: 20px;
        }

        /* Action buttons */
        .actions {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-primary:hover {
            background: #1976D2;
        }

        .btn-secondary {
            background: #424242;
            color: #e0e0e0;
        }

        .btn-secondary:hover {
            background: #616161;
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #333;
            border-top-color: #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Garrison</h1>
            <nav class="nav-links">
                <a href="/">Tavern</a>
                <a href="/guild">Guild</a>
                <a href="/jobs">Jobs</a>
                <a href="/settings">Settings</a>
            </nav>
        </header>

        <div class="actions">
            <button class="btn btn-primary" onclick="refreshStatus()">Refresh</button>
            <button class="btn btn-secondary" onclick="runMaintenance()">Run Maintenance</button>
        </div>

        <div id="status-banner" class="status-banner status-unknown">
            <span class="status-icon">?</span>
            <span>Loading fleet status...</span>
        </div>

        <div id="hosts-container" class="hosts-grid">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading fleet health...</p>
            </div>
        </div>

        <div id="last-updated" class="last-updated"></div>
    </div>

    <script>
        let statusData = null;

        function getStatusClass(status) {
            return status || 'unknown';
        }

        function getProgressClass(percent) {
            if (percent >= 90) return 'critical';
            if (percent >= 80) return 'warning';
            return 'good';
        }

        function formatBytes(mb) {
            if (mb >= 1024) return (mb / 1024).toFixed(1) + ' GB';
            return mb.toFixed(0) + ' MB';
        }

        function renderHost(hostId, host) {
            const status = host.status || 'unknown';
            const name = host.services?.name || hostId;

            let html = `
                <div class="host-card">
                    <div class="host-header">
                        <div>
                            <div class="host-name">${name}</div>
                            <div class="host-ip">${host.host}</div>
                        </div>
                        <span class="host-status ${status}">${status.toUpperCase()}</span>
                    </div>

                    <div class="metrics-grid">
            `;

            // Disk
            if (host.disk_percent !== null) {
                const diskClass = getProgressClass(host.disk_percent);
                html += `
                    <div class="metric-box">
                        <div class="metric-label">Disk</div>
                        <div class="metric-value ${diskClass}">${host.disk_percent.toFixed(0)}%</div>
                        <div class="metric-detail">${host.disk_free_gb?.toFixed(0) || '?'}GB free / ${host.disk_total_gb?.toFixed(0) || '?'}GB</div>
                        <div class="progress-bar">
                            <div class="progress-fill ${diskClass}" style="width: ${host.disk_percent}%"></div>
                        </div>
                    </div>
                `;
            }

            // RAM
            if (host.ram_percent !== null) {
                const ramClass = getProgressClass(host.ram_percent);
                html += `
                    <div class="metric-box">
                        <div class="metric-label">RAM</div>
                        <div class="metric-value ${ramClass}">${host.ram_percent.toFixed(0)}%</div>
                        <div class="metric-detail">${host.ram_used_gb?.toFixed(0) || '?'}GB / ${host.ram_total_gb?.toFixed(0) || '?'}GB</div>
                        <div class="progress-bar">
                            <div class="progress-fill ${ramClass}" style="width: ${host.ram_percent}%"></div>
                        </div>
                    </div>
                `;
            }

            // GPU Memory
            if (host.gpu_memory_percent !== null) {
                const gpuClass = getProgressClass(host.gpu_memory_percent);
                html += `
                    <div class="metric-box">
                        <div class="metric-label">GPU Memory</div>
                        <div class="metric-value ${gpuClass}">${host.gpu_memory_percent.toFixed(0)}%</div>
                        <div class="metric-detail">${formatBytes(host.gpu_memory_used_mb || 0)} / ${formatBytes(host.gpu_memory_total_mb || 0)}</div>
                        <div class="progress-bar">
                            <div class="progress-fill ${gpuClass}" style="width: ${host.gpu_memory_percent}%"></div>
                        </div>
                    </div>
                `;
            }

            // GPU Temp
            if (host.gpu_temp_c !== null) {
                const tempClass = host.gpu_temp_c >= 80 ? 'critical' : host.gpu_temp_c >= 70 ? 'warning' : 'good';
                html += `
                    <div class="metric-box">
                        <div class="metric-label">GPU Temp</div>
                        <div class="metric-value ${tempClass}">${host.gpu_temp_c.toFixed(0)}°C</div>
                        <div class="metric-detail">${host.gpu_name || 'GPU'}</div>
                    </div>
                `;
            }

            // CPU Temp (if available)
            if (host.cpu_temp_c !== null) {
                const tempClass = host.cpu_temp_c >= 80 ? 'critical' : host.cpu_temp_c >= 70 ? 'warning' : 'good';
                html += `
                    <div class="metric-box">
                        <div class="metric-label">CPU Temp</div>
                        <div class="metric-value ${tempClass}">${host.cpu_temp_c.toFixed(0)}°C</div>
                    </div>
                `;
            }

            html += `</div>`; // Close metrics-grid

            // Services
            const services = host.services || {};
            const serviceKeys = Object.keys(services).filter(k => k !== 'name' && k !== 'checkpoints');
            if (serviceKeys.length > 0 || services.checkpoints !== undefined) {
                html += `
                    <div class="services-section">
                        <div class="services-title">Services</div>
                        <div class="services-list">
                `;

                for (const key of serviceKeys) {
                    const value = services[key];
                    const badgeClass = value === 'up' ? 'up' : value === 'down' ? 'down' : 'error';
                    html += `<span class="service-badge ${badgeClass}">${key}: ${value}</span>`;
                }

                if (services.checkpoints !== undefined) {
                    html += `<span class="service-badge up">checkpoints: ${services.checkpoints}</span>`;
                }

                html += `</div></div>`;
            }

            // Issues
            if (host.issues && host.issues.length > 0) {
                html += `<div class="issues-section">`;
                for (const issue of host.issues) {
                    html += `<div class="issue-item">⚠ ${issue}</div>`;
                }
                html += `</div>`;
            }

            // Uptime
            if (host.uptime) {
                html += `<div class="uptime">Uptime: ${host.uptime}</div>`;
            }

            html += `</div>`; // Close host-card
            return html;
        }

        function renderStatus(data) {
            statusData = data;

            // Update banner
            const banner = document.getElementById('status-banner');
            const status = data.overall_status || 'unknown';
            const icons = { healthy: '✓', warning: '⚠', critical: '✗', unknown: '?' };
            banner.className = `status-banner status-${status}`;
            banner.innerHTML = `
                <span class="status-icon">${icons[status] || '?'}</span>
                <span>Fleet Status: ${status.toUpperCase()}</span>
            `;

            // Render hosts
            const container = document.getElementById('hosts-container');
            let html = '';

            for (const [hostId, host] of Object.entries(data.hosts || {})) {
                html += renderHost(hostId, host);
            }

            container.innerHTML = html || '<p>No hosts found</p>';

            // Update timestamp
            const lastUpdated = document.getElementById('last-updated');
            lastUpdated.textContent = `Last updated: ${new Date(data.timestamp).toLocaleString()}`;
        }

        async function refreshStatus() {
            try {
                const container = document.getElementById('hosts-container');
                container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Refreshing...</p></div>';

                const response = await fetch('/api/garrison');
                const data = await response.json();
                renderStatus(data);
            } catch (error) {
                console.error('Failed to fetch status:', error);
                document.getElementById('hosts-container').innerHTML =
                    '<p style="color: #f44336;">Failed to load fleet status</p>';
            }
        }

        async function runMaintenance() {
            if (!confirm('Run maintenance tasks? This will clean up old checkpoints.')) {
                return;
            }

            try {
                const response = await fetch('/api/garrison/maintenance');
                const data = await response.json();

                if (data.success) {
                    const actions = data.actions.length > 0
                        ? data.actions.join('\n')
                        : 'No maintenance needed';
                    alert('Maintenance complete:\n\n' + actions);
                    refreshStatus();
                } else {
                    alert('Maintenance failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to run maintenance: ' + error.message);
            }
        }

        // Initial load
        refreshStatus();

        // Auto-refresh every 30 seconds
        setInterval(refreshStatus, 30000);
    </script>
</body>
</html>
