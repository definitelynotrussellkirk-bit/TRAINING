<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guild Hall | Realm of Training</title>
    <link rel="stylesheet" href="/static/css/theme.css?v=1">
    <link rel="stylesheet" href="/static/css/game.css?v=4">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* ═══════════════════════════════════════════════════════════
           HERO BANNER - Guild Master
           ═══════════════════════════════════════════════════════════ */
        .guild-banner {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            border-bottom: 3px solid var(--border-gold);
            padding: 20px 24px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 24px;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .guild-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at 30% 50%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .guild-icon-container {
            position: relative;
            z-index: 1;
        }

        .guild-icon {
            font-size: 3.5rem;
            filter: drop-shadow(0 0 15px rgba(139, 92, 246, 0.5));
        }

        .guild-info {
            z-index: 1;
        }

        .guild-title {
            font-family: 'Cinzel', serif;
            font-size: 1.6rem;
            font-weight: 600;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
            margin-bottom: 4px;
        }

        .guild-subtitle {
            color: #a78bfa;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .guild-stats {
            display: flex;
            gap: 24px;
        }

        .guild-stat {
            display: flex;
            flex-direction: column;
        }

        .guild-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
        }

        .guild-stat-value.gold { color: #ffd700; }
        .guild-stat-value.purple { color: #a78bfa; }
        .guild-stat-value.green { color: #4ade80; }

        .guild-stat-label {
            font-size: 0.7rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .guild-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1;
        }

        .guild-action {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            text-decoration: none;
        }

        .guild-action:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.5);
            transform: translateX(4px);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* ═══════════════════════════════════════════════════════════
           SUMMARY CARDS
           ═══════════════════════════════════════════════════════════ */
        .summary-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: linear-gradient(135deg, #252538 0%, #1a1a2e 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--border-gold), #a78bfa);
        }

        .summary-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #ffd700;
            line-height: 1.2;
        }

        .summary-label {
            color: #888;
            font-size: 0.85rem;
            margin-top: 4px;
        }

        /* ═══════════════════════════════════════════════════════════
           SECTION HEADERS
           ═══════════════════════════════════════════════════════════ */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            color: #ffd700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-badge {
            background: rgba(139, 92, 246, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            color: #a78bfa;
            font-family: 'Inter', sans-serif;
        }

        /* ═══════════════════════════════════════════════════════════
           HERO'S JOURNEY - Personal Best
           ═══════════════════════════════════════════════════════════ */
        .journey-section {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05) 0%, #1a1a2e 100%);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .journey-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #ffd700, #a78bfa);
        }

        .journey-summary {
            font-size: 1.1rem;
            color: #ffd700;
            margin-bottom: 16px;
            font-weight: 500;
        }

        .peaks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .peaks-column h4 {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .peak-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            list-style: none;
        }

        .peak-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .peak-item .skill-name {
            font-weight: 600;
            text-transform: uppercase;
        }

        .peak-item .skill-level {
            color: #ffd700;
            font-weight: 700;
        }

        .peak-item .metric-icon {
            font-size: 1rem;
        }

        .peak-item .metric-value {
            color: #4ade80;
            font-weight: 600;
        }

        /* ═══════════════════════════════════════════════════════════
           SKILLS GRID
           ═══════════════════════════════════════════════════════════ */
        .skills-section {
            margin-bottom: 32px;
        }

        .skills-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 20px;
        }

        .skill-card {
            background: linear-gradient(180deg, #252538 0%, #1a1a2e 100%);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 0;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            position: relative;
        }

        .skill-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            transition: all 0.3s;
        }

        .skill-card.sy::before { background: #8b5cf6; }
        .skill-card.bin::before { background: #10b981; }

        .skill-card:hover {
            border-color: var(--border-gold);
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
        }

        .skill-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .skill-identity {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .skill-icon {
            font-size: 2.2rem;
            width: 55px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
        }

        .skill-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .skill-description {
            color: #888;
            font-size: 0.85rem;
        }

        .skill-level-badge {
            text-align: right;
        }

        .skill-level {
            font-size: 2rem;
            font-weight: 700;
            color: #ffd700;
            line-height: 1;
        }

        .strain-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 6px;
        }

        .skill-body {
            padding: 20px;
        }

        .skill-progress {
            margin-bottom: 16px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.8rem;
        }

        .progress-label {
            color: #888;
        }

        .progress-value {
            font-weight: 600;
        }

        .progress-bar {
            height: 10px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-fill.sy {
            background: linear-gradient(90deg, #8b5cf6, #a78bfa);
        }

        .progress-fill.bin {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 100%);
        }

        /* Level Accuracy Blocks */
        .level-accuracy-row {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .level-accuracy-row .level-title {
            width: 100%;
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .level-block {
            width: 22px;
            height: 22px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
            color: rgba(0,0,0,0.8);
            cursor: default;
            transition: transform 0.15s;
        }

        .level-block:hover {
            transform: scale(1.3);
            z-index: 1;
        }

        .level-block.mastered { background: linear-gradient(135deg, #22c55e, #4ade80); }
        .level-block.training { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
        .level-block.struggling { background: linear-gradient(135deg, #ef4444, #f87171); }
        .level-block.unknown { background: #333; color: #666; }

        .skill-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat {
            text-align: center;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
            margin-top: 2px;
        }

        /* ═══════════════════════════════════════════════════════════
           PASSIVES SECTION
           ═══════════════════════════════════════════════════════════ */
        .passives-section {
            margin-bottom: 32px;
        }

        .passives-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .passive-card {
            background: linear-gradient(135deg, #252538 0%, #1a1a2e 100%);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 16px;
            transition: all 0.2s;
        }

        .passive-card:hover {
            border-color: #444;
            transform: translateY(-2px);
        }

        .passive-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .passive-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .passive-version {
            font-size: 0.65rem;
            color: #666;
            background: rgba(255, 255, 255, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .passive-accuracy {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 8px 0;
        }

        .passive-accuracy.good { color: #4ade80; }
        .passive-accuracy.ok { color: #fbbf24; }
        .passive-accuracy.bad { color: #f87171; }
        .passive-accuracy.none { color: #666; }

        .passive-meta {
            font-size: 0.75rem;
            color: #666;
        }

        /* ═══════════════════════════════════════════════════════════
           PRIMITIVES SECTION
           ═══════════════════════════════════════════════════════════ */
        .primitives-section {
            margin-bottom: 32px;
        }

        .primitives-tracks {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        .track-card {
            background: linear-gradient(180deg, #252538 0%, #1a1a2e 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .track-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .track-name {
            font-weight: 600;
            font-size: 1rem;
            text-transform: uppercase;
        }

        .track-count {
            font-size: 0.75rem;
            color: #888;
        }

        .primitive-list {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 300px;
            overflow-y: auto;
        }

        .primitive-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        .primitive-item:hover {
            background: rgba(0, 0, 0, 0.4);
        }

        .primitive-name {
            color: #ccc;
        }

        .primitive-accuracy {
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .primitive-accuracy.good { color: #4ade80; background: rgba(34, 197, 94, 0.15); }
        .primitive-accuracy.ok { color: #fbbf24; background: rgba(245, 158, 11, 0.15); }
        .primitive-accuracy.bad { color: #f87171; background: rgba(239, 68, 68, 0.15); }
        .primitive-accuracy.none { color: #666; }

        /* ═══════════════════════════════════════════════════════════
           TASK MASTER SECTION
           ═══════════════════════════════════════════════════════════ */
        .task-master-section {
            margin-bottom: 32px;
        }

        .task-master-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        .task-card {
            background: linear-gradient(135deg, #252538 0%, #1a1a2e 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .task-status {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .task-label {
            color: #888;
            font-size: 0.85rem;
        }

        .task-meta {
            font-size: 0.75rem;
            color: #666;
            margin-top: 8px;
        }

        .task-stats-row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
        }

        .task-stat {
            text-align: center;
        }

        .task-stat-value {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .task-stat-label {
            font-size: 0.65rem;
            color: #666;
            text-transform: uppercase;
        }

        /* ═══════════════════════════════════════════════════════════
           UTILITIES
           ═══════════════════════════════════════════════════════════ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
        }

        .section-description {
            color: #666;
            font-size: 0.85rem;
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            .guild-banner {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .guild-stats {
                justify-content: center;
            }

            .guild-actions {
                flex-direction: row;
                justify-content: center;
            }

            .skills-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="game-header">
        <div class="header-left">
            <h1 class="game-title">Guild Hall</h1>
        </div>
        <div class="header-center">
            <div class="resource-bar">
                <div class="resource steps">
                    <span class="resource-icon">&#9889;</span>
                    <span class="resource-label">STEPS</span>
                    <span class="resource-value" id="totalSteps">0</span>
                </div>
                <div class="resource evals">
                    <span class="resource-icon">&#127919;</span>
                    <span class="resource-label">EVALS</span>
                    <span class="resource-value" id="totalEvals">0</span>
                </div>
            </div>
        </div>
        <div class="header-right">
            <div class="realm-mode-toggle" id="realmModeToggle">
                <button class="mode-btn mode-training" id="btnTraining">TRAIN</button>
                <button class="mode-btn mode-idle" id="btnIdle">IDLE</button>
            </div>
            <div class="health-indicator" id="healthIndicator">
                <span class="health-icon" id="healthIcon">&#9898;</span>
            </div>
            <div class="idle-indicator" id="idleIndicator">
                <span class="idle-icon" id="modeIcon">&#128164;</span>
                <span class="idle-text" id="modeText">IDLE</span>
            </div>
            <div class="time-display" id="timeDisplay">--:--:--</div>
        </div>
    </header>

    <!-- GUILD BANNER -->
    <div class="guild-banner">
        <div class="guild-icon-container">
            <span class="guild-icon">&#127984;</span>
        </div>
        <div class="guild-info">
            <h2 class="guild-title">Guild Hall</h2>
            <div class="guild-subtitle">Skill Mastery & Progression</div>
            <div class="guild-stats" id="guildStats">
                <div class="guild-stat">
                    <span class="guild-stat-value gold" id="bannerTotalLevel">--</span>
                    <span class="guild-stat-label">Total Level</span>
                </div>
                <div class="guild-stat">
                    <span class="guild-stat-value purple" id="bannerSkillCount">--</span>
                    <span class="guild-stat-label">Skills</span>
                </div>
                <div class="guild-stat">
                    <span class="guild-stat-value green" id="bannerPassives">--</span>
                    <span class="guild-stat-label">Passives OK</span>
                </div>
            </div>
        </div>
        <div class="guild-actions">
            <a href="/primitives" class="guild-action">
                <span>&#128200;</span> Primitives Radar
            </a>
            <a href="/achievements" class="guild-action">
                <span>&#127942;</span> Achievements
            </a>
        </div>
    </div>

    <main class="container">
        <!-- Summary Cards -->
        <div class="summary-row" id="summary">
            <div class="summary-card">
                <div class="summary-value" id="totalLevel">--</div>
                <div class="summary-label">Total Level</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="activeSkills">--</div>
                <div class="summary-label">Active Skills</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="passivesHealthy">--</div>
                <div class="summary-label">Passives Healthy</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="lastEval">--</div>
                <div class="summary-label">Last Evaluation</div>
            </div>
        </div>

        <!-- Hero's Journey - Personal Best -->
        <div class="journey-section" id="campaignPeaks" style="display: none;">
            <div class="section-header">
                <div class="section-title">
                    <span>&#127942;</span> Hero's Journey - Personal Best
                </div>
            </div>
            <p class="journey-summary" id="journeySummary">Loading...</p>
            <div class="peaks-grid">
                <div class="peaks-column">
                    <h4>Peak Skill Levels</h4>
                    <ul class="peak-list" id="peakSkillList"></ul>
                </div>
                <div class="peaks-column">
                    <h4>Best Metrics</h4>
                    <ul class="peak-list" id="peakMetricList"></ul>
                </div>
            </div>
        </div>

        <!-- Active Skills -->
        <div class="skills-section">
            <div class="section-header">
                <div class="section-title">
                    <span>&#9876;</span> Active Skills
                    <span class="section-badge" id="skillsBadge">0 skills</span>
                </div>
            </div>
            <div class="skills-grid" id="skillsGrid">
                <div class="loading">Loading skills...</div>
            </div>
        </div>

        <!-- Passives -->
        <div class="passives-section">
            <div class="section-header">
                <div class="section-title">
                    <span>&#128737;</span> Passives (Transfer Learning)
                </div>
            </div>
            <p class="section-description">
                General abilities tested independently of active training. Detects catastrophic forgetting.
            </p>
            <div class="passives-grid" id="passivesGrid">
                <div class="loading">Loading passives...</div>
            </div>
        </div>

        <!-- Primitives -->
        <div class="primitives-section">
            <div class="section-header">
                <div class="section-title">
                    <span>&#129513;</span> Primitives (Per-Concept Accuracy)
                </div>
            </div>
            <p class="section-description">
                Fine-grained accuracy tracking for atomic concepts within each skill. Identifies specific weaknesses.
            </p>
            <div class="primitives-tracks" id="primitivesGrid">
                <div class="loading">Loading primitives...</div>
            </div>
        </div>

        <!-- Task Master -->
        <div class="task-master-section">
            <div class="section-header">
                <div class="section-title">
                    <span>&#129302;</span> Task Master (3090)
                </div>
            </div>
            <p class="section-description">
                Background tasks running on the inference GPU when idle.
            </p>
            <div class="task-master-grid">
                <div class="task-card">
                    <div class="task-status" id="gpuStatus">--</div>
                    <div class="task-label">3090 Status</div>
                    <div class="task-meta"><span id="gpuMemory">--</span> GB used</div>
                </div>
                <div class="task-card">
                    <div class="task-status" id="lastTaskName" style="font-size: 1rem;">--</div>
                    <div class="task-label">Last Task</div>
                    <div class="task-meta">
                        <span id="lastTaskStatus">--</span>
                        <span id="lastTaskTime" style="color: #888;">--</span>
                    </div>
                </div>
                <div class="task-card">
                    <div class="task-stats-row">
                        <div class="task-stat">
                            <div class="task-stat-value" id="tasksRun" style="color: #ffd700;">0</div>
                            <div class="task-stat-label">Run</div>
                        </div>
                        <div class="task-stat">
                            <div class="task-stat-value" id="tasksSucceeded" style="color: #4ade80;">0</div>
                            <div class="task-stat-label">OK</div>
                        </div>
                        <div class="task-stat">
                            <div class="task-stat-value" id="tasksFailed" style="color: #f87171;">0</div>
                            <div class="task-stat-label">Fail</div>
                        </div>
                    </div>
                    <div class="task-label">Task Stats</div>
                </div>
                <div class="task-card">
                    <div class="task-status" id="daemonStatus" style="font-size: 1rem;">--</div>
                    <div class="task-label">Daemon</div>
                    <div class="task-meta" id="lastCheck">Last check: --</div>
                </div>
            </div>
        </div>
    </main>

    <!-- NAVIGATION -->
    <nav class="game-nav" id="bottomNav"></nav>
    <script src="/static/js/nav.js"></script>
    <script src="/static/js/events.js"></script>
    <script src="/static/js/realm-state.js?v=1"></script>
    <script src="/static/js/formatters.js?v=1"></script>

    <script>
        async function loadGuildData() {
            try {
                const skillsRes = await fetch('/api/skills');
                const skillsData = await skillsRes.json();
                const skills = skillsData.skills || skillsData;
                renderSkills(skills);

                const passivesRes = await fetch('/api/passives/summary');
                const passives = await passivesRes.json();
                renderPassives(passives);

                const curriculumRes = await fetch('/api/curriculum');
                const curriculum = await curriculumRes.json();
                renderSummary(skills, passives, curriculum, skillsData.total_mastered || 0);

                loadPrimitives();
            } catch (err) {
                console.error('Failed to load guild data:', err);
                document.getElementById('skillsGrid').innerHTML =
                    '<div class="error">Failed to load skills. Is the API running?</div>';
            }
        }

        function renderSkills(skills) {
            const grid = document.getElementById('skillsGrid');
            document.getElementById('skillsBadge').textContent = `${skills.length} skills`;

            if (!skills || skills.length === 0) {
                grid.innerHTML = '<div class="loading">No skills configured</div>';
                return;
            }

            grid.innerHTML = skills.map(skill => {
                const levelAccuracy = skill.level_accuracy || {};
                const masteredLevel = skill.mastered_level || 0;
                const maxLevel = skill.max_level || 30;
                const showLevels = Math.min(maxLevel, 20);
                const skillClass = skill.id || 'sy';

                let levelBlocks = '';
                for (let lvl = 1; lvl <= showLevels; lvl++) {
                    const acc = levelAccuracy[lvl];
                    let blockClass = 'unknown';
                    let tooltip = `L${lvl}: Not evaluated`;

                    if (acc !== undefined) {
                        if (acc >= 0.8) {
                            blockClass = 'mastered';
                            tooltip = `L${lvl}: ${(acc * 100).toFixed(0)}% (mastered)`;
                        } else if (acc >= 0.5) {
                            blockClass = 'training';
                            tooltip = `L${lvl}: ${(acc * 100).toFixed(0)}% (training)`;
                        } else {
                            blockClass = 'struggling';
                            tooltip = `L${lvl}: ${(acc * 100).toFixed(0)}% (struggling)`;
                        }
                    }
                    levelBlocks += `<div class="level-block ${blockClass}" title="${tooltip}">${lvl}</div>`;
                }

                const hasLevelData = Object.keys(levelAccuracy).length > 0;
                const levelAccuracyRow = hasLevelData ? `
                    <div class="level-accuracy-row">
                        <div class="level-title">Level Accuracy</div>
                        ${levelBlocks}
                    </div>
                ` : '';

                const zoneColor = skill.zone_color || '#6b7280';
                const zoneIcon = skill.zone_icon || '?';
                const zoneName = skill.zone || 'unknown';
                const zoneHint = skill.zone_hint || '';

                return `
                <div class="skill-card ${skillClass}" onclick="window.location.href='/skill/${skill.id}'">
                    <div class="skill-header">
                        <div class="skill-identity">
                            <div class="skill-icon">${skill.icon || '&#9876;'}</div>
                            <div>
                                <div class="skill-name">${skill.name}</div>
                                <div class="skill-description">${skill.description || ''}</div>
                            </div>
                        </div>
                        <div class="skill-level-badge">
                            <div class="skill-level">L${masteredLevel}</div>
                            <div class="strain-badge" title="${zoneHint}" style="background: ${zoneColor}20; color: ${zoneColor}; border: 1px solid ${zoneColor}40;">
                                <span>${zoneIcon}</span>
                                <span>${zoneName}</span>
                            </div>
                        </div>
                    </div>
                    <div class="skill-body">
                        <div class="skill-progress">
                            <div class="progress-header">
                                <span class="progress-label">Training L${skill.training_level || masteredLevel + 1}</span>
                                <span class="progress-value">${skill.accuracy || 0}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill ${skillClass}" style="width: ${Math.min(skill.accuracy || 0, 100)}%"></div>
                            </div>
                        </div>
                        ${levelAccuracyRow}
                        <div class="skill-stats">
                            <div class="stat">
                                <div class="stat-value">${skill.accuracy || 0}%</div>
                                <div class="stat-label">Recent Acc</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${skill.eval_count || 0}</div>
                                <div class="stat-label">Evals</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${skill.max_level || '?'}</div>
                                <div class="stat-label">Max Level</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;}).join('');
        }

        function renderPassives(data) {
            const grid = document.getElementById('passivesGrid');

            fetch('/api/passives/definitions').then(r => r.json()).then(definitions => {
                const results = data.by_passive || {};

                grid.innerHTML = definitions.map(p => {
                    const result = results[p.id] || {};
                    const accuracy = result.best_lite || null;
                    const accClass = accuracy === null ? 'none' :
                                    accuracy >= 0.8 ? 'good' :
                                    accuracy >= 0.5 ? 'ok' : 'bad';

                    return `
                        <div class="passive-card">
                            <div class="passive-header">
                                <span class="passive-name">${p.name}</span>
                                <span class="passive-version">v${p.version || '1.0.0'}</span>
                            </div>
                            <div class="passive-accuracy ${accClass}">
                                ${accuracy !== null ? (accuracy * 100).toFixed(0) + '%' : '--'}
                            </div>
                            <div class="passive-meta">
                                ${p.category} &bull; ${result.lite_count || 0} evals
                            </div>
                        </div>
                    `;
                }).join('');
            }).catch(() => {
                grid.innerHTML = '<div class="loading">No passives configured</div>';
            });
        }

        function renderSummary(skills, passives, curriculum, totalMastered) {
            const totalLevel = skills.reduce((sum, s) => sum + (s.current_level || s.mastered_level || 0), 0);
            document.getElementById('totalLevel').textContent = totalLevel;
            document.getElementById('bannerTotalLevel').textContent = totalLevel;

            document.getElementById('activeSkills').textContent = skills.length;
            document.getElementById('bannerSkillCount').textContent = skills.length;

            const passiveResults = passives.by_passive || {};
            const healthyCount = Object.values(passiveResults).filter(p => (p.best_lite || 0) >= 0.5).length;
            const totalPassives = Object.keys(passiveResults).length || '?';
            document.getElementById('passivesHealthy').textContent = `${healthyCount}/${totalPassives}`;
            document.getElementById('bannerPassives').textContent = `${healthyCount}/${totalPassives}`;

            if (curriculum && curriculum.last_eval_time) {
                const date = new Date(curriculum.last_eval_time);
                const ago = Math.round((Date.now() - date) / 60000);
                document.getElementById('lastEval').textContent =
                    ago < 60 ? `${ago}m ago` : `${Math.round(ago/60)}h ago`;
            }
        }

        async function loadPrimitives() {
            try {
                const res = await fetch('/api/engine/primitive-summary');
                const data = await res.json();
                renderPrimitives(data);
            } catch (err) {
                document.getElementById('primitivesGrid').innerHTML =
                    '<div class="loading">Skill Engine not available</div>';
            }
        }

        function renderPrimitives(data) {
            const grid = document.getElementById('primitivesGrid');
            const skillStates = data.skill_states || {};

            if (Object.keys(skillStates).length === 0) {
                grid.innerHTML = '<div class="loading">No primitive data yet (run evals to populate)</div>';
                return;
            }

            const html = Object.entries(skillStates).map(([skillId, state]) => {
                const primitiveAcc = state.primitive_accuracy || {};
                const primitives = Object.entries(primitiveAcc);

                if (primitives.length === 0) {
                    return `
                        <div class="track-card">
                            <div class="track-header">
                                <span class="track-name">${skillId.toUpperCase()}</span>
                                <span class="track-count">L${state.level} &bull; ${state.total_evals || 0} evals</span>
                            </div>
                            <div class="primitive-list">
                                <div style="color: #666; text-align: center; padding: 20px;">No primitive data yet</div>
                            </div>
                        </div>
                    `;
                }

                primitives.sort((a, b) => a[1] - b[1]);

                const primitiveHtml = primitives.map(([name, acc]) => {
                    const accClass = acc >= 0.8 ? 'good' : acc >= 0.5 ? 'ok' : 'bad';
                    const displayName = name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    return `
                        <div class="primitive-item">
                            <span class="primitive-name">${displayName}</span>
                            <span class="primitive-accuracy ${accClass}">${(acc * 100).toFixed(0)}%</span>
                        </div>
                    `;
                }).join('');

                const avgAcc = primitives.reduce((sum, [_, acc]) => sum + acc, 0) / primitives.length;
                const avgClass = avgAcc >= 0.8 ? 'good' : avgAcc >= 0.5 ? 'ok' : 'bad';

                return `
                    <div class="track-card">
                        <div class="track-header">
                            <span class="track-name">${skillId.toUpperCase()}</span>
                            <span class="track-count">
                                L${state.level} &bull; ${primitives.length} primitives &bull;
                                <span class="primitive-accuracy ${avgClass}" style="display: inline;">${(avgAcc * 100).toFixed(0)}% avg</span>
                            </span>
                        </div>
                        <div class="primitive-list">${primitiveHtml}</div>
                    </div>
                `;
            }).join('');

            grid.innerHTML = html;
        }

        async function loadTaskMaster() {
            try {
                const res = await fetch('/api/task-master');
                const data = await res.json();
                renderTaskMaster(data);
            } catch (err) {
                console.error('Failed to load task master:', err);
            }
        }

        function renderTaskMaster(data) {
            const gpu = data.gpus?.['3090'];
            if (gpu) {
                const statusEl = document.getElementById('gpuStatus');
                if (!gpu.available) {
                    statusEl.textContent = '&#10060; Offline';
                    statusEl.style.color = '#f87171';
                } else if (gpu.is_idle) {
                    statusEl.textContent = '&#10003; Idle';
                    statusEl.style.color = '#4ade80';
                } else {
                    statusEl.textContent = '&#9203; Busy';
                    statusEl.style.color = '#fbbf24';
                }
                document.getElementById('gpuMemory').textContent = gpu.memory_used_gb?.toFixed(1) || '--';
            } else if (!data.available) {
                document.getElementById('gpuStatus').textContent = 'Not Run';
                document.getElementById('gpuStatus').style.color = '#666';
            }

            const lastTask = data.last_task;
            if (lastTask && lastTask.name) {
                document.getElementById('lastTaskName').textContent = lastTask.name;
                document.getElementById('lastTaskStatus').textContent = lastTask.success ? '&#9989;' : '&#10060;';
                if (lastTask.timestamp) {
                    const ago = Math.round((Date.now() - new Date(lastTask.timestamp)) / 60000);
                    document.getElementById('lastTaskTime').textContent =
                        ago < 60 ? `${ago}m ago` : `${Math.round(ago/60)}h ago`;
                }
            }

            const stats = data.stats || {};
            document.getElementById('tasksRun').textContent = stats.tasks_run || 0;
            document.getElementById('tasksSucceeded').textContent = stats.tasks_succeeded || 0;
            document.getElementById('tasksFailed').textContent = stats.tasks_failed || 0;

            const daemonEl = document.getElementById('daemonStatus');
            if (data.daemon_running) {
                daemonEl.innerHTML = '&#128994; Running';
                daemonEl.style.color = '#4ade80';
            } else {
                daemonEl.innerHTML = '&#9898; Stopped';
                daemonEl.style.color = '#666';
            }

            if (stats.last_check) {
                const ago = Math.round((Date.now() - new Date(stats.last_check)) / 60000);
                document.getElementById('lastCheck').textContent =
                    `Last check: ${ago < 60 ? `${ago}m ago` : `${Math.round(ago/60)}h ago`}`;
            }
        }

        async function loadCampaignPeaks() {
            try {
                const res = await fetch('/api/campaigns/active');
                if (!res.ok) return;
                const c = await res.json();
                if (!c || !c.id) {
                    document.getElementById('campaignPeaks').style.display = 'none';
                    return;
                }

                document.getElementById('campaignPeaks').style.display = 'block';
                document.getElementById('journeySummary').textContent =
                    c.journey_summary || `${c.name} - Step ${(c.current_step || 0).toLocaleString()}`;

                const skillsUl = document.getElementById('peakSkillList');
                const peaks = c.peak_skill_levels || {};
                const skillKeys = Object.keys(peaks);

                skillsUl.innerHTML = skillKeys.length === 0
                    ? '<li class="peak-item" style="color: #666;">No skills peaked yet</li>'
                    : skillKeys.map(id => `
                        <li class="peak-item">
                            <span class="skill-name">${id}</span>:
                            <span class="skill-level">L${peaks[id]}</span>
                        </li>
                    `).join('');

                const metricsUl = document.getElementById('peakMetricList');
                const metrics = c.peak_metrics || {};
                const metricKeys = Object.keys(metrics);

                metricsUl.innerHTML = metricKeys.length === 0
                    ? '<li class="peak-item" style="color: #666;">No metrics tracked yet</li>'
                    : metricKeys.map(name => {
                        const value = metrics[name];
                        const displayValue = name.includes('accuracy')
                            ? `${(value * 100).toFixed(1)}%`
                            : value.toFixed(4);
                        const icon = name.includes('loss') ? '&#128201;' : name.includes('accuracy') ? '&#127919;' : '&#128202;';
                        const displayName = name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        return `
                            <li class="peak-item">
                                <span class="metric-icon">${icon}</span>
                                ${displayName}:
                                <span class="metric-value">${displayValue}</span>
                            </li>
                        `;
                    }).join('');
            } catch (err) {
                console.error('Failed to load campaign peaks:', err);
            }
        }

        function initSSE() {
            if (window.RealmState && typeof window.RealmState.subscribe === 'function') {
                RealmState.connectSSE();
                RealmState.subscribe('skills', () => {
                    loadGuildData();
                    loadCampaignPeaks();
                });
            } else {
                setTimeout(initSSE, 500);
            }
        }

        loadGuildData();
        loadTaskMaster();
        loadCampaignPeaks();
        initSSE();

        setInterval(loadGuildData, 120000);
        setInterval(loadTaskMaster, 60000);
        setInterval(loadCampaignPeaks, 120000);
    </script>
</body>
</html>
