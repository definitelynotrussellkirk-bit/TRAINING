<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guild Hall - Skills</title>
    <!-- Shared theme -->
    <link rel="stylesheet" href="/static/css/theme.css?v=1">
    <link rel="stylesheet" href="/static/css/game.css?v=4">
    <style>
        /* Guild-specific styles - uses theme.css variables */
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-body), system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--bg-panel) 0%, var(--bg-card) 100%);
            border-bottom: 1px solid var(--border-gold);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-gold);
            font-family: var(--font-title), serif;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            transition: all 0.2s;
        }

        .nav-links a:hover {
            background: var(--bg-highlight);
            color: var(--text-primary);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .section-title {
            font-size: 1.25rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Skills Grid */
        .skills-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .skill-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .skill-card:hover {
            border-color: var(--border-gold);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px var(--glow-gold);
        }

        .skill-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .skill-icon {
            font-size: 2rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-highlight);
            border-radius: 10px;
        }

        .skill-name {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .skill-level {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--border-gold);
        }

        .skill-progress {
            margin: 1rem 0;
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-dark);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--border-gold), #a78bfa);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .skill-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        /* Level Accuracy Breakdown */
        .level-accuracy-row {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            margin: 0.75rem 0;
            padding: 0.5rem;
            background: var(--bg-dark);
            border-radius: 6px;
        }

        .level-accuracy-row .level-title {
            width: 100%;
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }

        .level-block {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: bold;
            color: rgba(0,0,0,0.7);
            cursor: default;
            transition: transform 0.1s;
        }

        .level-block:hover {
            transform: scale(1.2);
            z-index: 1;
        }

        .level-block.mastered { background: var(--color-success); }
        .level-block.training { background: var(--color-warning); }
        .level-block.struggling { background: var(--color-danger); }
        .level-block.unknown { background: var(--bg-highlight); color: var(--text-secondary); }

        /* Strain Zone Badge */
        .strain-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .strain-badge .zone-icon {
            font-size: 0.85rem;
        }

        /* Passives Section */
        .passives-section {
            margin-top: 2rem;
        }

        .passives-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .passive-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
        }

        .passive-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .passive-name {
            font-weight: 600;
        }

        .passive-version {
            font-size: 0.7rem;
            color: var(--text-secondary);
            background: var(--bg-highlight);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .passive-accuracy {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }

        .passive-accuracy.good { color: var(--color-success); }
        .passive-accuracy.ok { color: var(--color-warning); }
        .passive-accuracy.bad { color: var(--color-danger); }
        .passive-accuracy.none { color: var(--text-secondary); }

        .passive-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Primitives Section */
        .primitives-section {
            margin-top: 2rem;
        }

        .primitives-tracks {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .track-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
        }

        .track-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .track-name {
            font-weight: 600;
            font-size: 1rem;
            text-transform: capitalize;
        }

        .track-count {
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: var(--bg-highlight);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .primitive-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .primitive-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: var(--bg-highlight);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .primitive-name {
            color: var(--text-primary);
        }

        .primitive-accuracy {
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .primitive-accuracy.good { color: var(--color-success); background: rgba(34, 197, 94, 0.1); }
        .primitive-accuracy.ok { color: var(--color-warning); background: rgba(245, 158, 11, 0.1); }
        .primitive-accuracy.bad { color: var(--color-danger); background: rgba(239, 68, 68, 0.1); }
        .primitive-accuracy.none { color: var(--text-secondary); }

        .drift-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .drift-positive { background: rgba(34, 197, 94, 0.2); color: var(--color-success); }
        .drift-neutral { background: rgba(128, 128, 144, 0.2); color: var(--text-secondary); }
        .drift-negative { background: rgba(239, 68, 68, 0.2); color: var(--color-danger); }

        /* Summary Cards */
        .summary-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--border-gold);
        }

        .summary-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--color-danger);
            color: var(--color-danger);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- Shared game header -->
    <header class="game-header">
        <div class="header-left">
            <h1 class="game-title">üè∞ Guild Hall</h1>
        </div>
        <div class="header-center">
            <div class="resource-bar">
                <div class="resource steps">
                    <span class="resource-icon">‚ö°</span>
                    <span class="resource-label">STEPS</span>
                    <span class="resource-value" id="totalSteps">0</span>
                </div>
                <div class="resource evals">
                    <span class="resource-icon">üéØ</span>
                    <span class="resource-label">EVALS</span>
                    <span class="resource-value" id="totalEvals">0</span>
                </div>
            </div>
        </div>
        <div class="header-right">
            <div class="realm-mode-toggle" id="realmModeToggle">
                <button class="mode-btn mode-training" id="btnTraining" title="Enable auto-training">TRAIN</button>
                <button class="mode-btn mode-idle" id="btnIdle" title="Pause auto-training">IDLE</button>
            </div>
            <div class="health-indicator" id="healthIndicator" title="Realm health">
                <span class="health-icon" id="healthIcon">‚ö™</span>
            </div>
            <div class="idle-indicator" id="idleIndicator">
                <span class="idle-icon" id="modeIcon">üí§</span>
                <span class="idle-text" id="modeText">IDLE</span>
            </div>
            <div class="time-display" id="timeDisplay">--:--:--</div>
        </div>
    </header>

    <main class="container">
        <!-- Summary -->
        <div class="summary-row" id="summary">
            <div class="summary-card">
                <div class="summary-value" id="totalLevel">--</div>
                <div class="summary-label">Total Level</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="activeSkills">--</div>
                <div class="summary-label">Active Skills</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="passivesHealthy">--</div>
                <div class="summary-label">Passives Healthy</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="lastEval">--</div>
                <div class="summary-label">Last Evaluation</div>
            </div>
        </div>

        <!-- Hero's Journey - Personal Best -->
        <div class="campaign-peaks-section" id="campaignPeaks" style="margin-bottom: 2rem; display: none;">
            <h2 class="section-title">üèÜ Hero's Journey - Personal Best</h2>
            <div style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem;">
                <p id="journeySummary" style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--border-gold);">Loading...</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                    <!-- Peak Skills -->
                    <div>
                        <h4 style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.75rem;">Peak Skill Levels</h4>
                        <ul id="peakSkillList" style="list-style: none; display: flex; flex-wrap: wrap; gap: 0.5rem;"></ul>
                    </div>
                    <!-- Peak Metrics -->
                    <div>
                        <h4 style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.75rem;">Best Metrics</h4>
                        <ul id="peakMetricList" style="list-style: none; display: flex; flex-wrap: wrap; gap: 0.5rem;"></ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Skills -->
        <h2 class="section-title">‚öîÔ∏è Active Skills</h2>
        <div class="skills-grid" id="skillsGrid">
            <div class="loading">Loading skills...</div>
        </div>

        <!-- Passives -->
        <div class="passives-section">
            <h2 class="section-title">üõ°Ô∏è Passives (Transfer Learning)</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">
                General abilities tested independently of active training. Detects catastrophic forgetting.
            </p>
            <div class="passives-grid" id="passivesGrid">
                <div class="loading">Loading passives...</div>
            </div>
        </div>

        <!-- Primitives (Skill Engine) -->
        <div class="primitives-section">
            <h2 class="section-title">üß© Primitives (Per-Concept Accuracy)</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">
                Fine-grained accuracy tracking for atomic concepts within each skill. Identifies specific weaknesses.
            </p>
            <div class="primitives-tracks" id="primitivesGrid">
                <div class="loading">Loading primitives...</div>
            </div>
        </div>

        <!-- Task Master (Background Tasks) -->
        <div class="task-master-section" style="margin-top: 2rem;">
            <h2 class="section-title">ü§ñ Task Master (3090)</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">
                Background tasks running on the inference GPU when idle.
            </p>
            <div class="task-master-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                <!-- GPU Status Card -->
                <div class="summary-card" id="taskMasterGpu">
                    <div class="summary-value" id="gpuStatus">--</div>
                    <div class="summary-label">3090 Status</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        <span id="gpuMemory">--</span> GB used
                    </div>
                </div>
                <!-- Last Task Card -->
                <div class="summary-card" id="taskMasterLast">
                    <div class="summary-value" id="lastTaskName" style="font-size: 1rem;">--</div>
                    <div class="summary-label">Last Task</div>
                    <div style="font-size: 0.75rem; margin-top: 0.5rem;">
                        <span id="lastTaskStatus">--</span>
                        <span id="lastTaskTime" style="color: var(--text-secondary);">--</span>
                    </div>
                </div>
                <!-- Stats Card -->
                <div class="summary-card" id="taskMasterStats">
                    <div style="display: flex; justify-content: space-around;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--border-gold);" id="tasksRun">0</div>
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">RUN</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--color-success);" id="tasksSucceeded">0</div>
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">OK</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--color-danger);" id="tasksFailed">0</div>
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">FAIL</div>
                        </div>
                    </div>
                    <div class="summary-label" style="margin-top: 0.5rem;">Task Stats</div>
                </div>
                <!-- Daemon Status Card -->
                <div class="summary-card" id="taskMasterDaemon">
                    <div class="summary-value" id="daemonStatus" style="font-size: 1rem;">--</div>
                    <div class="summary-label">Daemon</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;" id="lastCheck">
                        Last check: --
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- NAVIGATION (dynamic) -->
    <nav class="game-nav" id="bottomNav"></nav>
    <script src="/static/js/nav.js"></script>
    <script src="/static/js/events.js"></script>
    <script src="/static/js/realm-state.js?v=1"></script>
    <!-- Shared modules -->
    <script src="/static/js/formatters.js?v=1"></script>

    <script>
        async function loadGuildData() {
            try {
                // Load skills
                const skillsRes = await fetch('/api/skills');
                const skillsData = await skillsRes.json();
                const skills = skillsData.skills || skillsData;  // Handle both formats
                renderSkills(skills);

                // Load passives
                const passivesRes = await fetch('/api/passives/summary');
                const passives = await passivesRes.json();
                renderPassives(passives);

                // Load curriculum state for summary
                const curriculumRes = await fetch('/api/curriculum');
                const curriculum = await curriculumRes.json();
                renderSummary(skills, passives, curriculum, skillsData.total_mastered || 0);

                // Load primitives (Skill Engine)
                loadPrimitives();

            } catch (err) {
                console.error('Failed to load guild data:', err);
                document.getElementById('skillsGrid').innerHTML =
                    '<div class="error">Failed to load skills. Is the API running?</div>';
            }
        }

        function renderSkills(skills) {
            const grid = document.getElementById('skillsGrid');

            if (!skills || skills.length === 0) {
                grid.innerHTML = '<div class="loading">No skills configured<br><small style="opacity: 0.7">Define skills in configs/skills/*.yaml to see them here.</small></div>';
                return;
            }

            grid.innerHTML = skills.map(skill => {
                // Build level accuracy blocks
                const levelAccuracy = skill.level_accuracy || {};
                const masteredLevel = skill.mastered_level || 0;
                const trainingLevel = skill.training_level || masteredLevel + 1;
                const maxLevel = skill.max_level || 30;

                // Generate level blocks (show up to 20 or max_level, whichever is smaller)
                const showLevels = Math.min(maxLevel, 20);
                let levelBlocks = '';
                for (let lvl = 1; lvl <= showLevels; lvl++) {
                    const acc = levelAccuracy[lvl];
                    let blockClass = 'unknown';
                    let tooltip = `L${lvl}: Not evaluated`;

                    if (acc !== undefined) {
                        if (acc >= 0.8) {
                            blockClass = 'mastered';
                            tooltip = `L${lvl}: ${(acc * 100).toFixed(0)}% (mastered)`;
                        } else if (acc >= 0.5) {
                            blockClass = 'training';
                            tooltip = `L${lvl}: ${(acc * 100).toFixed(0)}% (training)`;
                        } else {
                            blockClass = 'struggling';
                            tooltip = `L${lvl}: ${(acc * 100).toFixed(0)}% (struggling)`;
                        }
                    }

                    levelBlocks += `<div class="level-block ${blockClass}" title="${tooltip}">${lvl}</div>`;
                }

                // Only show level accuracy row if there's any data
                const hasLevelData = Object.keys(levelAccuracy).length > 0;
                const levelAccuracyRow = hasLevelData ? `
                    <div class="level-accuracy-row">
                        <div class="level-title">Level Accuracy</div>
                        ${levelBlocks}
                    </div>
                ` : '';

                // Build strain zone badge
                const zoneColor = skill.zone_color || '#6b7280';
                const zoneIcon = skill.zone_icon || '?';
                const zoneName = skill.zone || 'unknown';
                const zoneHint = skill.zone_hint || '';

                return `
                <div class="skill-card" onclick="window.location.href='/skill/${skill.id}'">
                    <div class="skill-header">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div class="skill-icon">${skill.icon || '‚öîÔ∏è'}</div>
                            <div>
                                <div class="skill-name">${skill.name}</div>
                                <div style="color: var(--text-secondary); font-size: 0.875rem;">
                                    ${skill.description || ''}
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div class="skill-level">L${skill.mastered_level || 0}</div>
                            <div class="strain-badge" title="${zoneHint}" style="background: ${zoneColor}20; color: ${zoneColor}; border: 1px solid ${zoneColor}40;">
                                <span class="zone-icon">${zoneIcon}</span>
                                <span>${zoneName}</span>
                            </div>
                        </div>
                    </div>
                    <div class="skill-progress">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span style="font-size: 0.75rem; color: var(--text-secondary);">
                                Training L${skill.training_level || (skill.mastered_level || 0) + 1}
                            </span>
                            <span style="font-size: 0.75rem;">
                                ${skill.accuracy || 0}%
                            </span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(skill.accuracy || 0, 100)}%"></div>
                        </div>
                    </div>
                    ${levelAccuracyRow}
                    <div class="skill-stats">
                        <div class="stat">
                            <div class="stat-value">${skill.accuracy || 0}%</div>
                            <div class="stat-label">Recent Acc</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${skill.eval_count || 0}</div>
                            <div class="stat-label">Evals</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${skill.max_level || '?'}</div>
                            <div class="stat-label">Max Level</div>
                        </div>
                    </div>
                </div>
            `;}).join('');
        }

        function renderPassives(data) {
            const grid = document.getElementById('passivesGrid');

            // Get passive definitions
            fetch('/api/passives/definitions').then(r => r.json()).then(definitions => {
                const results = data.by_passive || {};

                grid.innerHTML = definitions.map(p => {
                    const result = results[p.id] || {};
                    const accuracy = result.best_lite || null;
                    const accClass = accuracy === null ? 'none' :
                                    accuracy >= 0.8 ? 'good' :
                                    accuracy >= 0.5 ? 'ok' : 'bad';

                    return `
                        <div class="passive-card">
                            <div class="passive-header">
                                <span class="passive-name">${p.name}</span>
                                <span class="passive-version">v${p.version || '1.0.0'}</span>
                            </div>
                            <div class="passive-accuracy ${accClass}">
                                ${accuracy !== null ? (accuracy * 100).toFixed(0) + '%' : '--'}
                            </div>
                            <div class="passive-meta">
                                ${p.category} &bull; ${result.lite_count || 0} evals
                            </div>
                        </div>
                    `;
                }).join('');
            }).catch(() => {
                grid.innerHTML = '<div class="loading">No passives configured</div>';
            });
        }

        function renderSummary(skills, passives, curriculum, totalMastered) {
            // Total level = sum of all skill levels
            const totalLevel = skills.reduce((sum, s) => sum + (s.current_level || 0), 0);
            document.getElementById('totalLevel').textContent = totalLevel;

            // Active skills count
            document.getElementById('activeSkills').textContent = skills.length;

            // Passives healthy (>= 50% accuracy)
            const passiveResults = passives.by_passive || {};
            const healthyCount = Object.values(passiveResults)
                .filter(p => (p.best_lite || 0) >= 0.5).length;
            const totalPassives = Object.keys(passiveResults).length || '?';
            document.getElementById('passivesHealthy').textContent =
                `${healthyCount}/${totalPassives}`;

            // Last eval time
            if (curriculum && curriculum.last_eval_time) {
                const date = new Date(curriculum.last_eval_time);
                const ago = Math.round((Date.now() - date) / 60000);
                document.getElementById('lastEval').textContent =
                    ago < 60 ? `${ago}m ago` : `${Math.round(ago/60)}h ago`;
            }
        }

        // Primitives - Skill Engine per-concept accuracy
        async function loadPrimitives() {
            try {
                const res = await fetch('/api/engine/primitive-summary');
                const data = await res.json();
                renderPrimitives(data);
            } catch (err) {
                console.error('Failed to load primitives:', err);
                document.getElementById('primitivesGrid').innerHTML =
                    '<div class="loading">Skill Engine not available</div>';
            }
        }

        function renderPrimitives(data) {
            const grid = document.getElementById('primitivesGrid');
            const skillStates = data.skill_states || {};

            if (Object.keys(skillStates).length === 0) {
                grid.innerHTML = '<div class="loading">No primitive data yet (run evals to populate)</div>';
                return;
            }

            // Group primitives by skill
            const html = Object.entries(skillStates).map(([skillId, state]) => {
                const primitiveAcc = state.primitive_accuracy || {};
                const primitives = Object.entries(primitiveAcc);

                if (primitives.length === 0) {
                    return `
                        <div class="track-card">
                            <div class="track-header">
                                <span class="track-name">${skillId.toUpperCase()}</span>
                                <span class="track-count">L${state.level} ¬∑ ${state.total_evals || 0} evals</span>
                            </div>
                            <div class="primitive-list">
                                <div style="color: var(--text-secondary); font-size: 0.85rem; text-align: center; padding: 1rem;">
                                    No primitive data yet
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Sort by accuracy (worst first) to highlight weaknesses
                primitives.sort((a, b) => a[1] - b[1]);

                const primitiveHtml = primitives.map(([name, acc]) => {
                    const accClass = acc >= 0.8 ? 'good' : acc >= 0.5 ? 'ok' : 'bad';
                    const displayName = name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    return `
                        <div class="primitive-item">
                            <span class="primitive-name">${displayName}</span>
                            <span class="primitive-accuracy ${accClass}">${(acc * 100).toFixed(0)}%</span>
                        </div>
                    `;
                }).join('');

                const avgAcc = primitives.reduce((sum, [_, acc]) => sum + acc, 0) / primitives.length;
                const avgClass = avgAcc >= 0.8 ? 'good' : avgAcc >= 0.5 ? 'ok' : 'bad';

                return `
                    <div class="track-card">
                        <div class="track-header">
                            <span class="track-name">${skillId.toUpperCase()}</span>
                            <span class="track-count">
                                L${state.level} ¬∑ ${primitives.length} primitives ¬∑
                                <span class="primitive-accuracy ${avgClass}" style="display: inline;">${(avgAcc * 100).toFixed(0)}% avg</span>
                            </span>
                        </div>
                        <div class="primitive-list">
                            ${primitiveHtml}
                        </div>
                    </div>
                `;
            }).join('');

            grid.innerHTML = html;
        }

        // Task Master - Background task status
        async function loadTaskMaster() {
            try {
                const res = await fetch('/api/task-master');
                const data = await res.json();
                renderTaskMaster(data);
            } catch (err) {
                console.error('Failed to load task master:', err);
            }
        }

        function renderTaskMaster(data) {
            // GPU Status
            const gpu = data.gpus?.['3090'];
            if (gpu) {
                const statusEl = document.getElementById('gpuStatus');
                if (!gpu.available) {
                    statusEl.textContent = '‚ùå Offline';
                    statusEl.style.color = 'var(--color-danger)';
                } else if (gpu.is_idle) {
                    statusEl.textContent = '‚úì Idle';
                    statusEl.style.color = 'var(--color-success)';
                } else {
                    statusEl.textContent = '‚è≥ Busy';
                    statusEl.style.color = 'var(--color-warning)';
                }
                document.getElementById('gpuMemory').textContent =
                    gpu.memory_used_gb?.toFixed(1) || '--';
            } else if (!data.available) {
                document.getElementById('gpuStatus').textContent = 'Not Run';
                document.getElementById('gpuStatus').style.color = 'var(--text-secondary)';
            }

            // Last Task
            const lastTask = data.last_task;
            if (lastTask && lastTask.name) {
                document.getElementById('lastTaskName').textContent = lastTask.name;

                const statusSpan = document.getElementById('lastTaskStatus');
                if (lastTask.success) {
                    statusSpan.textContent = '‚úÖ';
                } else {
                    statusSpan.textContent = '‚ùå';
                }

                // Time ago
                if (lastTask.timestamp) {
                    const date = new Date(lastTask.timestamp);
                    const ago = Math.round((Date.now() - date) / 60000);
                    document.getElementById('lastTaskTime').textContent =
                        ago < 60 ? `${ago}m ago` : `${Math.round(ago/60)}h ago`;
                }
            }

            // Stats
            const stats = data.stats || {};
            document.getElementById('tasksRun').textContent = stats.tasks_run || 0;
            document.getElementById('tasksSucceeded').textContent = stats.tasks_succeeded || 0;
            document.getElementById('tasksFailed').textContent = stats.tasks_failed || 0;

            // Daemon Status
            const daemonEl = document.getElementById('daemonStatus');
            if (data.daemon_running) {
                daemonEl.textContent = 'üü¢ Running';
                daemonEl.style.color = 'var(--color-success)';
            } else {
                daemonEl.textContent = '‚ö™ Stopped';
                daemonEl.style.color = 'var(--text-secondary)';
            }

            // Last check time
            if (stats.last_check) {
                const date = new Date(stats.last_check);
                const ago = Math.round((Date.now() - date) / 60000);
                document.getElementById('lastCheck').textContent =
                    `Last check: ${ago < 60 ? `${ago}m ago` : `${Math.round(ago/60)}h ago`}`;
            }
        }

        // Campaign Peaks - Personal Best tracking
        async function loadCampaignPeaks() {
            try {
                const res = await fetch('/api/campaigns/active');
                if (!res.ok) return;

                const c = await res.json();
                if (!c || !c.id) {
                    // No active campaign - hide section
                    document.getElementById('campaignPeaks').style.display = 'none';
                    return;
                }

                // Show the section
                document.getElementById('campaignPeaks').style.display = 'block';

                // Journey summary
                document.getElementById('journeySummary').textContent =
                    c.journey_summary || `${c.name} - Step ${(c.current_step || 0).toLocaleString()}`;

                // Peak skills
                const skillsUl = document.getElementById('peakSkillList');
                const peaks = c.peak_skill_levels || {};
                const skillKeys = Object.keys(peaks);

                if (skillKeys.length === 0) {
                    skillsUl.innerHTML = '<li style="color: var(--text-secondary);">No skills peaked yet</li>';
                } else {
                    skillsUl.innerHTML = skillKeys.map(skillId => `
                        <li style="background: var(--bg-highlight); padding: 0.5rem 1rem; border-radius: 6px;">
                            <span style="font-weight: 600; text-transform: uppercase;">${skillId}</span>:
                            <span style="color: var(--border-gold);">L${peaks[skillId]}</span>
                        </li>
                    `).join('');
                }

                // Peak metrics
                const metricsUl = document.getElementById('peakMetricList');
                const metrics = c.peak_metrics || {};
                const metricKeys = Object.keys(metrics);

                if (metricKeys.length === 0) {
                    metricsUl.innerHTML = '<li style="color: var(--text-secondary);">No metrics tracked yet</li>';
                } else {
                    metricsUl.innerHTML = metricKeys.map(name => {
                        const value = metrics[name];
                        const displayValue = name.includes('accuracy')
                            ? `${(value * 100).toFixed(1)}%`
                            : value.toFixed(4);
                        const icon = name.includes('loss') ? 'üìâ' : name.includes('accuracy') ? 'üéØ' : 'üìä';
                        const displayName = name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        return `
                            <li style="background: var(--bg-highlight); padding: 0.5rem 1rem; border-radius: 6px;">
                                ${icon} ${displayName}:
                                <span style="color: var(--color-success); font-weight: 600;">${displayValue}</span>
                            </li>
                        `;
                    }).join('');
                }
            } catch (err) {
                console.error('Failed to load campaign peaks:', err);
            }
        }

        // Load on page load
        loadGuildData();
        loadTaskMaster();
        loadCampaignPeaks();

        // Refresh every 30 seconds
        setInterval(loadGuildData, 30000);
        setInterval(loadTaskMaster, 30000);
        setInterval(loadCampaignPeaks, 30000);
    </script>
</body>
</html>
