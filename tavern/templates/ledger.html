<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkpoint Ledger - Realm of Training</title>
    <link rel="stylesheet" href="/static/css/theme.css?v=1">
    <link rel="stylesheet" href="/static/css/game.css?v=3">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        .ledger-main {
            padding: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .ledger-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .ledger-title {
            font-family: var(--font-display);
            color: var(--color-gold);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .ledger-summary {
            display: flex;
            gap: 2rem;
            background: var(--bg-card);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .summary-stat {
            text-align: center;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-gold);
        }

        .summary-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .ledger-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .filter-group select, .filter-group input {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.4rem 0.6rem;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .ledger-table-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .ledger-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .ledger-table th {
            background: var(--bg-dark);
            color: var(--text-muted);
            font-weight: 600;
            text-align: left;
            padding: 0.75rem 1rem;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-color);
        }

        .ledger-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .ledger-table tr:hover {
            background: rgba(212, 165, 116, 0.05);
        }

        .ledger-table tr:last-child td {
            border-bottom: none;
        }

        .step-link {
            color: var(--color-gold);
            text-decoration: none;
            font-weight: 600;
            font-family: var(--font-mono);
        }

        .step-link:hover {
            text-decoration: underline;
        }

        .loss-value {
            font-family: var(--font-mono);
            font-size: 0.85rem;
        }

        .loss-value.good { color: var(--color-success); }
        .loss-value.medium { color: var(--color-warning); }
        .loss-value.high { color: var(--color-danger); }

        .location-badge {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            background: var(--bg-dark);
            border-radius: 4px;
            font-size: 0.75rem;
            margin-right: 0.25rem;
        }

        .location-badge.primary {
            background: rgba(16, 185, 129, 0.2);
            color: var(--color-success);
        }

        .timestamp {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Campaign Banner */
        .campaign-banner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, rgba(30, 30, 50, 0.95) 0%, rgba(40, 35, 60, 0.95) 100%);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
        }

        .campaign-hero {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .campaign-hero-icon {
            font-size: 2rem;
        }

        .campaign-hero-name {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: #ffd700;
        }

        .campaign-id {
            font-size: 0.75rem;
            color: #888;
        }

        .campaign-stats {
            display: flex;
            gap: 24px;
        }

        .campaign-stat {
            text-align: center;
        }

        .campaign-stat .stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
        }

        .campaign-stat .stat-label {
            font-size: 0.65rem;
            color: #888;
            text-transform: uppercase;
        }

        /* Status indicators */
        .status-icon {
            margin-right: 4px;
        }

        .status-local { color: var(--color-success); }
        .status-remote { color: #8b5cf6; }
        .status-missing { color: var(--color-danger); }

        .eval-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 5px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            background: var(--bg-dark);
            color: var(--text-muted);
        }

        .eval-badge.has-evals {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .eval-badge.many-evals {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .hero-cell {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .hero-icon {
            font-size: 1rem;
        }

        .hero-name {
            font-weight: 600;
            font-size: 0.85rem;
        }

        .best-badge {
            background: linear-gradient(135deg, var(--color-gold), #b8860b);
            color: var(--bg-dark);
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 0.5rem;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .pagination button {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination button:hover:not(:disabled) {
            border-color: var(--color-gold);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            padding: 0.4rem 0.8rem;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <header class="game-header">
        <div class="header-left">
            <h1 class="game-title">Realm of Training</h1>
        </div>
        <div class="header-center">
            <span class="realm-subtitle">Checkpoint Ledger</span>
        </div>
        <div class="header-right">
            <span id="timeDisplay" class="time-display"></span>
        </div>
    </header>

    <main class="ledger-main">
        <!-- Campaign Banner -->
        <div class="campaign-banner" id="campaignBanner">
            <div class="campaign-hero">
                <span class="campaign-hero-icon" id="campaignHeroIcon">‚ö°</span>
                <div>
                    <div class="campaign-hero-name" id="campaignHeroName">Loading...</div>
                    <div class="campaign-id" id="campaignId">--</div>
                </div>
            </div>
            <div class="campaign-stats">
                <div class="campaign-stat">
                    <div class="stat-value" id="localCount">--</div>
                    <div class="stat-label">Local</div>
                </div>
                <div class="campaign-stat">
                    <div class="stat-value" id="remoteCount">--</div>
                    <div class="stat-label">Remote</div>
                </div>
                <div class="campaign-stat">
                    <div class="stat-value" id="totalEvals">--</div>
                    <div class="stat-label">Evals</div>
                </div>
            </div>
        </div>

        <div class="ledger-header">
            <h2 class="ledger-title">
                <span>üìñ</span> Checkpoint Ledger
            </h2>
            <div class="ledger-summary" id="ledgerSummary">
                <div class="summary-stat">
                    <div class="summary-value" id="totalCheckpoints">--</div>
                    <div class="summary-label">Checkpoints</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-value" id="bestStep">--</div>
                    <div class="summary-label">Best Step</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-value" id="bestLoss">--</div>
                    <div class="summary-label">Best Loss</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-value" id="totalLocations">--</div>
                    <div class="summary-label">Locations</div>
                </div>
            </div>
        </div>

        <div class="ledger-filters">
            <div class="filter-group">
                <label>Sort by:</label>
                <select id="sortBy" onchange="loadLedger()">
                    <option value="step_desc">Step (newest)</option>
                    <option value="step_asc">Step (oldest)</option>
                    <option value="loss_asc">Loss (best)</option>
                    <option value="loss_desc">Loss (worst)</option>
                    <option value="created_desc">Created (recent)</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Device:</label>
                <select id="filterDevice" onchange="loadLedger()">
                    <option value="">All devices</option>
                    <option value="trainer4090">trainer4090</option>
                    <option value="inference3090">inference3090</option>
                    <option value="synology_data">synology_data</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Show:</label>
                <select id="pageSize" onchange="loadLedger()">
                    <option value="25">25</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>

        <div class="ledger-table-container">
            <table class="ledger-table">
                <thead>
                    <tr>
                        <th>Hero</th>
                        <th>Checkpoint</th>
                        <th>Loss</th>
                        <th>Status</th>
                        <th>Evals</th>
                        <th>Age</th>
                    </tr>
                </thead>
                <tbody id="ledgerBody">
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-state-icon">üìñ</div>
                            <div>Loading checkpoint ledger...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="pagination" id="pagination" style="display: none;">
                <button id="prevPage" onclick="changePage(-1)">‚Üê Prev</button>
                <span class="page-info" id="pageInfo">Page 1</span>
                <button id="nextPage" onclick="changePage(1)">Next ‚Üí</button>
            </div>
        </div>
    </main>

    <nav class="game-nav" id="bottomNav"></nav>
    <script src="/static/js/nav.js"></script>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let bestStep = null;
        let activeHeroId = null;
        let activeCampaignId = null;

        // Hero icon mapping
        const HERO_ICONS = {
            'DIO': 'üßîüèΩ', 'FLO': 'üë©', 'ZENO': '‚ôæÔ∏è', 'VERO': '‚úÖ', 'NERO': 'üåë',
            'ORO': 'ü™ô', 'LOBO': 'üê∫', 'TORO': 'üêÇ', 'MONO': 'üêí', 'OJO': 'üëÅ',
            'GOU': 'üêï', 'TAO': '‚òØÔ∏è', 'MO': '‚úíÔ∏è', 'SHOU': 'üõ°', 'NEKO': 'üêà',
            'KUMO': 'üï∏', 'TOMO': 'ü§ù', 'AO': 'üåä', 'MOMO': 'üçë', 'MOYO': '‚ù§Ô∏è',
            'MOTO': 'üî•', 'OMO': 'üßí', 'MIRO': 'üïä', 'LUMO': 'üí°', 'OM': 'üïâÔ∏è',
            'OJAS': '‚ö°', 'BODHI': 'üßò', 'DAYA': 'üôè', 'AGNI': 'üî•', 'KAVI': '‚úçÔ∏è',
            'MITRA': 'ü§ó', 'NOOR': 'üåü', 'SABR': '‚è≥', 'FIKR': 'ü§î', 'RUH': 'üëª',
            'OR': 'üïØÔ∏è', 'EMET': '‚öñÔ∏è', 'LEV': 'üíú', 'CHEN': '‚ú®', 'KAI': 'üåä',
            'MANA': '‚ö°', 'OLA': 'üå±',
        };

        function getHeroIcon(heroName) {
            if (!heroName) return 'üè∫';
            const key = heroName.toUpperCase();
            return HERO_ICONS[key] || 'üè∫';
        }

        function getHeroName(heroId) {
            if (!heroId) return 'Unknown';
            return heroId.split('-')[0].toUpperCase();
        }

        async function loadLedger() {
            const sortBy = document.getElementById('sortBy').value;
            const device = document.getElementById('filterDevice').value;
            const pageSize = parseInt(document.getElementById('pageSize').value);

            try {
                // Load summary first
                const summaryRes = await fetch('/ledger/summary');
                const summary = await summaryRes.json();

                document.getElementById('totalCheckpoints').textContent = summary.count?.toLocaleString() || '0';
                document.getElementById('totalLocations').textContent = Object.keys(summary.by_device || {}).length;

                // Load best checkpoint
                const bestRes = await fetch('/ledger/best?metric=train_loss');
                const best = await bestRes.json();

                if (best && best.step) {
                    bestStep = best.step;
                    document.getElementById('bestStep').textContent = best.step.toLocaleString();
                    document.getElementById('bestLoss').textContent = best.train_loss?.toFixed(4) || '--';
                }

                // Load checkpoint list
                let url = `/ledger?limit=${pageSize}&offset=${(currentPage - 1) * pageSize}&include_base=false`;
                if (device) url += `&device=${device}`;

                const res = await fetch(url);
                const data = await res.json();

                // Update campaign banner
                activeHeroId = data.active_hero_id;
                activeCampaignId = data.active_campaign_id;
                updateCampaignBanner(data);

                const checkpoints = data.checkpoints || [];
                totalPages = Math.ceil((data.total || checkpoints.length) / pageSize);

                renderTable(checkpoints);
                updatePagination();

            } catch (err) {
                console.error('Failed to load ledger:', err);
                document.getElementById('ledgerBody').innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-state-icon">‚ö†Ô∏è</div>
                            <div>Failed to load ledger: ${err.message}</div>
                        </td>
                    </tr>
                `;
            }
        }

        function updateCampaignBanner(data) {
            const heroName = getHeroName(data.active_hero_id);
            const heroIcon = getHeroIcon(heroName);

            document.getElementById('campaignHeroIcon').textContent = heroIcon;
            document.getElementById('campaignHeroName').textContent = heroName || 'No Active Campaign';
            document.getElementById('campaignId').textContent = data.active_campaign_id || '--';

            // Count local vs remote
            const checkpoints = data.checkpoints || [];
            const localCount = checkpoints.filter(c => c.is_local).length;
            const remoteCount = checkpoints.filter(c => !c.is_local && c.locations?.length > 0).length;
            const totalEvals = checkpoints.reduce((sum, c) => sum + (c.eval_count || 0), 0);

            document.getElementById('localCount').textContent = localCount;
            document.getElementById('remoteCount').textContent = remoteCount;
            document.getElementById('totalEvals').textContent = totalEvals;
        }

        function renderTable(checkpoints) {
            const tbody = document.getElementById('ledgerBody');

            if (!checkpoints.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-state-icon">üìñ</div>
                            <div>No checkpoints recorded yet</div>
                            <div style="margin-top: 0.5rem; font-size: 0.85rem;">
                                Start training to create checkpoints
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = checkpoints.map(ckpt => {
                if (ckpt.is_base) return ''; // Skip base model

                const step = ckpt.step;
                const isBest = step === bestStep;
                const loss = ckpt.train_loss;
                const lossClass = loss ? (loss < 0.02 ? 'good' : loss < 0.05 ? 'medium' : 'high') : '';

                // Hero info
                const heroName = getHeroName(ckpt.hero_id);
                const heroIcon = getHeroIcon(heroName);
                const isActive = ckpt.is_active_campaign;

                // Status indicator
                let statusHtml;
                if (ckpt.is_local) {
                    statusHtml = '<span class="status-icon status-local" title="Local">üíª</span> Local';
                } else if (ckpt.locations?.length > 0) {
                    const locs = ckpt.locations.join(', ');
                    statusHtml = `<span class="status-icon status-remote" title="${locs}">‚òÅÔ∏è</span> Remote`;
                } else {
                    statusHtml = '<span class="status-icon status-missing" title="Not found">‚ùå</span> Missing';
                }

                // Eval badge
                const evalCount = ckpt.eval_count || 0;
                const evalClass = evalCount >= 5 ? 'many-evals' : evalCount > 0 ? 'has-evals' : '';
                const evalHtml = evalCount > 0
                    ? `<span class="eval-badge ${evalClass}">${evalCount}</span>`
                    : '<span class="eval-badge">0</span>';

                // Canonical name (shortened)
                const shortName = (ckpt.canonical_name || `checkpoint-${step}`)
                    .replace('checkpoint-', '')
                    .split('-').slice(0, 2).join('-');

                // Age
                const ageHtml = ckpt.age_hours != null
                    ? (ckpt.age_hours < 24 ? `${Math.round(ckpt.age_hours)}h` : `${Math.round(ckpt.age_hours / 24)}d`)
                    : '--';

                return `
                    <tr style="${isActive ? '' : 'opacity: 0.6;'}">
                        <td>
                            <div class="hero-cell">
                                <span class="hero-icon">${heroIcon}</span>
                                <span class="hero-name">${heroName}</span>
                            </div>
                        </td>
                        <td>
                            <a href="/checkpoint/${step}" class="step-link">#${shortName}</a>
                            ${isBest ? '<span class="best-badge">BEST</span>' : ''}
                        </td>
                        <td class="loss-value ${lossClass}">${loss?.toFixed(4) || '--'}</td>
                        <td>${statusHtml}</td>
                        <td>${evalHtml}</td>
                        <td class="timestamp">${ageHtml}</td>
                    </tr>
                `;
            }).join('');
        }

        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');

            if (totalPages > 1) {
                pagination.style.display = 'flex';
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                prevBtn.disabled = currentPage <= 1;
                nextBtn.disabled = currentPage >= totalPages;
            } else {
                pagination.style.display = 'none';
            }
        }

        function changePage(delta) {
            currentPage = Math.max(1, Math.min(totalPages, currentPage + delta));
            loadLedger();
        }

        // Update time display
        function updateTime() {
            const el = document.getElementById('timeDisplay');
            if (el) el.textContent = new Date().toLocaleTimeString();
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Initial load
        loadLedger();
    </script>
</body>
</html>
