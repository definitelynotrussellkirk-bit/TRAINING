<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quests - Realm of Training</title>
    <!-- Shared theme -->
    <link rel="stylesheet" href="/static/css/theme.css?v=1">
    <link rel="stylesheet" href="/static/css/game.css?v=3">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        .quests-main {
            display: grid;
            grid-template-columns: 240px 1fr 240px;
            gap: 1.5rem;
            padding: 1.5rem;
            height: calc(100vh - 120px);
            overflow: hidden;
        }

        /* Left Panel - Queue Summary */
        .queue-summary {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
        }

        /* Right Panel */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
        }

        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
        }

        .summary-card h3 {
            font-family: var(--font-display);
            color: var(--color-gold);
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .queue-counts {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .queue-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: var(--bg-dark);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .queue-row:hover {
            background: rgba(245, 158, 11, 0.1);
        }

        .queue-row.active {
            border: 1px solid var(--color-gold);
            background: rgba(245, 158, 11, 0.15);
        }

        .queue-row .label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .queue-row .priority-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .queue-row .priority-dot.high { background: #ef4444; }
        .queue-row .priority-dot.normal { background: #3b82f6; }
        .queue-row .priority-dot.low { background: #6b7280; }
        .queue-row .priority-dot.processing { background: #f59e0b; animation: pulse 1.5s infinite; }
        .queue-row .priority-dot.completed { background: #22c55e; }
        .queue-row .priority-dot.failed { background: #ef4444; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .queue-row .count {
            font-family: var(--font-mono);
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Current Quest */
        .current-quest {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(234, 88, 12, 0.1));
            border-color: var(--border-gold);
        }

        .current-quest-content {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .current-quest-name {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            color: var(--text-primary);
            word-break: break-all;
        }

        .current-quest-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: var(--bg-dark);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-gold);
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.75rem;
            color: var(--text-muted);
            min-width: 40px;
            text-align: right;
        }

        .idle-message {
            color: var(--text-muted);
            font-size: 0.85rem;
            text-align: center;
            padding: 1rem;
        }

        /* Right Panel - Quest List */
        .quest-list-panel {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .quest-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .quest-list-header h2 {
            font-family: var(--font-display);
            color: var(--color-gold);
            font-size: 1.25rem;
        }

        .quest-actions {
            display: flex;
            gap: 0.5rem;
        }

        .quest-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .quest-btn:hover {
            border-color: var(--color-gold);
            background: rgba(245, 158, 11, 0.1);
        }

        .quest-btn.primary {
            background: var(--color-gold);
            color: var(--bg-dark);
            border-color: var(--color-gold);
        }

        .quest-btn.primary:hover {
            filter: brightness(1.1);
        }

        /* Quest Table */
        .quest-table-container {
            flex: 1;
            overflow-y: auto;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }

        .quest-table {
            width: 100%;
            border-collapse: collapse;
        }

        .quest-table th {
            position: sticky;
            top: 0;
            background: var(--bg-panel);
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-color);
        }

        .quest-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .quest-table tr:hover {
            background: rgba(245, 158, 11, 0.05);
        }

        .quest-table tr.selected {
            background: rgba(245, 158, 11, 0.1);
        }

        .quest-name {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            color: var(--text-primary);
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .quest-priority {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.25rem 0.6rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .quest-priority.high {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .quest-priority.normal {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .quest-priority.low {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }

        .quest-size {
            font-family: var(--font-mono);
            color: var(--text-muted);
        }

        .quest-time {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .quest-status {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.25rem 0.6rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .quest-status.completed {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .quest-status.failed {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .quest-status.processing {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .quest-actions-cell {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            padding: 0.3rem 0.6rem;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .action-btn:hover {
            border-color: var(--color-gold);
            color: var(--text-primary);
        }

        .action-btn.danger:hover {
            border-color: #ef4444;
            color: #ef4444;
        }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .empty-state-hint {
            font-size: 0.85rem;
            opacity: 0.7;
        }

        /* Tabs */
        .quest-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .quest-tab {
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .quest-tab:hover {
            border-color: var(--border-gold);
        }

        .quest-tab.active {
            background: rgba(245, 158, 11, 0.15);
            border-color: var(--color-gold);
            color: var(--text-primary);
        }

        .quest-tab .badge {
            margin-left: 0.4rem;
            padding: 0.1rem 0.4rem;
            background: var(--bg-dark);
            border-radius: 10px;
            font-size: 0.7rem;
            font-family: var(--font-mono);
        }

        /* Refresh indicator */
        .refresh-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .refresh-indicator.loading::before {
            content: '';
            width: 12px;
            height: 12px;
            border: 2px solid var(--border-color);
            border-top-color: var(--color-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Data Forge */
        .forge-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1));
            border-color: rgba(139, 92, 246, 0.3);
        }

        .generator-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .generator-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: var(--bg-dark);
            border-radius: 6px;
            transition: all 0.2s;
        }

        .generator-row:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .generator-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        .generator-icon {
            font-size: 1rem;
        }

        .generator-name {
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .generator-status {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .generator-toggle {
            width: 36px;
            height: 20px;
            background: var(--bg-card);
            border-radius: 10px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
        }

        .generator-toggle::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: var(--text-muted);
            border-radius: 50%;
            top: 1px;
            left: 1px;
            transition: all 0.2s;
        }

        .generator-toggle.active {
            background: rgba(34, 197, 94, 0.3);
            border-color: #22c55e;
        }

        .generator-toggle.active::after {
            background: #22c55e;
            left: 17px;
        }

        .generator-stats {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-left: 0.5rem;
        }

        /* API Status */
        .api-status-section {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }

        .api-status-title {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .api-status-grid {
            display: flex;
            gap: 0.5rem;
        }

        .api-status-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.6rem;
            background: var(--bg-dark);
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .api-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .api-dot.online {
            background: #22c55e;
            box-shadow: 0 0 6px #22c55e;
        }

        .api-dot.offline {
            background: #ef4444;
        }

        .api-name {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Skill List with Toggles */
        .skill-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .skill-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.6rem;
            background: var(--bg-dark);
            border-radius: 6px;
        }

        .skill-name {
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.85rem;
        }

        .skill-port {
            color: var(--text-muted);
            font-size: 0.75rem;
            flex: 1;
        }

        /* Toggle Switch */
        .skill-toggle {
            position: relative;
            width: 36px;
            height: 20px;
        }

        .skill-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4b5563;
            transition: 0.2s;
            border-radius: 20px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.2s;
            border-radius: 50%;
        }

        .skill-toggle input:checked + .toggle-slider {
            background-color: #22c55e;
        }

        .skill-toggle input:checked + .toggle-slider:before {
            transform: translateX(16px);
        }

        /* Daemon Card */
        .daemon-card {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.1));
            border-color: rgba(34, 197, 94, 0.3);
        }

        .daemon-status {
            margin-bottom: 0.5rem;
        }

        .daemon-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .daemon-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #6b7280;
        }

        .daemon-dot.running {
            background: #22c55e;
            box-shadow: 0 0 8px #22c55e;
            animation: pulse 2s infinite;
        }

        .daemon-dot.stopped {
            background: #ef4444;
        }

        .daemon-dot.paused {
            background: #f59e0b;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .daemon-state {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .daemon-step {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .daemon-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.4rem;
        }

        .daemon-btn {
            padding: 0.35rem 0.5rem;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .daemon-btn.start {
            background: #22c55e;
            color: white;
        }

        .daemon-btn.start:hover {
            background: #16a34a;
        }

        .daemon-btn.pause {
            background: #f59e0b;
            color: white;
        }

        .daemon-btn.pause:hover {
            background: #d97706;
        }

        .daemon-btn.stop {
            background: #6b7280;
            color: white;
        }

        .daemon-btn.stop:hover {
            background: #4b5563;
        }

        .daemon-btn.kill {
            background: #ef4444;
            color: white;
        }

        .daemon-btn.kill:hover {
            background: #dc2626;
        }

        .daemon-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .api-port {
            color: var(--text-muted);
            font-family: var(--font-mono);
            font-size: 0.7rem;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .quests-main {
                grid-template-columns: 1fr;
            }
            .queue-summary {
                flex-direction: row;
                flex-wrap: wrap;
            }
            .summary-card {
                flex: 1;
                min-width: 200px;
            }
        }

        /* Preview Modal */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .preview-modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-gold);
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 40px rgba(245, 158, 11, 0.2);
        }

        .preview-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-panel);
            border-radius: 16px 16px 0 0;
        }

        .preview-modal-header h3 {
            font-family: var(--font-mono);
            font-size: 0.9rem;
            color: var(--color-gold);
            margin: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 60%;
        }

        .preview-counter {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            color: var(--text-muted);
            padding: 0.25rem 0.75rem;
            background: var(--bg-dark);
            border-radius: 12px;
        }

        .preview-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 0.5rem;
            transition: color 0.2s;
        }

        .preview-close:hover {
            color: var(--text-primary);
        }

        .preview-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .preview-section {
            background: var(--bg-dark);
            border-radius: 8px;
            overflow: hidden;
        }

        .preview-label {
            padding: 0.5rem 1rem;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .preview-content {
            padding: 1rem;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            color: var(--text-primary);
            max-height: 250px;
            overflow-y: auto;
        }

        .preview-modal-footer {
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            background: var(--bg-panel);
        }

        .preview-nav-btn, .preview-shuffle-btn {
            padding: 0.5rem 1.25rem;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preview-nav-btn:hover, .preview-shuffle-btn:hover {
            border-color: var(--color-gold);
            background: rgba(245, 158, 11, 0.1);
        }

        .preview-shuffle-btn {
            background: rgba(139, 92, 246, 0.15);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .preview-shuffle-btn:hover {
            background: rgba(139, 92, 246, 0.25);
            border-color: rgba(139, 92, 246, 0.5);
        }

        .preview-meta {
            padding: 0.75rem 1.5rem;
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bg-dark);
            border-radius: 0 0 16px 16px;
        }

        /* Clickable quest name */
        .quest-name.clickable {
            cursor: pointer;
            transition: color 0.2s;
        }

        .quest-name.clickable:hover {
            color: var(--color-gold);
        }
    </style>
</head>
<body>
    <!-- TITLE BAR -->
    <header class="game-header">
        <div class="header-left">
            <h1 class="game-title">Quest Board</h1>
        </div>
        <div class="header-center">
            <div class="resource-bar">
                <div class="resource">
                    <span class="resource-icon">üìú</span>
                    <span class="resource-label">QUEUED</span>
                    <span class="resource-value" id="totalQueued">--</span>
                </div>
                <div class="resource">
                    <span class="resource-icon">‚öîÔ∏è</span>
                    <span class="resource-label">ACTIVE</span>
                    <span class="resource-value" id="activeCount">--</span>
                </div>
                <div class="resource">
                    <span class="resource-icon">‚úì</span>
                    <span class="resource-label">COMPLETED</span>
                    <span class="resource-value" id="completedCount">--</span>
                </div>
            </div>
        </div>
        <div class="header-right">
            <div class="refresh-indicator" id="refreshIndicator">
                <span id="lastRefresh">--</span>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="quests-main">
        <!-- LEFT: Queue Summary -->
        <aside class="queue-summary">
            <!-- Current Quest -->
            <div class="summary-card current-quest">
                <h3>‚öîÔ∏è Active Quest</h3>
                <div id="currentQuestContent">
                    <div class="idle-message">No quest active</div>
                </div>
            </div>

            <!-- Skill APIs -->
            <div class="summary-card">
                <h3>üîå Skills</h3>
                <div class="skill-list">
                    <div class="skill-row" title="Syllacrostic puzzle generator">
                        <span class="api-dot" id="syApiDot"></span>
                        <span class="skill-name">SY</span>
                        <span class="skill-port">:8080</span>
                        <label class="skill-toggle">
                            <input type="checkbox" id="syEnabled" onchange="toggleSkill('sy', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="skill-row" title="Binary arithmetic generator">
                        <span class="api-dot" id="binApiDot"></span>
                        <span class="skill-name">BIN</span>
                        <span class="skill-port">:8090</span>
                        <label class="skill-toggle">
                            <input type="checkbox" id="binEnabled" onchange="toggleSkill('bin', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Training Daemon -->
            <div class="summary-card daemon-card">
                <h3>ü§ñ Daemon</h3>
                <div class="daemon-status">
                    <div class="daemon-indicator">
                        <span class="daemon-dot" id="daemonDot"></span>
                        <span class="daemon-state" id="daemonState">Checking...</span>
                    </div>
                    <div class="daemon-step" id="daemonStep"></div>
                </div>
                <div class="daemon-controls">
                    <button class="daemon-btn start" onclick="daemonControl('start')" id="btnStart">Start</button>
                    <button class="daemon-btn pause" onclick="daemonControl('pause')" id="btnPause">Pause</button>
                    <button class="daemon-btn stop" onclick="daemonControl('stop')" id="btnStop">Stop</button>
                    <button class="daemon-btn kill" onclick="daemonControl('kill')" id="btnKill">Kill</button>
                </div>
            </div>

            <!-- Queue Counts -->
            <div class="summary-card">
                <h3>üìã Queue</h3>
                <div class="queue-counts">
                    <div class="queue-row" data-filter="high" onclick="setFilter('high')">
                        <span class="label">
                            <span class="priority-dot high"></span>
                            High Priority
                        </span>
                        <span class="count" id="highCount">0</span>
                    </div>
                    <div class="queue-row active" data-filter="normal" onclick="setFilter('normal')">
                        <span class="label">
                            <span class="priority-dot normal"></span>
                            Normal
                        </span>
                        <span class="count" id="normalCount">0</span>
                    </div>
                    <div class="queue-row" data-filter="low" onclick="setFilter('low')">
                        <span class="label">
                            <span class="priority-dot low"></span>
                            Low Priority
                        </span>
                        <span class="count" id="lowCount">0</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- RIGHT: Quest List -->
        <section class="quest-list-panel">
            <div class="quest-list-header">
                <h2 id="listTitle">Normal Queue</h2>
                <div class="quest-actions">
                    <button class="quest-btn" onclick="refreshQuests()">Refresh</button>
                </div>
            </div>

            <div class="quest-table-container">
                <table class="quest-table">
                    <thead>
                        <tr>
                            <th>Quest Name</th>
                            <th>Priority</th>
                            <th>Size</th>
                            <th>Added</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="questTableBody">
                        <!-- Filled by JS -->
                    </tbody>
                </table>
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-state-icon">üìú</div>
                    <div class="empty-state-text">No quests in this queue</div>
                    <div class="empty-state-hint">Drop .jsonl files in the inbox folder to add quests</div>
                </div>
            </div>
        </section>

        <!-- RIGHT: History & Forge -->
        <aside class="right-panel">
            <!-- History -->
            <div class="summary-card">
                <h3>üìñ History</h3>
                <div class="queue-counts">
                    <div class="queue-row" data-filter="completed" onclick="setFilter('completed')">
                        <span class="label">
                            <span class="priority-dot completed"></span>
                            Completed
                        </span>
                        <span class="count" id="completedHistoryCount">0</span>
                    </div>
                    <div class="queue-row" data-filter="failed" onclick="setFilter('failed')">
                        <span class="label">
                            <span class="priority-dot failed"></span>
                            Failed
                        </span>
                        <span class="count" id="failedCount">0</span>
                    </div>
                </div>
            </div>

            <!-- Data Forge -->
            <div class="summary-card forge-card">
                <h3>üî• Data Forge</h3>
                <div class="generator-list" id="generatorList">
                    <!-- Filled by JS -->
                </div>
            </div>
        </aside>
    </main>

    <!-- NAVIGATION (dynamic) -->
    <nav class="game-nav" id="bottomNav"></nav>
    <script src="/static/js/nav.js"></script>
    <script src="/static/js/events.js"></script>
    <!-- Shared modules -->
    <script src="/static/js/formatters.js?v=1"></script>
    <script src="/static/js/training_client.js?v=1"></script>

    <script>
        // State
        let currentFilter = 'normal';
        let questData = null;
        let heroName = 'Hero';  // Default fallback

        // DOM helpers
        function $(sel) { return document.querySelector(sel); }
        function $$(sel) { return document.querySelectorAll(sel); }
        function setText(sel, text) { const el = $(sel); if (el) el.textContent = text; }

        // Load hero name
        async function loadHeroName() {
            try {
                const campResp = await fetch('/api/campaigns/active');
                if (campResp.ok) {
                    const campaign = await campResp.json();
                    if (campaign?.hero_id) {
                        const heroesResp = await fetch('/api/heroes');
                        if (heroesResp.ok) {
                            const heroes = await heroesResp.json();
                            const hero = heroes.find(h => h.id === campaign.hero_id);
                            if (hero?.name) {
                                heroName = hero.name;
                            }
                        }
                    }
                }
            } catch (err) {
                console.error('Failed to load hero name:', err);
            }
        }

        // Filter titles
        const filterTitles = {
            high: 'High Priority Queue',
            normal: 'Normal Queue',
            low: 'Low Priority Queue',
            completed: 'Recently Completed',
            failed: 'Failed Quests'
        };

        // Load quest data
        async function loadQuests() {
            $('#refreshIndicator').classList.add('loading');

            try {
                const response = await fetch('/api/quests');
                questData = await response.json();
                updateUI();
                $('#lastRefresh').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Failed to load quests:', error);
            } finally {
                $('#refreshIndicator').classList.remove('loading');
            }
        }

        function updateUI() {
            if (!questData) return;

            // Update counts
            setText('#totalQueued', questData.status?.queued?.total || 0);
            setText('#activeCount', questData.status?.processing || 0);
            setText('#completedCount', questData.status?.completed || 0);

            setText('#highCount', questData.status?.queued?.high || 0);
            setText('#normalCount', questData.status?.queued?.normal || 0);
            setText('#lowCount', questData.status?.queued?.low || 0);
            setText('#completedHistoryCount', questData.recently_completed?.length || 0);
            setText('#failedCount', questData.failed?.length || 0);

            // Update current quest
            updateCurrentQuest();

            // Update quest list
            updateQuestList();
        }

        function updateCurrentQuest() {
            const container = $('#currentQuestContent');
            const processing = questData.processing;

            if (processing && processing.length > 0) {
                const quest = processing[0];
                container.innerHTML = `
                    <div class="current-quest-content">
                        <div class="current-quest-name">${quest.file}</div>
                        <div class="current-quest-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${quest.progress || 0}%"></div>
                            </div>
                            <span class="progress-text">${quest.progress || 0}%</span>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `<div class="idle-message">No quest active - ${heroName} is resting</div>`;
            }
        }

        function updateQuestList() {
            const tbody = $('#questTableBody');
            const emptyState = $('#emptyState');

            // Get quests for current filter
            let quests = [];
            if (currentFilter === 'completed') {
                quests = questData.recently_completed || [];
            } else if (currentFilter === 'failed') {
                quests = questData.failed || [];
            } else {
                quests = (questData.queued || []).filter(q => q.priority === currentFilter);
            }

            // Update title
            setText('#listTitle', filterTitles[currentFilter]);

            if (quests.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'flex';
                return;
            }

            emptyState.style.display = 'none';

            // Render table rows
            tbody.innerHTML = quests.map(quest => {
                const isHistory = currentFilter === 'completed' || currentFilter === 'failed';

                return `
                    <tr>
                        <td class="quest-name clickable" title="Click to preview: ${quest.file}" onclick="openPreview('${quest.file}')">${quest.file}</td>
                        <td>
                            <span class="quest-priority ${quest.priority || currentFilter}">
                                <span class="priority-dot ${quest.priority || currentFilter}"></span>
                                ${(quest.priority || currentFilter).toUpperCase()}
                            </span>
                        </td>
                        <td class="quest-size">${formatSize(quest.size_mb)}</td>
                        <td class="quest-time">${formatTime(quest.added_at || quest.completed_at || quest.failed_at)}</td>
                        <td class="quest-actions-cell">
                            ${isHistory ? `
                                ${currentFilter === 'failed' ? `
                                    <button class="action-btn" onclick="retryQuest('${quest.file}')" title="Retry">‚Üª</button>
                                ` : ''}
                            ` : `
                                ${quest.priority !== 'high' ? `
                                    <button class="action-btn" onclick="changePriority('${quest.file}', 'high')" title="Boost priority">‚¨Ü</button>
                                ` : ''}
                                ${quest.priority !== 'low' ? `
                                    <button class="action-btn" onclick="changePriority('${quest.file}', 'low')" title="Lower priority">‚¨á</button>
                                ` : ''}
                                <button class="action-btn danger" onclick="deleteQuest('${quest.file}')" title="Delete">‚úï</button>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function setFilter(filter) {
            currentFilter = filter;

            // Update active state
            $$('.queue-row').forEach(row => {
                row.classList.toggle('active', row.dataset.filter === filter);
            });

            updateQuestList();
        }

        // Use shared Format module for formatting
        function formatSize(sizeMb) {
            return Format.size(sizeMb);
        }

        function formatTime(isoString) {
            if (!isoString) return '--';
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        async function changePriority(filename, newPriority) {
            try {
                const response = await fetch('/api/quests/priority', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename, priority: newPriority })
                });
                const result = await response.json();

                if (result.success) {
                    loadQuests();  // Refresh
                } else {
                    alert(result.error || 'Failed to change priority');
                }
            } catch (error) {
                alert('Error changing priority');
            }
        }

        async function deleteQuest(filename) {
            if (!confirm(`Delete quest "${filename}"?`)) return;

            try {
                const response = await fetch('/api/quests/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename })
                });
                const result = await response.json();

                if (result.success) {
                    loadQuests();  // Refresh
                } else {
                    alert(result.error || 'Failed to delete quest');
                }
            } catch (error) {
                alert('Error deleting quest');
            }
        }

        async function retryQuest(filename) {
            try {
                const response = await fetch('/api/quests/retry', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename })
                });
                const result = await response.json();

                if (result.success) {
                    loadQuests();  // Refresh
                } else {
                    alert(result.error || 'Failed to retry quest');
                }
            } catch (error) {
                alert('Error retrying quest');
            }
        }

        function refreshQuests() {
            loadQuests();
        }

        // ==========================================
        // DATA FORGE - Generator Controls
        // ==========================================

        const generators = [
            {
                id: 'auto_generate',
                name: 'Skill Training',
                icon: 'üéØ',
                tooltip: 'Generates training data when queue is low. The "hands" that produce examples.'
            },
            {
                id: 'curriculum',
                name: 'Curriculum',
                icon: 'üìö',
                tooltip: 'Controls skill level progression. The "brain" that decides difficulty.'
            },
            {
                id: 'self_correction',
                name: 'Self-Correction',
                icon: 'üîÑ',
                tooltip: 'Captures model errors and generates correction training data.'
            },
            {
                id: 'discrimination',
                name: 'Discrimination',
                icon: '‚öñÔ∏è',
                tooltip: 'Generates CORRECT/INCORRECT verification training (always on).'
            },
        ];

        let generatorStatus = {};

        async function loadGeneratorStatus() {
            try {
                const response = await fetch('/api/generators');
                generatorStatus = await response.json();
                renderGenerators();
            } catch (error) {
                console.error('Failed to load generator status:', error);
            }
        }

        function renderGenerators() {
            const container = $('#generatorList');
            if (!container) return;

            container.innerHTML = generators.map(gen => {
                const status = generatorStatus[gen.id] || {};
                const enabled = status.enabled ?? false;
                const lastRun = status.last_run ? formatTime(status.last_run) : 'Never';

                return `
                    <div class="generator-row" title="${gen.tooltip}">
                        <div class="generator-info">
                            <span class="generator-icon">${gen.icon}</span>
                            <div>
                                <div class="generator-name">${gen.name}</div>
                                <div class="generator-status">Last: ${lastRun}</div>
                            </div>
                        </div>
                        <div class="generator-toggle ${enabled ? 'active' : ''}"
                             onclick="toggleGenerator('${gen.id}', ${!enabled})"></div>
                    </div>
                `;
            }).join('');
        }

        async function toggleGenerator(generatorId, enable) {
            try {
                const response = await fetch('/api/generators/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ generator: generatorId, enabled: enable })
                });
                const result = await response.json();

                if (result.success) {
                    // Update local state immediately for responsiveness
                    if (generatorStatus[generatorId]) {
                        generatorStatus[generatorId].enabled = enable;
                    } else {
                        generatorStatus[generatorId] = { enabled: enable };
                    }
                    renderGenerators();
                } else {
                    alert(result.error || 'Failed to toggle generator');
                }
            } catch (error) {
                alert('Error toggling generator');
            }
        }

        // ==========================================
        // SKILL API STATUS
        // ==========================================

        async function checkApiStatus() {
            try {
                const response = await fetch('/api/skill-apis/status');
                const status = await response.json();

                // Update SY API dot
                const syDot = $('#syApiDot');
                if (syDot) {
                    syDot.classList.toggle('online', status.sy?.online);
                    syDot.classList.toggle('offline', !status.sy?.online);
                }

                // Update BIN API dot
                const binDot = $('#binApiDot');
                if (binDot) {
                    binDot.classList.toggle('online', status.bin?.online);
                    binDot.classList.toggle('offline', !status.bin?.online);
                }
            } catch (error) {
                console.error('Failed to check API status:', error);
            }
        }

        // Load skill enabled status from scheduler
        async function loadSkillStatus() {
            try {
                const response = await fetch('/api/scheduler');
                const data = await response.json();

                if (data.skills && Array.isArray(data.skills)) {
                    // Skills are in array format [{id: 'sy', enabled: true}, ...]
                    data.skills.forEach(skill => {
                        const checkbox = $(`#${skill.id}Enabled`);
                        if (checkbox) {
                            checkbox.checked = skill.enabled !== false;
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to load skill status:', error);
            }
        }

        // Toggle skill enabled/disabled
        async function toggleSkill(skillId, enabled) {
            try {
                const response = await fetch('/api/scheduler/skill/' + skillId, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: enabled })
                });

                if (!response.ok) {
                    throw new Error('Failed to toggle skill');
                }

                console.log(`Skill ${skillId} ${enabled ? 'enabled' : 'disabled'}`);
            } catch (error) {
                console.error('Failed to toggle skill:', error);
                // Revert checkbox on error
                const checkbox = $(`#${skillId}Enabled`);
                if (checkbox) checkbox.checked = !enabled;
            }
        }

        // ==========================================
        // DAEMON STATUS & CONTROL
        // ==========================================

        async function loadDaemonStatus() {
            try {
                const response = await fetch('/api/daemon/status');
                const data = await response.json();

                const dot = $('#daemonDot');
                const state = $('#daemonState');
                const step = $('#daemonStep');

                // Update dot state
                dot.classList.remove('running', 'stopped', 'paused');

                if (data.daemon_running) {
                    if (data.signals?.pause) {
                        dot.classList.add('paused');
                        state.textContent = 'Paused';
                    } else {
                        dot.classList.add('running');
                        state.textContent = data.training_status === 'training' ? 'Training' : 'Running';
                    }
                } else {
                    dot.classList.add('stopped');
                    state.textContent = 'Stopped';
                }

                // Update step info
                if (data.current_step) {
                    step.textContent = `Step ${data.current_step.toLocaleString()}`;
                } else {
                    step.textContent = '';
                }

                // Update button states
                $('#btnStart').disabled = data.daemon_running;
                $('#btnPause').disabled = !data.daemon_running || data.signals?.pause;
                $('#btnStop').disabled = !data.daemon_running;
                $('#btnKill').disabled = !data.daemon_running;

            } catch (error) {
                console.error('Failed to load daemon status:', error);
                $('#daemonState').textContent = 'Error';
            }
        }

        async function daemonControl(action) {
            try {
                // Use TrainingClient for API abstraction
                const data = await TrainingClient.controlTraining(action);
                console.log(`Daemon ${action}: ${data.message}`);
                // Refresh status after a short delay
                setTimeout(loadDaemonStatus, 1000);
            } catch (error) {
                console.error('Failed to control daemon:', error);
                alert(`Failed: ${error.message}`);
            }
        }

        // Initialize
        loadHeroName();
        loadQuests();
        loadGeneratorStatus();
        checkApiStatus();
        loadSkillStatus();
        loadDaemonStatus();

        // Auto-refresh
        setInterval(loadQuests, 10000);
        setInterval(loadGeneratorStatus, 30000);
        setInterval(checkApiStatus, 15000);
        setInterval(loadDaemonStatus, 5000);  // Check daemon every 5s

        // ==========================================
        // FILE PREVIEW
        // ==========================================

        let previewData = null;
        let previewIndex = 0;
        let previewRotationInterval = null;

        async function openPreview(filename) {
            const modal = document.getElementById('previewModal');
            if (!modal) return;

            // Show modal with loading state
            modal.style.display = 'flex';
            document.getElementById('previewFileName').textContent = filename;
            document.getElementById('previewCounter').textContent = 'Loading...';
            document.getElementById('previewPrompt').textContent = 'Loading examples...';
            document.getElementById('previewResponse').textContent = '';
            document.getElementById('previewTotalExamples').textContent = '-- examples';
            document.getElementById('previewFormat').textContent = '--';

            try {
                const response = await fetch(`/api/quests/preview/${encodeURIComponent(filename)}?count=10`);
                const data = await response.json();

                if (data.error) {
                    document.getElementById('previewPrompt').textContent = `Error: ${data.error}`;
                    document.getElementById('previewResponse').textContent = '';
                    return;
                }

                previewData = data;
                previewIndex = 0;

                document.getElementById('previewTotalExamples').textContent = `${data.total_examples.toLocaleString()} examples`;
                displayPreviewItem();

                // Start auto-rotation every 5 seconds
                startPreviewRotation();

            } catch (error) {
                document.getElementById('previewPrompt').textContent = `Fetch error: ${error.message}`;
                document.getElementById('previewResponse').textContent = '';
            }
        }

        function displayPreviewItem() {
            if (!previewData || !previewData.previews || previewData.previews.length === 0) return;

            const item = previewData.previews[previewIndex];
            document.getElementById('previewCounter').textContent = `${previewIndex + 1}/${previewData.previews.length}`;
            document.getElementById('previewPrompt').textContent = item.prompt || '(no prompt)';
            document.getElementById('previewResponse').textContent = item.response || '(no response)';
            document.getElementById('previewFormat').textContent = item.format || 'unknown';
        }

        function nextPreview() {
            if (!previewData || !previewData.previews) return;
            previewIndex = (previewIndex + 1) % previewData.previews.length;
            displayPreviewItem();
            restartPreviewRotation();
        }

        function prevPreview() {
            if (!previewData || !previewData.previews) return;
            previewIndex = (previewIndex - 1 + previewData.previews.length) % previewData.previews.length;
            displayPreviewItem();
            restartPreviewRotation();
        }

        async function shufflePreview() {
            if (!previewData) return;
            const filename = previewData.filename;
            await openPreview(filename);
        }

        function startPreviewRotation() {
            stopPreviewRotation();
            previewRotationInterval = setInterval(() => {
                if (previewData && previewData.previews && previewData.previews.length > 1) {
                    previewIndex = (previewIndex + 1) % previewData.previews.length;
                    displayPreviewItem();
                }
            }, 5000);
        }

        function stopPreviewRotation() {
            if (previewRotationInterval) {
                clearInterval(previewRotationInterval);
                previewRotationInterval = null;
            }
        }

        function restartPreviewRotation() {
            startPreviewRotation();
        }

        function closePreview() {
            const modal = document.getElementById('previewModal');
            if (modal) {
                modal.style.display = 'none';
            }
            stopPreviewRotation();
            previewData = null;
            previewIndex = 0;
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePreview();
            }
            // Arrow key navigation when modal is open
            const modal = document.getElementById('previewModal');
            if (modal && modal.style.display !== 'none') {
                if (e.key === 'ArrowRight') nextPreview();
                if (e.key === 'ArrowLeft') prevPreview();
            }
        });

        // Close modal when clicking outside content
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('previewModal');
            if (e.target === modal) {
                closePreview();
            }
        });
    </script>

    <!-- File Preview Modal -->
    <div id="previewModal" class="preview-modal">
        <div class="preview-modal-content">
            <div class="preview-modal-header">
                <h3 id="previewFileName">Loading...</h3>
                <span id="previewCounter" class="preview-counter">1/5</span>
                <button class="preview-close" onclick="closePreview()">&times;</button>
            </div>
            <div class="preview-modal-body">
                <div class="preview-section">
                    <div class="preview-label">üìù Prompt</div>
                    <div class="preview-content" id="previewPrompt">Loading...</div>
                </div>
                <div class="preview-section">
                    <div class="preview-label">‚úÖ Golden Answer</div>
                    <div class="preview-content" id="previewResponse">Loading...</div>
                </div>
            </div>
            <div class="preview-modal-footer">
                <button onclick="prevPreview()" class="preview-nav-btn">‚óÄ Prev</button>
                <button onclick="shufflePreview()" class="preview-shuffle-btn">üîÄ Shuffle</button>
                <button onclick="nextPreview()" class="preview-nav-btn">Next ‚ñ∂</button>
            </div>
            <div class="preview-meta">
                <span id="previewTotalExamples">-- examples</span> ‚Ä¢
                <span id="previewFormat">--</span>
            </div>
        </div>
    </div>
</body>
</html>
