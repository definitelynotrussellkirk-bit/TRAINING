<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Realm of Training</title>
    <!-- Shared styles -->
    <link rel="stylesheet" href="/static/css/theme.css?v=1">
    <link rel="stylesheet" href="/static/css/forms.css?v=1">
    <link rel="stylesheet" href="/static/css/game.css?v=3">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* 3-Pane Layout */
        .settings-layout {
            display: grid;
            grid-template-columns: 200px 1fr 280px;
            gap: var(--space-lg);
            padding: var(--space-lg);
            height: calc(100vh - 120px);
            overflow: hidden;
        }

        /* Left: Category Nav */
        .settings-nav {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .settings-nav__title {
            font-family: var(--font-title);
            font-size: 1.25rem;
            color: var(--color-gold);
            margin-bottom: var(--space-xs);
        }

        .settings-nav__subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: var(--space-md);
        }

        .settings-nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            background: transparent;
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
        }

        .settings-nav-item:hover {
            background: var(--bg-surface);
            border-color: var(--border-color);
        }

        .settings-nav-item.active {
            background: var(--bg-surface);
            border-color: var(--color-gold);
            color: var(--text-primary);
        }

        .settings-nav-item.danger {
            color: var(--color-danger);
        }

        .settings-nav-item.danger:hover,
        .settings-nav-item.danger.active {
            border-color: var(--color-danger);
        }

        /* Middle: Form Content */
        .settings-main {
            overflow-y: auto;
            padding-right: var(--space-sm);
        }

        .settings-section {
            display: none;
        }

        .settings-section.active {
            display: block;
        }

        .settings-section__header {
            margin-bottom: var(--space-lg);
        }

        .settings-section__title {
            font-family: var(--font-title);
            font-size: 1.5rem;
            color: var(--color-gold);
            margin-bottom: var(--space-xs);
        }

        .settings-section__desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Right: Summary Panel */
        .settings-summary {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            overflow-y: auto;
        }

        .summary-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
        }

        .summary-card__title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-sm);
        }

        .summary-config {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            background: var(--bg-dark);
            border-radius: var(--radius-sm);
            padding: var(--space-sm);
            max-height: 200px;
            overflow: auto;
            white-space: pre-wrap;
            color: var(--text-secondary);
        }

        .summary-actions {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .summary-actions .btn {
            width: 100%;
            justify-content: center;
        }

        .summary-status {
            font-size: 0.8rem;
            text-align: center;
            padding: var(--space-xs);
        }

        /* VRAM Calculator */
        .vram-calculator {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
        }

        .vram-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
        }

        .vram-header h4 {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .vram-total {
            font-size: 1.25rem;
            font-weight: 700;
            font-family: var(--font-mono);
        }

        .vram-total.safe { color: var(--color-success); }
        .vram-total.warning { color: var(--color-warning); }
        .vram-total.danger { color: var(--color-danger); }

        .vram-bar-container {
            background: var(--bg-dark);
            border-radius: var(--radius-sm);
            height: 20px;
            overflow: hidden;
            margin-bottom: var(--space-sm);
            position: relative;
        }

        .vram-bar {
            height: 100%;
            display: flex;
        }

        .vram-segment { height: 100%; transition: width 0.3s ease; }
        .vram-segment.model { background: #3B82F6; }
        .vram-segment.optimizer { background: #8B5CF6; }
        .vram-segment.gradients { background: #EC4899; }
        .vram-segment.activations { background: #F59E0B; }

        .vram-limit {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--color-danger);
        }

        .vram-breakdown {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-xs);
            font-size: 0.75rem;
        }

        .vram-item {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .vram-dot {
            width: 8px;
            height: 8px;
            border-radius: 2px;
        }

        .vram-dot.model { background: #3B82F6; }
        .vram-dot.optimizer { background: #8B5CF6; }
        .vram-dot.gradients { background: #EC4899; }
        .vram-dot.activations { background: #F59E0B; }

        .vram-gpu-select {
            display: flex;
            gap: var(--space-xs);
            margin-top: var(--space-sm);
            flex-wrap: wrap;
        }

        .vram-gpu-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            cursor: pointer;
        }

        .vram-gpu-btn:hover { border-color: var(--color-gold); }
        .vram-gpu-btn.active {
            background: rgba(245, 158, 11, 0.2);
            border-color: var(--color-gold);
            color: var(--text-primary);
        }

        .vram-tip {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: var(--space-sm);
            padding: var(--space-xs);
            background: var(--bg-dark);
            border-radius: var(--radius-sm);
        }

        .vram-tip strong { color: var(--color-gold); }

        /* Skill Config Cards */
        .skill-configs {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .skill-config-card {
            display: grid;
            grid-template-columns: 40px 1fr repeat(2, 80px);
            gap: var(--space-md);
            align-items: center;
            padding: var(--space-md);
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
        }

        .skill-config-card.disabled { opacity: 0.5; }

        .skill-info .skill-name {
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .skill-info .skill-level {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .skill-info .mastered { color: var(--color-success); }

        .skill-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .skill-input-group label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .skill-input-group input {
            padding: 0.3rem 0.4rem;
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.8rem;
            width: 100%;
        }

        /* Strategy Grid */
        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-sm);
        }

        .strategy-card {
            padding: var(--space-md);
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .strategy-card:hover { border-color: var(--color-gold); }
        .strategy-card.selected {
            border-color: var(--color-gold);
            background: rgba(245, 158, 11, 0.2);
        }

        .strategy-card .strategy-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.15rem;
        }

        .strategy-card .strategy-desc {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Next Decision Preview */
        .next-decision {
            padding: var(--space-md);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(59, 130, 246, 0.15));
            border-radius: var(--radius-md);
            text-align: center;
            border: 1px solid var(--border-gold);
        }

        .next-decision__label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .next-decision__value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-gold);
            font-family: var(--font-title);
            margin: var(--space-xs) 0;
        }

        .next-decision__reason {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        @media (max-width: 1200px) {
            .settings-layout {
                grid-template-columns: 180px 1fr 240px;
            }
        }

        @media (max-width: 900px) {
            .settings-layout {
                grid-template-columns: 1fr;
                height: auto;
            }
            .settings-nav {
                flex-direction: row;
                flex-wrap: wrap;
                gap: var(--space-xs);
            }
            .settings-nav__title,
            .settings-nav__subtitle {
                display: none;
            }
            .settings-summary {
                order: -1;
            }
            .strategy-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- TITLE BAR -->
    <header class="game-header">
        <div class="header-left">
            <h1 class="game-title">Settings</h1>
        </div>
        <div class="header-center">
            <div class="resource-bar">
                <div class="resource">
                    <span class="resource-icon">‚öôÔ∏è</span>
                    <span class="resource-label">CONFIG</span>
                    <span class="resource-value" id="configStatus">Loading</span>
                </div>
            </div>
        </div>
        <div class="header-right">
            <div class="time-display" id="timeDisplay">--:--:--</div>
        </div>
    </header>

    <!-- 3-PANE LAYOUT -->
    <div class="settings-layout">
        <!-- LEFT: CATEGORY NAV -->
        <aside class="settings-nav">
            <h2 class="settings-nav__title">Settings</h2>
            <p class="settings-nav__subtitle">Configure training behavior</p>

            <button class="settings-nav-item active" data-section="training">
                üéØ Training
            </button>
            <button class="settings-nav-item" data-section="data">
                üîÑ Data & Skills
            </button>
            <button class="settings-nav-item" data-section="scheduler">
                üìö Scheduler
            </button>
            <button class="settings-nav-item" data-section="remote">
                üåê Remote Eval
            </button>
            <button class="settings-nav-item" data-section="model">
                ü§ñ Model Info
            </button>
            <button class="settings-nav-item danger" data-section="danger">
                ‚ö†Ô∏è Danger Zone
            </button>
        </aside>

        <!-- MIDDLE: FORM CONTENT -->
        <main class="settings-main">
            <!-- TRAINING SECTION -->
            <section class="settings-section active" data-section="training">
                <div class="settings-section__header">
                    <h2 class="settings-section__title">Training Configuration</h2>
                    <p class="settings-section__desc">Core hyperparameters and logging settings.</p>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Hyperparameters</div>
                    <div class="form-section__subtitle">These affect training speed, stability, and VRAM usage.</div>

                    <div class="form-row">
                        <div class="form-row__label">Batch Size<small>Samples per step</small></div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="batch_size" min="1" max="32" value="1">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Gradient Accum<small>Effective batch = batch √ó accum</small></div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="gradient_accumulation" min="1" max="128" value="16">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Learning Rate<small>Optimizer step size</small></div>
                        <div class="form-row__value">
                            <input type="text" class="form-input form-input--number" id="learning_rate" value="0.0004">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Precision<small>Floating point format</small></div>
                        <div class="form-row__value">
                            <select class="form-select" id="fp_precision">
                                <option value="bf16">bf16 (Brain Float)</option>
                                <option value="fp16">fp16 (Half)</option>
                                <option value="fp32">fp32 (Full)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Max Length<small>Maximum sequence length</small></div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="max_length" min="512" max="8192" value="2048">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Gradient Checkpoint<small>Trade compute for memory</small></div>
                        <div class="form-row__value">
                            <div class="form-toggle" id="use_gradient_checkpointing"></div>
                        </div>
                    </div>
                </div>

                <!-- VRAM Calculator -->
                <div class="vram-calculator">
                    <div class="vram-header">
                        <h4>üìä Estimated VRAM</h4>
                        <div class="vram-total" id="vramTotal">-- GB</div>
                    </div>

                    <div class="vram-bar-container">
                        <div class="vram-bar">
                            <div class="vram-segment model" id="vramModel"></div>
                            <div class="vram-segment optimizer" id="vramOptimizer"></div>
                            <div class="vram-segment gradients" id="vramGradients"></div>
                            <div class="vram-segment activations" id="vramActivations"></div>
                        </div>
                        <div class="vram-limit" id="vramLimit" style="left: 100%;"></div>
                    </div>

                    <div class="vram-breakdown">
                        <div class="vram-item">
                            <div class="vram-dot model"></div>
                            <span>Model</span>
                            <span id="vramModelVal">--</span>
                        </div>
                        <div class="vram-item">
                            <div class="vram-dot optimizer"></div>
                            <span>Optimizer</span>
                            <span id="vramOptimizerVal">--</span>
                        </div>
                        <div class="vram-item">
                            <div class="vram-dot gradients"></div>
                            <span>Gradients</span>
                            <span id="vramGradientsVal">--</span>
                        </div>
                        <div class="vram-item">
                            <div class="vram-dot activations"></div>
                            <span>Activations</span>
                            <span id="vramActivationsVal">--</span>
                        </div>
                    </div>

                    <div class="vram-gpu-select">
                        <button class="vram-gpu-btn active" data-vram="24">RTX 4090</button>
                        <button class="vram-gpu-btn" data-vram="24">RTX 3090</button>
                        <button class="vram-gpu-btn" data-vram="16">RTX 4080</button>
                        <button class="vram-gpu-btn" data-vram="12">RTX 4070</button>
                    </div>

                    <div class="vram-tip" id="vramTip"></div>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Logging & Checkpoints</div>

                    <div class="form-row">
                        <div class="form-row__label">Log Steps</div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="log_steps" min="10" max="1000" value="200">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Eval Steps</div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="eval_steps" min="100" max="5000" value="500">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Save Steps</div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="save_steps" min="500" max="10000" value="1000">
                        </div>
                    </div>
                </div>
            </section>

            <!-- DATA & SKILLS SECTION -->
            <section class="settings-section" data-section="data">
                <div class="settings-section__header">
                    <h2 class="settings-section__title">Data & Skills</h2>
                    <p class="settings-section__desc">Configure data generation and skill training.</p>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Auto-Generate</div>
                    <div class="form-section__subtitle">Automatically generate training data when queue runs low.</div>

                    <div class="form-row">
                        <div class="form-row__label">Enabled</div>
                        <div class="form-row__value">
                            <div class="form-toggle" id="auto_generate_enabled"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Batch Count<small>Examples per generation</small></div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="auto_generate_count" min="10" max="1000" value="100">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Min Queue Depth<small>Trigger threshold</small></div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="auto_generate_min_queue" min="1" max="10" value="2">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Cooldown (sec)</div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="auto_generate_cooldown" min="60" max="3600" value="180">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Self-Correction</div>
                    <div class="form-section__subtitle">Generate corrections from model mistakes.</div>

                    <div class="form-row">
                        <div class="form-row__label">Enabled</div>
                        <div class="form-row__value">
                            <div class="form-toggle" id="self_correction_enabled"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Auto Queue</div>
                        <div class="form-row__value">
                            <div class="form-toggle" id="self_correction_auto_queue"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Max Examples</div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="self_correction_max" min="10" max="1000" value="200">
                        </div>
                    </div>
                </div>
            </section>

            <!-- SCHEDULER SECTION -->
            <section class="settings-section" data-section="scheduler">
                <div class="settings-section__header">
                    <h2 class="settings-section__title">Curriculum Scheduler</h2>
                    <p class="settings-section__desc">Control skill progression and training order.</p>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Quick Presets</div>
                    <div class="preset-grid" id="schedulerPresets">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Next Training Batch</div>
                    <div class="next-decision" id="nextDecisionBox">
                        <div class="next-decision__label">If queue is empty, will generate:</div>
                        <div class="next-decision__value" id="nextDecisionValue">Loading...</div>
                        <div class="next-decision__reason" id="nextDecisionReason"></div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Scheduling Strategy</div>
                    <div class="strategy-grid" id="strategyGrid">
                        <div class="strategy-card" data-strategy="equal">
                            <div class="strategy-name">Equal</div>
                            <div class="strategy-desc">Alternate between skills</div>
                        </div>
                        <div class="strategy-card" data-strategy="focus">
                            <div class="strategy-name">Focus</div>
                            <div class="strategy-desc">Complete one skill first</div>
                        </div>
                        <div class="strategy-card" data-strategy="weighted">
                            <div class="strategy-name">Weighted</div>
                            <div class="strategy-desc">Train by ratio</div>
                        </div>
                        <div class="strategy-card" data-strategy="lowest_first">
                            <div class="strategy-name">Catch Up</div>
                            <div class="strategy-desc">Focus on lowest level</div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Skill Configuration</div>
                    <div class="skill-configs" id="skillConfigs">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Progression</div>

                    <div class="form-row">
                        <div class="form-row__label">Auto-Progression</div>
                        <div class="form-row__value">
                            <div class="form-toggle" id="curriculum_enabled"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Target Accuracy<small>Required to level up</small></div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="curriculum_target" min="0.5" max="1.0" step="0.05" value="0.80">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Advancement Evals<small>Consecutive passes needed</small></div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="advancement_evals" min="1" max="10" value="3">
                        </div>
                    </div>
                </div>
            </section>

            <!-- REMOTE EVAL SECTION -->
            <section class="settings-section" data-section="remote">
                <div class="settings-section__header">
                    <h2 class="settings-section__title">Remote Evaluation</h2>
                    <p class="settings-section__desc">Configure the RTX 3090 inference server for evaluation.</p>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Connection</div>

                    <div class="form-row">
                        <div class="form-row__label">Enabled</div>
                        <div class="form-row__value">
                            <div class="form-toggle" id="remote_enabled"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Host</div>
                        <div class="form-row__value">
                            <input type="text" class="form-input" id="remote_host" placeholder="Loading...">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Port</div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="remote_port" min="1" max="65535" value="8765">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Eval Interval<small>Steps between remote evals</small></div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="remote_interval" min="1000" max="50000" value="5000">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Sync Checkpoints</div>
                        <div class="form-row__value">
                            <div class="form-toggle" id="remote_sync"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- MODEL INFO SECTION -->
            <section class="settings-section" data-section="model">
                <div class="settings-section__header">
                    <h2 class="settings-section__title">Model Information</h2>
                    <p class="settings-section__desc">Locked configuration that cannot be changed mid-training.</p>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Locked Configuration</div>
                    <div class="form-section__subtitle">Changing these requires restarting training from scratch.</div>

                    <div class="form-row">
                        <div class="form-row__label">Base Model</div>
                        <div class="form-row__value">
                            <span class="form-value form-value--muted" id="locked_base_model">--</span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Architecture</div>
                        <div class="form-row__value">
                            <span class="form-value form-value--muted" id="locked_architecture">--</span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Max Context</div>
                        <div class="form-row__value">
                            <span class="form-value form-value--muted" id="locked_context">--</span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Vocab Size</div>
                        <div class="form-row__value">
                            <span class="form-value form-value--muted" id="locked_vocab">--</span>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Paths</div>

                    <div class="form-row">
                        <div class="form-row__label">Model Path</div>
                        <div class="form-row__value">
                            <span class="form-value" id="path_model" style="font-size: 0.75rem; word-break: break-all;">--</span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Current Model Dir</div>
                        <div class="form-row__value">
                            <span class="form-value" id="path_current" style="font-size: 0.75rem; word-break: break-all;">--</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- DANGER ZONE SECTION -->
            <section class="settings-section" data-section="danger">
                <div class="settings-section__header">
                    <h2 class="settings-section__title" style="color: var(--color-danger);">Danger Zone</h2>
                    <p class="settings-section__desc">Destructive operations. Be careful!</p>
                </div>

                <div class="form-section form-section--danger">
                    <div class="form-section__title">Reset Settings</div>
                    <div class="form-section__subtitle">Restore config from saved defaults. Current settings will be backed up.</div>
                    <div class="form-actions">
                        <button class="btn btn--danger" id="btn-restore-defaults">Restore Defaults</button>
                    </div>
                </div>

                <div class="form-section form-section--danger">
                    <div class="form-section__title">Raw Configuration</div>
                    <div class="form-section__subtitle">Full config.json content (read-only)</div>
                    <pre class="config-preview" id="rawConfig">Loading...</pre>
                </div>
            </section>
        </main>

        <!-- RIGHT: SUMMARY PANEL -->
        <aside class="settings-summary">
            <div class="summary-card">
                <div class="summary-card__title">Effective Config</div>
                <pre class="summary-config" id="effectiveConfig">{}</pre>
            </div>

            <div class="summary-card">
                <div class="summary-card__title">Actions</div>
                <div class="summary-actions">
                    <button class="btn btn--primary" id="btn-save" disabled>Save Changes</button>
                    <button class="btn" id="btn-reset" disabled>Discard Changes</button>
                    <button class="btn" id="btn-save-default">Save as Default</button>
                </div>
                <div class="summary-status" id="saveStatus"></div>
            </div>

            <div class="summary-card">
                <div class="summary-card__title">Quick Tips</div>
                <div style="font-size: 0.75rem; color: var(--text-muted); line-height: 1.4;">
                    <p style="margin-bottom: 0.5rem;">‚Ä¢ Batch size √ó Grad Accum = Effective batch</p>
                    <p style="margin-bottom: 0.5rem;">‚Ä¢ Lower LR for stability, higher for speed</p>
                    <p>‚Ä¢ Enable gradient checkpointing to save VRAM</p>
                </div>
            </div>
        </aside>
    </div>

    <!-- NAVIGATION (dynamic) -->
    <nav class="game-nav" id="bottomNav"></nav>
    <script src="/static/js/nav.js"></script>
    <script src="/static/js/events.js"></script>
    <!-- Shared modules -->
    <script src="/static/js/formatters.js?v=1"></script>
    <script src="/static/js/settings_client.js?v=1"></script>

    <script>
        // ============================================
        // SETTINGS PAGE - Clean Rewrite
        // ============================================

        let originalConfig = null;
        let currentConfig = null;
        let hasChanges = false;
        let schedulerStatus = null;

        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => document.querySelectorAll(sel);
        const setText = (sel, text) => { const el = $(sel); if (el) el.textContent = text; };

        // ============================================
        // SECTION NAVIGATION
        // ============================================

        $$('.settings-nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.dataset.section;

                // Update nav
                $$('.settings-nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                // Update content
                $$('.settings-section').forEach(s => {
                    s.classList.toggle('active', s.dataset.section === section);
                });
            });
        });

        // ============================================
        // TOGGLE SWITCHES
        // ============================================

        $$('.form-toggle').forEach(toggle => {
            toggle.addEventListener('click', () => {
                toggle.classList.toggle('active');
                checkForChanges();

                // VRAM recalc if gradient checkpointing
                if (toggle.id === 'use_gradient_checkpointing') {
                    calculateVram();
                }
            });
        });

        function setToggle(sel, value) {
            const el = $(sel);
            if (el) el.classList.toggle('active', !!value);
        }

        function getToggle(sel) {
            return $(sel)?.classList.contains('active') || false;
        }

        // ============================================
        // CONFIG LOAD/SAVE
        // ============================================

        async function loadConfig() {
            try {
                const config = await SettingsClient.load();
                originalConfig = JSON.parse(JSON.stringify(config));
                currentConfig = config;
                populateForm(config);
                setText('#configStatus', 'Loaded');
            } catch (error) {
                console.error('Failed to load config:', error);
                setText('#configStatus', 'Error');
            }
        }

        function populateForm(config) {
            // Training hyperparams
            $('#batch_size').value = config.hyperparams?.batch_size || config.batch_size || 1;
            $('#gradient_accumulation').value = config.hyperparams?.gradient_accumulation || config.gradient_accumulation || 16;
            $('#learning_rate').value = config.hyperparams?.learning_rate || config.learning_rate || 0.0004;
            $('#fp_precision').value = config.hyperparams?.fp_precision || 'bf16';
            $('#max_length').value = config.hyperparams?.max_length || config.max_length || 2048;
            setToggle('#use_gradient_checkpointing', config.hyperparams?.use_gradient_checkpointing);

            // Logging
            $('#log_steps').value = config.log_steps || 200;
            $('#eval_steps').value = config.eval_steps || 500;
            $('#save_steps').value = config.save_steps || 1000;

            // Auto-generate
            setToggle('#auto_generate_enabled', config.auto_generate?.enabled);
            $('#auto_generate_count').value = config.auto_generate?.count || 100;
            $('#auto_generate_min_queue').value = config.auto_generate?.min_queue_depth || 2;
            $('#auto_generate_cooldown').value = config.auto_generate?.cooldown_sec || 180;

            // Self-correction
            setToggle('#self_correction_enabled', config.self_correction?.enabled);
            setToggle('#self_correction_auto_queue', config.self_correction?.auto_queue);
            $('#self_correction_max').value = config.self_correction?.max_examples || 200;

            // Curriculum
            setToggle('#curriculum_enabled', config.curriculum?.enabled);
            $('#curriculum_target').value = config.curriculum?.target_accuracy || 0.80;
            $('#advancement_evals').value = config.curriculum?.advancement_evals || 3;

            // Remote eval
            setToggle('#remote_enabled', config.remote_eval?.enabled);
            if (config.remote_eval?.host) {
                $('#remote_host').value = config.remote_eval.host;
            } else {
                loadDefaultInferenceHost();
            }
            $('#remote_port').value = config.remote_eval?.port || 8765;
            $('#remote_interval').value = config.remote_eval?.eval_interval_steps || 5000;
            setToggle('#remote_sync', config.remote_eval?.sync_checkpoints);

            // Model info comes from active hero, not config.json
            // (config.locked is stale/global, hero info is per-campaign)
            loadHeroModelInfo();

            // Paths (still from config for now)
            setText('#path_model', config.model_path || '--');
            setText('#path_current', config.current_model_dir || '--');

            // Raw JSON
            $('#rawConfig').textContent = JSON.stringify(config, null, 2);

            // Effective config summary
            updateEffectiveConfig();

            // Add change listeners
            addChangeListeners();
        }

        async function loadDefaultInferenceHost() {
            try {
                const data = await SettingsClient.loadInferenceHosts();
                if (data.hosts?.length > 0) {
                    $('#remote_host').value = data.hosts[0].host;
                }
            } catch (error) {
                $('#remote_host').placeholder = 'Not configured';
            }
        }

        async function loadHeroModelInfo() {
            /**
             * Load model info from the ACTIVE HERO (not config.json).
             * This ensures the Model Info section shows the correct hero's model,
             * not stale/hardcoded DIO data.
             */
            try {
                const heroRes = await fetch('/api/hero');
                if (!heroRes.ok) throw new Error('Hero API failed');
                const hero = await heroRes.json();

                // Also get the hero config for more details
                const configRes = await fetch(`/api/active-campaign`);
                const campaign = configRes.ok ? await configRes.json() : null;

                // Get hero config YAML for full model details
                let heroConfig = null;
                if (hero.hero_id) {
                    try {
                        const yamlRes = await fetch(`/api/hero-config/${hero.hero_id}`);
                        if (yamlRes.ok) heroConfig = await yamlRes.json();
                    } catch (e) {
                        // Hero config endpoint may not exist
                    }
                }

                // Update Model Info section with active hero's data
                setText('#locked_base_model', hero.model_name || heroConfig?.model?.hf_name || '--');
                setText('#locked_architecture', heroConfig?.model?.architecture || hero.model_family || '--');
                setText('#locked_context', heroConfig?.model?.context_length?.toLocaleString() || '--');
                setText('#locked_vocab', heroConfig?.model?.vocab_size?.toLocaleString() || '--');

                // Update path to campaign path if available
                if (campaign?.campaign_path) {
                    setText('#path_current', campaign.campaign_path);
                }

                // Log what hero we're showing
                console.log(`[Settings] Model Info for: ${hero.name} (${hero.hero_id})`);

            } catch (error) {
                console.error('Failed to load hero model info:', error);
                setText('#locked_base_model', 'Error loading');
                setText('#locked_architecture', '--');
                setText('#locked_context', '--');
                setText('#locked_vocab', '--');
            }
        }

        function addChangeListeners() {
            $$('.form-input, .form-select').forEach(el => {
                el.addEventListener('input', checkForChanges);
                el.addEventListener('change', checkForChanges);
            });
        }

        function checkForChanges() {
            const current = gatherFormData();
            hasChanges = JSON.stringify(current) !== JSON.stringify(originalConfig);

            $('#btn-save').disabled = !hasChanges;
            $('#btn-reset').disabled = !hasChanges;

            if (hasChanges) {
                setText('#saveStatus', 'Unsaved changes');
                $('#saveStatus').style.color = 'var(--color-warning)';
            } else {
                setText('#saveStatus', '');
            }

            updateEffectiveConfig();
        }

        function updateEffectiveConfig() {
            const current = gatherFormData();
            // Show a subset of key values
            const summary = {
                batch_size: current.batch_size,
                gradient_accumulation: current.gradient_accumulation,
                effective_batch: current.batch_size * current.gradient_accumulation,
                learning_rate: current.learning_rate,
                precision: current.hyperparams?.fp_precision,
                max_length: current.max_length,
                gradient_checkpointing: current.hyperparams?.use_gradient_checkpointing,
                save_steps: current.save_steps,
                eval_steps: current.eval_steps
            };
            $('#effectiveConfig').textContent = JSON.stringify(summary, null, 2);
        }

        function gatherFormData() {
            const config = JSON.parse(JSON.stringify(originalConfig || {}));

            // Training
            config.batch_size = parseInt($('#batch_size').value);
            config.gradient_accumulation = parseInt($('#gradient_accumulation').value);
            config.learning_rate = parseFloat($('#learning_rate').value);
            config.max_length = parseInt($('#max_length').value);
            config.log_steps = parseInt($('#log_steps').value);
            config.eval_steps = parseInt($('#eval_steps').value);
            config.save_steps = parseInt($('#save_steps').value);

            // Hyperparams nested
            config.hyperparams = config.hyperparams || {};
            config.hyperparams.batch_size = config.batch_size;
            config.hyperparams.gradient_accumulation = config.gradient_accumulation;
            config.hyperparams.learning_rate = config.learning_rate;
            config.hyperparams.max_length = config.max_length;
            config.hyperparams.fp_precision = $('#fp_precision').value;
            config.hyperparams.use_gradient_checkpointing = getToggle('#use_gradient_checkpointing');

            // Auto-generate
            config.auto_generate = config.auto_generate || {};
            config.auto_generate.enabled = getToggle('#auto_generate_enabled');
            config.auto_generate.count = parseInt($('#auto_generate_count').value);
            config.auto_generate.min_queue_depth = parseInt($('#auto_generate_min_queue').value);
            config.auto_generate.cooldown_sec = parseInt($('#auto_generate_cooldown').value);

            // Self-correction
            config.self_correction = config.self_correction || {};
            config.self_correction.enabled = getToggle('#self_correction_enabled');
            config.self_correction.auto_queue = getToggle('#self_correction_auto_queue');
            config.self_correction.max_examples = parseInt($('#self_correction_max').value);

            // Curriculum
            config.curriculum = config.curriculum || {};
            config.curriculum.enabled = getToggle('#curriculum_enabled');
            config.curriculum.target_accuracy = parseFloat($('#curriculum_target').value);
            config.curriculum.advancement_evals = parseInt($('#advancement_evals').value);

            // Remote eval
            config.remote_eval = config.remote_eval || {};
            config.remote_eval.enabled = getToggle('#remote_enabled');
            config.remote_eval.host = $('#remote_host').value;
            config.remote_eval.port = parseInt($('#remote_port').value);
            config.remote_eval.eval_interval_steps = parseInt($('#remote_interval').value);
            config.remote_eval.sync_checkpoints = getToggle('#remote_sync');

            return config;
        }

        // ============================================
        // BUTTON HANDLERS
        // ============================================

        $('#btn-save').addEventListener('click', async () => {
            const status = $('#saveStatus');
            status.textContent = 'Saving...';
            status.style.color = 'var(--color-warning)';

            try {
                const config = gatherFormData();
                await SettingsClient.save(config);

                status.textContent = 'Saved!';
                status.style.color = 'var(--color-success)';
                originalConfig = JSON.parse(JSON.stringify(config));
                hasChanges = false;
                $('#btn-save').disabled = true;
                $('#btn-reset').disabled = true;
                $('#rawConfig').textContent = JSON.stringify(config, null, 2);

                setTimeout(() => setText('#saveStatus', ''), 2000);
            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                status.style.color = 'var(--color-danger)';
            }
        });

        $('#btn-reset').addEventListener('click', () => {
            populateForm(originalConfig);
            hasChanges = false;
            $('#btn-save').disabled = true;
            $('#btn-reset').disabled = true;
            setText('#saveStatus', '');
        });

        $('#btn-save-default').addEventListener('click', async () => {
            const status = $('#saveStatus');
            try {
                await SettingsClient.saveAsDefault();
                status.textContent = 'Saved as default!';
                status.style.color = 'var(--color-success)';
                setTimeout(() => setText('#saveStatus', ''), 2000);
            } catch (error) {
                status.textContent = error.message;
                status.style.color = 'var(--color-danger)';
            }
        });

        $('#btn-restore-defaults').addEventListener('click', async () => {
            if (!confirm('Restore config from saved defaults? Current settings will be backed up.')) return;

            try {
                const result = await SettingsClient.restoreDefault();
                if (result.config) {
                    originalConfig = JSON.parse(JSON.stringify(result.config));
                    populateForm(result.config);
                    hasChanges = false;
                    $('#btn-save').disabled = true;
                    $('#btn-reset').disabled = true;
                }
                const status = $('#saveStatus');
                status.textContent = 'Restored!';
                status.style.color = 'var(--color-success)';
                setTimeout(() => setText('#saveStatus', ''), 2000);
            } catch (error) {
                const status = $('#saveStatus');
                status.textContent = error.message;
                status.style.color = 'var(--color-danger)';
            }
        });

        // ============================================
        // VRAM CALCULATOR
        // ============================================

        const MODEL_PARAMS = 620_000_000;
        const HIDDEN_DIM = 1024;
        const NUM_LAYERS = 28;
        let selectedGpuVram = 24;

        function calculateVram() {
            const batchSize = parseInt($('#batch_size')?.value) || 1;
            const maxLength = parseInt($('#max_length')?.value) || 2048;
            const precision = $('#fp_precision')?.value || 'bf16';
            const gradCheckpoint = getToggle('#use_gradient_checkpointing');

            const bytesPerParam = { 'bf16': 2, 'fp16': 2, 'fp32': 4 }[precision] || 2;

            const modelWeights = MODEL_PARAMS * bytesPerParam;
            const optimizerStates = MODEL_PARAMS * 4 * 2;
            const gradients = MODEL_PARAMS * bytesPerParam;

            let activationFactor = 34;
            if (gradCheckpoint) activationFactor /= Math.sqrt(NUM_LAYERS);
            const activations = batchSize * maxLength * HIDDEN_DIM * NUM_LAYERS * bytesPerParam * activationFactor / NUM_LAYERS;

            const toGB = (bytes) => bytes / (1024 ** 3);

            const vram = {
                model: toGB(modelWeights),
                optimizer: toGB(optimizerStates),
                gradients: toGB(gradients),
                activations: toGB(activations),
                total: toGB(modelWeights + optimizerStates + gradients + activations)
            };

            updateVramUI(vram);
        }

        function updateVramUI(vram) {
            const maxDisplay = Math.max(selectedGpuVram * 1.2, vram.total * 1.1);

            const totalEl = $('#vramTotal');
            totalEl.textContent = `${vram.total.toFixed(1)} GB`;
            totalEl.className = 'vram-total';
            if (vram.total <= selectedGpuVram * 0.7) totalEl.classList.add('safe');
            else if (vram.total <= selectedGpuVram * 0.9) totalEl.classList.add('warning');
            else totalEl.classList.add('danger');

            const pct = (val) => `${(val / maxDisplay * 100).toFixed(1)}%`;
            $('#vramModel').style.width = pct(vram.model);
            $('#vramOptimizer').style.width = pct(vram.optimizer);
            $('#vramGradients').style.width = pct(vram.gradients);
            $('#vramActivations').style.width = pct(vram.activations);

            $('#vramLimit').style.left = `${(selectedGpuVram / maxDisplay * 100)}%`;

            setText('#vramModelVal', `${vram.model.toFixed(1)}GB`);
            setText('#vramOptimizerVal', `${vram.optimizer.toFixed(1)}GB`);
            setText('#vramGradientsVal', `${vram.gradients.toFixed(1)}GB`);
            setText('#vramActivationsVal', `${vram.activations.toFixed(1)}GB`);

            // Tip
            const tip = $('#vramTip');
            const headroom = selectedGpuVram - vram.total;
            if (vram.total > selectedGpuVram) {
                tip.innerHTML = `<strong>Over limit!</strong> Enable gradient checkpointing or reduce batch size.`;
            } else if (headroom < 2) {
                tip.innerHTML = `<strong>Tight fit.</strong> Leave ~2GB for CUDA kernels.`;
            } else if (headroom > 8) {
                tip.innerHTML = `<strong>Room to spare.</strong> Consider larger batch size.`;
            } else {
                tip.innerHTML = `<strong>Good fit.</strong> ~${headroom.toFixed(1)}GB headroom.`;
            }
        }

        $$('.vram-gpu-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                selectedGpuVram = parseInt(btn.dataset.vram);
                $$('.vram-gpu-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                calculateVram();
            });
        });

        ['batch_size', 'max_length', 'fp_precision'].forEach(id => {
            const el = $(`#${id}`);
            if (el) {
                el.addEventListener('input', calculateVram);
                el.addEventListener('change', calculateVram);
            }
        });

        // ============================================
        // SCHEDULER
        // ============================================

        async function loadScheduler() {
            try {
                const [status, presets] = await Promise.all([
                    SettingsClient.loadScheduler(),
                    SettingsClient.loadSchedulerPresets()
                ]);
                schedulerStatus = status;
                renderSchedulerUI(status, presets.presets || []);
            } catch (error) {
                console.error('Failed to load scheduler:', error);
            }
        }

        function renderSchedulerUI(status, presets) {
            // Presets
            const presetsEl = $('#schedulerPresets');
            if (presetsEl && presets.length > 0) {
                presetsEl.innerHTML = presets.map(p => `
                    <div class="preset-card" data-preset="${p.id}">
                        <div class="preset-card__name">${p.id.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</div>
                        <div class="preset-card__desc">${p.description || ''}</div>
                    </div>
                `).join('');

                presetsEl.querySelectorAll('.preset-card').forEach(card => {
                    card.addEventListener('click', () => applyPreset(card.dataset.preset));
                });
            }

            // Strategy
            $$('.strategy-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.strategy === status.strategy);
                card.addEventListener('click', () => {
                    $$('.strategy-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    checkForChanges();
                });
            });

            // Skill configs
            const skillsEl = $('#skillConfigs');
            if (skillsEl && status.skills) {
                const icons = { sy: 'üß©', bin: 'üî¢' };
                skillsEl.innerHTML = status.skills.map(s => `
                    <div class="skill-config-card ${s.enabled ? '' : 'disabled'}" data-skill="${s.id}">
                        <div class="form-toggle ${s.enabled ? 'active' : ''}" id="skill_${s.id}_enabled"></div>
                        <div class="skill-info">
                            <div class="skill-name">${icons[s.id] || '‚ö°'} ${s.id.toUpperCase()}</div>
                            <div class="skill-level">L${s.current_level}/${s.max_level} ${s.current_level >= s.max_level ? '<span class="mastered">Mastered</span>' : ''}</div>
                        </div>
                        <div class="skill-input-group">
                            <label>Priority</label>
                            <input type="number" min="1" max="99" value="${s.priority}" id="skill_${s.id}_priority">
                        </div>
                        <div class="skill-input-group">
                            <label>Weight</label>
                            <input type="number" min="0" max="10" step="0.5" value="${s.weight}" id="skill_${s.id}_weight">
                        </div>
                    </div>
                `).join('');

                // Attach toggle handlers
                skillsEl.querySelectorAll('.form-toggle').forEach(toggle => {
                    toggle.addEventListener('click', () => {
                        toggle.classList.toggle('active');
                        toggle.closest('.skill-config-card').classList.toggle('disabled', !toggle.classList.contains('active'));
                        checkForChanges();
                    });
                });
            }

            // Next decision
            if (status.next_decision) {
                const d = status.next_decision;
                setText('#nextDecisionValue', `${d.skill_id.toUpperCase()} Level ${d.level} √ó ${d.count}`);
                setText('#nextDecisionReason', d.reason);
            }
        }

        async function applyPreset(presetId) {
            try {
                const result = await SettingsClient.applySchedulerPreset(presetId);
                schedulerStatus = result.status;
                renderSchedulerUI(result.status, []);

                $$('.preset-card').forEach(card => {
                    card.classList.toggle('active', card.dataset.preset === presetId);
                });

                const status = $('#saveStatus');
                status.textContent = `Applied: ${presetId.replace(/_/g, ' ')}`;
                status.style.color = 'var(--color-success)';
                setTimeout(() => setText('#saveStatus', ''), 2000);
            } catch (error) {
                const status = $('#saveStatus');
                status.textContent = error.message;
                status.style.color = 'var(--color-danger)';
            }
        }

        // ============================================
        // TIME DISPLAY
        // ============================================

        function updateTime() {
            setText('#timeDisplay', Format.timestamp(new Date()));
        }
        setInterval(updateTime, 1000);
        updateTime();

        // ============================================
        // INIT
        // ============================================

        loadConfig().then(() => calculateVram());
        loadScheduler();
    </script>
</body>
</html>
