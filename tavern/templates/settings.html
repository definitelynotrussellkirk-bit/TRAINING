<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Realm of Training</title>
    <!-- Shared styles -->
    <link rel="stylesheet" href="/static/css/theme.css?v=1">
    <link rel="stylesheet" href="/static/css/forms.css?v=1">
    <link rel="stylesheet" href="/static/css/game.css?v=3">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* 3-Pane Layout */
        .settings-layout {
            display: grid;
            grid-template-columns: 200px 1fr 280px;
            gap: var(--space-lg);
            padding: var(--space-lg);
            height: calc(100vh - 120px);
            overflow: hidden;
        }

        /* Left: Category Nav */
        .settings-nav {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .settings-nav__title {
            font-family: var(--font-title);
            font-size: 1.25rem;
            color: var(--color-gold);
            margin-bottom: var(--space-xs);
        }

        .settings-nav__subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: var(--space-md);
        }

        .settings-nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            background: transparent;
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
        }

        .settings-nav-item:hover {
            background: var(--bg-surface);
            border-color: var(--border-color);
        }

        .settings-nav-item.active {
            background: var(--bg-surface);
            border-color: var(--color-gold);
            color: var(--text-primary);
        }

        .settings-nav-item.danger {
            color: var(--color-danger);
        }

        .settings-nav-item.danger:hover,
        .settings-nav-item.danger.active {
            border-color: var(--color-danger);
        }

        /* Middle: Form Content */
        .settings-main {
            overflow-y: auto;
            padding-right: var(--space-sm);
        }

        .settings-section {
            display: none;
        }

        .settings-section.active {
            display: block;
        }

        .settings-section__header {
            margin-bottom: var(--space-lg);
        }

        .settings-section__title {
            font-family: var(--font-title);
            font-size: 1.5rem;
            color: var(--color-gold);
            margin-bottom: var(--space-xs);
        }

        .settings-section__desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Right: Summary Panel */
        .settings-summary {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            overflow-y: auto;
        }

        .summary-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
        }

        .summary-card__title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-sm);
        }

        .summary-config {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            background: var(--bg-dark);
            border-radius: var(--radius-sm);
            padding: var(--space-sm);
            max-height: 200px;
            overflow: auto;
            white-space: pre-wrap;
            color: var(--text-secondary);
        }

        .summary-actions {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .summary-actions .btn {
            width: 100%;
            justify-content: center;
        }

        .summary-status {
            font-size: 0.8rem;
            text-align: center;
            padding: var(--space-xs);
        }

        /* VRAM Calculator */
        .vram-calculator {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
        }

        .vram-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
        }

        .vram-header h4 {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .vram-total {
            font-size: 1.25rem;
            font-weight: 700;
            font-family: var(--font-mono);
        }

        .vram-total.safe { color: var(--color-success); }
        .vram-total.warning { color: var(--color-warning); }
        .vram-total.danger { color: var(--color-danger); }

        .vram-bar-container {
            background: var(--bg-dark);
            border-radius: var(--radius-sm);
            height: 20px;
            overflow: hidden;
            margin-bottom: var(--space-sm);
            position: relative;
        }

        .vram-bar {
            height: 100%;
            display: flex;
        }

        .vram-segment { height: 100%; transition: width 0.3s ease; }
        .vram-segment.model { background: #3B82F6; }
        .vram-segment.optimizer { background: #8B5CF6; }
        .vram-segment.gradients { background: #EC4899; }
        .vram-segment.activations { background: #F59E0B; }

        .vram-limit {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--color-danger);
        }

        .vram-breakdown {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-xs);
            font-size: 0.75rem;
        }

        .vram-item {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .vram-dot {
            width: 8px;
            height: 8px;
            border-radius: 2px;
        }

        .vram-dot.model { background: #3B82F6; }
        .vram-dot.optimizer { background: #8B5CF6; }
        .vram-dot.gradients { background: #EC4899; }
        .vram-dot.activations { background: #F59E0B; }

        .vram-gpu-select {
            display: flex;
            gap: var(--space-xs);
            margin-top: var(--space-sm);
            flex-wrap: wrap;
        }

        .vram-gpu-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            cursor: pointer;
        }

        .vram-gpu-btn:hover { border-color: var(--color-gold); }
        .vram-gpu-btn.active {
            background: rgba(245, 158, 11, 0.2);
            border-color: var(--color-gold);
            color: var(--text-primary);
        }

        .vram-tip {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: var(--space-sm);
            padding: var(--space-xs);
            background: var(--bg-dark);
            border-radius: var(--radius-sm);
        }

        .vram-tip strong { color: var(--color-gold); }

        /* Skill Config Cards */
        .skill-configs {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .skill-config-card {
            display: grid;
            grid-template-columns: 40px 1fr repeat(2, 80px);
            gap: var(--space-md);
            align-items: center;
            padding: var(--space-md);
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
        }

        .skill-config-card.disabled { opacity: 0.5; }

        .skill-info .skill-name {
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .skill-info .skill-level {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .skill-info .mastered { color: var(--color-success); }

        .skill-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .skill-input-group label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .skill-input-group input {
            padding: 0.3rem 0.4rem;
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.8rem;
            width: 100%;
        }

        /* Strategy Grid */
        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-sm);
        }

        .strategy-card {
            padding: var(--space-md);
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .strategy-card:hover { border-color: var(--color-gold); }
        .strategy-card.selected {
            border-color: var(--color-gold);
            background: rgba(245, 158, 11, 0.2);
        }

        .strategy-card .strategy-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.15rem;
        }

        .strategy-card .strategy-desc {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Next Decision Preview */
        .next-decision {
            padding: var(--space-md);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(59, 130, 246, 0.15));
            border-radius: var(--radius-md);
            text-align: center;
            border: 1px solid var(--border-gold);
        }

        .next-decision__label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .next-decision__value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-gold);
            font-family: var(--font-title);
            margin: var(--space-xs) 0;
        }

        .next-decision__reason {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        @media (max-width: 1200px) {
            .settings-layout {
                grid-template-columns: 180px 1fr 240px;
            }
        }

        @media (max-width: 900px) {
            .settings-layout {
                grid-template-columns: 1fr;
                height: auto;
            }
            .settings-nav {
                flex-direction: row;
                flex-wrap: wrap;
                gap: var(--space-xs);
            }
            .settings-nav__title,
            .settings-nav__subtitle {
                display: none;
            }
            .settings-summary {
                order: -1;
            }
            .strategy-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- TITLE BAR -->
    <header class="game-header">
        <div class="header-left">
            <h1 class="game-title">Settings</h1>
        </div>
        <div class="header-center">
            <div class="resource-bar">
                <div class="resource">
                    <span class="resource-icon">‚öôÔ∏è</span>
                    <span class="resource-label">CONFIG</span>
                    <span class="resource-value" id="configStatus">Loading</span>
                </div>
            </div>
        </div>
        <div class="header-right">
            <div class="time-display" id="timeDisplay">--:--:--</div>
        </div>
    </header>

    <!-- 3-PANE LAYOUT -->
    <div class="settings-layout">
        <!-- LEFT: CATEGORY NAV -->
        <aside class="settings-nav">
            <h2 class="settings-nav__title">Settings</h2>
            <p class="settings-nav__subtitle">Configure training behavior</p>

            <button class="settings-nav-item active" data-section="training">
                üéØ Training
            </button>
            <button class="settings-nav-item" data-section="data">
                üîÑ Data & Skills
            </button>
            <button class="settings-nav-item" data-section="scheduler">
                üìö Scheduler
            </button>
            <button class="settings-nav-item" data-section="remote">
                üåê Remote Eval
            </button>
            <button class="settings-nav-item" data-section="model">
                ü§ñ Model Info
            </button>
            <button class="settings-nav-item danger" data-section="danger">
                ‚ö†Ô∏è Danger Zone
            </button>
        </aside>

        <!-- MIDDLE: FORM CONTENT -->
        <main class="settings-main">
            <!-- TRAINING SECTION -->
            <section class="settings-section active" data-section="training">
                <div class="settings-section__header">
                    <h2 class="settings-section__title">Training Configuration</h2>
                    <p class="settings-section__desc">Core hyperparameters and logging settings.</p>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Hyperparameters</div>
                    <div class="form-section__subtitle">These affect training speed, stability, and VRAM usage.</div>

                    <div class="form-row">
                        <div class="form-row__label">Batch Size<small>Samples per step</small></div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="batch_size" min="1" max="32" value="1">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Gradient Accum<small>Effective batch = batch √ó accum</small></div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="gradient_accumulation" min="1" max="128" value="16">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Learning Rate<small>Optimizer step size</small></div>
                        <div class="form-row__value">
                            <input type="text" class="form-input form-input--number" id="learning_rate" value="0.0004">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Precision<small>Floating point format</small></div>
                        <div class="form-row__value">
                            <select class="form-select" id="fp_precision">
                                <option value="bf16">bf16 (Brain Float)</option>
                                <option value="fp16">fp16 (Half)</option>
                                <option value="fp32">fp32 (Full)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Max Length<small>Maximum sequence length</small></div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="max_length" min="512" max="8192" value="2048">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Gradient Checkpoint<small>Trade compute for memory</small></div>
                        <div class="form-row__value">
                            <div class="form-toggle" id="use_gradient_checkpointing"></div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Memory Optimization</div>
                    <div class="form-section__subtitle">Training mode and optimizer affect VRAM usage significantly.</div>

                    <div class="form-row">
                        <div class="form-row__label">Training Mode<small>Full FT vs parameter-efficient</small></div>
                        <div class="form-row__value">
                            <select class="form-select" id="training_mode">
                                <option value="full">Full Fine-Tuning</option>
                                <option value="lora">LoRA (Adapters)</option>
                                <option value="qlora">QLoRA (4-bit + LoRA)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Optimizer<small>Memory vs quality trade-off</small></div>
                        <div class="form-row__value">
                            <select class="form-select" id="optimizer_type">
                                <option value="adamw">AdamW (Standard)</option>
                                <option value="adamw_8bit">AdamW 8-bit</option>
                                <option value="galore">GaLore</option>
                                <option value="galore_8bit">GaLore 8-bit</option>
                                <option value="muon">Muon</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">DeepSpeed<small>CPU offloading for large models</small></div>
                        <div class="form-row__value">
                            <select class="form-select" id="deepspeed_stage">
                                <option value="">Disabled</option>
                                <option value="2">ZeRO-2 (Optimizer to CPU)</option>
                                <option value="3">ZeRO-3 (Full offload)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- VRAM Calculator -->
                <div class="vram-calculator">
                    <div class="vram-header">
                        <h4>üìä Estimated VRAM</h4>
                        <div class="vram-total" id="vramTotal">-- GB</div>
                    </div>

                    <div class="vram-bar-container">
                        <div class="vram-bar">
                            <div class="vram-segment model" id="vramModel"></div>
                            <div class="vram-segment optimizer" id="vramOptimizer"></div>
                            <div class="vram-segment gradients" id="vramGradients"></div>
                            <div class="vram-segment activations" id="vramActivations"></div>
                        </div>
                        <div class="vram-limit" id="vramLimit" style="left: 100%;"></div>
                    </div>

                    <div class="vram-breakdown">
                        <div class="vram-item">
                            <div class="vram-dot model"></div>
                            <span>Model</span>
                            <span id="vramModelVal">--</span>
                        </div>
                        <div class="vram-item">
                            <div class="vram-dot optimizer"></div>
                            <span>Optimizer</span>
                            <span id="vramOptimizerVal">--</span>
                        </div>
                        <div class="vram-item">
                            <div class="vram-dot gradients"></div>
                            <span>Gradients</span>
                            <span id="vramGradientsVal">--</span>
                        </div>
                        <div class="vram-item">
                            <div class="vram-dot activations"></div>
                            <span>Activations</span>
                            <span id="vramActivationsVal">--</span>
                        </div>
                    </div>

                    <div class="vram-gpu-select">
                        <button class="vram-gpu-btn active" data-vram="24">RTX 4090</button>
                        <button class="vram-gpu-btn" data-vram="24">RTX 3090</button>
                        <button class="vram-gpu-btn" data-vram="16">RTX 4080</button>
                        <button class="vram-gpu-btn" data-vram="12">RTX 4070</button>
                    </div>

                    <div class="vram-tip" id="vramTip"></div>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Logging & Checkpoints</div>

                    <div class="form-row">
                        <div class="form-row__label">Log Steps</div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="log_steps" min="10" max="1000" value="200">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Eval Steps</div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="eval_steps" min="100" max="5000" value="500">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Save Steps</div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="save_steps" min="500" max="10000" value="1000">
                        </div>
                    </div>
                </div>
            </section>

            <!-- DATA & SKILLS SECTION -->
            <section class="settings-section" data-section="data">
                <div class="settings-section__header">
                    <h2 class="settings-section__title">Data & Skills</h2>
                    <p class="settings-section__desc">Configure data generation and skill training.</p>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Auto-Generate</div>
                    <div class="form-section__subtitle">Automatically generate training data when queue runs low.</div>

                    <div class="form-row">
                        <div class="form-row__label">Enabled</div>
                        <div class="form-row__value">
                            <div class="form-toggle" id="auto_generate_enabled"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Batch Count<small>Examples per generation</small></div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="auto_generate_count" min="10" max="1000" value="100">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Min Queue Depth<small>Trigger threshold</small></div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="auto_generate_min_queue" min="1" max="10" value="2">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Cooldown (sec)</div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="auto_generate_cooldown" min="60" max="3600" value="180">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Self-Correction</div>
                    <div class="form-section__subtitle">Generate corrections from model mistakes.</div>

                    <div class="form-row">
                        <div class="form-row__label">Enabled</div>
                        <div class="form-row__value">
                            <div class="form-toggle" id="self_correction_enabled"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Auto Queue</div>
                        <div class="form-row__value">
                            <div class="form-toggle" id="self_correction_auto_queue"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Max Examples</div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="self_correction_max" min="10" max="1000" value="200">
                        </div>
                    </div>
                </div>
            </section>

            <!-- SCHEDULER SECTION -->
            <section class="settings-section" data-section="scheduler">
                <div class="settings-section__header">
                    <h2 class="settings-section__title">Curriculum Scheduler</h2>
                    <p class="settings-section__desc">Control skill progression and training order.</p>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Quick Presets</div>
                    <div class="preset-grid" id="schedulerPresets">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Next Training Batch</div>
                    <div class="next-decision" id="nextDecisionBox">
                        <div class="next-decision__label">If queue is empty, will generate:</div>
                        <div class="next-decision__value" id="nextDecisionValue">Loading...</div>
                        <div class="next-decision__reason" id="nextDecisionReason"></div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Scheduling Strategy</div>
                    <div class="strategy-grid" id="strategyGrid">
                        <div class="strategy-card" data-strategy="equal">
                            <div class="strategy-name">Equal</div>
                            <div class="strategy-desc">Alternate between skills</div>
                        </div>
                        <div class="strategy-card" data-strategy="focus">
                            <div class="strategy-name">Focus</div>
                            <div class="strategy-desc">Complete one skill first</div>
                        </div>
                        <div class="strategy-card" data-strategy="weighted">
                            <div class="strategy-name">Weighted</div>
                            <div class="strategy-desc">Train by ratio</div>
                        </div>
                        <div class="strategy-card" data-strategy="lowest_first">
                            <div class="strategy-name">Catch Up</div>
                            <div class="strategy-desc">Focus on lowest level</div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Skill Configuration</div>
                    <div class="skill-configs" id="skillConfigs">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Progression</div>

                    <div class="form-row">
                        <div class="form-row__label">Auto-Progression</div>
                        <div class="form-row__value">
                            <div class="form-toggle" id="curriculum_enabled"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Target Accuracy<small>Required to level up</small></div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="curriculum_target" min="0.5" max="1.0" step="0.05" value="0.80">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Advancement Evals<small>Consecutive passes needed</small></div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="advancement_evals" min="1" max="10" value="3">
                        </div>
                    </div>
                </div>
            </section>

            <!-- REMOTE EVAL SECTION -->
            <section class="settings-section" data-section="remote">
                <div class="settings-section__header">
                    <h2 class="settings-section__title">Remote Evaluation</h2>
                    <p class="settings-section__desc">Configure the RTX 3090 inference server for evaluation.</p>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Connection</div>

                    <div class="form-row">
                        <div class="form-row__label">Enabled</div>
                        <div class="form-row__value">
                            <div class="form-toggle" id="remote_enabled"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Host</div>
                        <div class="form-row__value">
                            <input type="text" class="form-input" id="remote_host" placeholder="Loading...">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Port</div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="remote_port" min="1" max="65535" value="8765">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Eval Interval<small>Steps between remote evals</small></div>
                        <div class="form-row__value">
                            <input type="number" class="form-input form-input--number" id="remote_interval" min="1000" max="50000" value="5000">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Sync Checkpoints</div>
                        <div class="form-row__value">
                            <div class="form-toggle" id="remote_sync"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- MODEL INFO SECTION -->
            <section class="settings-section" data-section="model">
                <div class="settings-section__header">
                    <h2 class="settings-section__title">Model Information</h2>
                    <p class="settings-section__desc">Locked configuration that cannot be changed mid-training.</p>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Locked Configuration</div>
                    <div class="form-section__subtitle">Changing these requires restarting training from scratch.</div>

                    <div class="form-row">
                        <div class="form-row__label">Base Model</div>
                        <div class="form-row__value">
                            <span class="form-value form-value--muted" id="locked_base_model">--</span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Architecture</div>
                        <div class="form-row__value">
                            <span class="form-value form-value--muted" id="locked_architecture">--</span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Max Context</div>
                        <div class="form-row__value">
                            <span class="form-value form-value--muted" id="locked_context">--</span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Vocab Size</div>
                        <div class="form-row__value">
                            <span class="form-value form-value--muted" id="locked_vocab">--</span>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section__title">Paths</div>

                    <div class="form-row">
                        <div class="form-row__label">Model Path</div>
                        <div class="form-row__value">
                            <span class="form-value" id="path_model" style="font-size: 0.75rem; word-break: break-all;">--</span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-row__label">Current Model Dir</div>
                        <div class="form-row__value">
                            <span class="form-value" id="path_current" style="font-size: 0.75rem; word-break: break-all;">--</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- DANGER ZONE SECTION -->
            <section class="settings-section" data-section="danger">
                <div class="settings-section__header">
                    <h2 class="settings-section__title" style="color: var(--color-danger);">Danger Zone</h2>
                    <p class="settings-section__desc">Destructive operations. Be careful!</p>
                </div>

                <div class="form-section form-section--danger">
                    <div class="form-section__title">Reset Settings</div>
                    <div class="form-section__subtitle">Restore config from saved defaults. Current settings will be backed up.</div>
                    <div class="form-actions">
                        <button class="btn btn--danger" id="btn-restore-defaults">Restore Defaults</button>
                    </div>
                </div>

                <div class="form-section form-section--danger">
                    <div class="form-section__title">Raw Configuration</div>
                    <div class="form-section__subtitle">Full config.json content (read-only)</div>
                    <pre class="config-preview" id="rawConfig">Loading...</pre>
                </div>
            </section>
        </main>

        <!-- RIGHT: SUMMARY PANEL -->
        <aside class="settings-summary">
            <div class="summary-card">
                <div class="summary-card__title">Effective Config</div>
                <pre class="summary-config" id="effectiveConfig">{}</pre>
            </div>

            <div class="summary-card">
                <div class="summary-card__title">Actions</div>
                <div class="summary-actions">
                    <button class="btn btn--primary" id="btn-save" disabled>Save Changes</button>
                    <button class="btn" id="btn-reset" disabled>Discard Changes</button>
                    <button class="btn" id="btn-save-default">Save as Default</button>
                </div>
                <div class="summary-status" id="saveStatus"></div>
            </div>

            <div class="summary-card">
                <div class="summary-card__title">Quick Tips</div>
                <div style="font-size: 0.75rem; color: var(--text-muted); line-height: 1.4;">
                    <p style="margin-bottom: 0.5rem;">‚Ä¢ Batch size √ó Grad Accum = Effective batch</p>
                    <p style="margin-bottom: 0.5rem;">‚Ä¢ Lower LR for stability, higher for speed</p>
                    <p>‚Ä¢ Enable gradient checkpointing to save VRAM</p>
                </div>
            </div>
        </aside>
    </div>

    <!-- NAVIGATION (dynamic) -->
    <nav class="game-nav" id="bottomNav"></nav>
    <script src="/static/js/nav.js"></script>
    <script src="/static/js/events.js"></script>
    <!-- Shared modules -->
    <script src="/static/js/formatters.js?v=1"></script>
    <script src="/static/js/settings_client.js?v=1"></script>

    <script>
        // ============================================
        // SETTINGS PAGE - Clean Rewrite
        // ============================================

        let originalConfig = null;
        let currentConfig = null;
        let hasChanges = false;
        let schedulerStatus = null;

        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => document.querySelectorAll(sel);
        const setText = (sel, text) => { const el = $(sel); if (el) el.textContent = text; };

        // ============================================
        // SECTION NAVIGATION
        // ============================================

        $$('.settings-nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.dataset.section;

                // Update nav
                $$('.settings-nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                // Update content
                $$('.settings-section').forEach(s => {
                    s.classList.toggle('active', s.dataset.section === section);
                });
            });
        });

        // ============================================
        // TOGGLE SWITCHES
        // ============================================

        $$('.form-toggle').forEach(toggle => {
            toggle.addEventListener('click', () => {
                toggle.classList.toggle('active');
                checkForChanges();

                // VRAM recalc if gradient checkpointing
                if (toggle.id === 'use_gradient_checkpointing') {
                    calculateVram();
                }
            });
        });

        function setToggle(sel, value) {
            const el = $(sel);
            if (el) el.classList.toggle('active', !!value);
        }

        function getToggle(sel) {
            return $(sel)?.classList.contains('active') || false;
        }

        // ============================================
        // CONFIG LOAD/SAVE
        // ============================================

        async function loadConfig() {
            try {
                const config = await SettingsClient.load();
                originalConfig = JSON.parse(JSON.stringify(config));
                currentConfig = config;
                populateForm(config);
                setText('#configStatus', 'Loaded');
            } catch (error) {
                console.error('Failed to load config:', error);
                setText('#configStatus', 'Error');
            }
        }

        function populateForm(config) {
            // Training hyperparams
            $('#batch_size').value = config.hyperparams?.batch_size || config.batch_size || 1;
            $('#gradient_accumulation').value = config.hyperparams?.gradient_accumulation || config.gradient_accumulation || 16;
            $('#learning_rate').value = config.hyperparams?.learning_rate || config.learning_rate || 0.0004;
            $('#fp_precision').value = config.hyperparams?.fp_precision || 'bf16';
            $('#max_length').value = config.hyperparams?.max_length || config.max_length || 2048;
            setToggle('#use_gradient_checkpointing', config.hyperparams?.use_gradient_checkpointing);

            // Logging
            $('#log_steps').value = config.log_steps || 200;
            $('#eval_steps').value = config.eval_steps || 500;
            $('#save_steps').value = config.save_steps || 1000;

            // Memory optimization
            $('#training_mode').value = config.training_mode || 'full';
            $('#optimizer_type').value = config.optimizer?.type || 'adamw';
            // DeepSpeed stage from config path
            const dsConfig = config.environment?.deepspeed_config || '';
            if (dsConfig.includes('zero3')) {
                $('#deepspeed_stage').value = '3';
            } else if (dsConfig.includes('zero2')) {
                $('#deepspeed_stage').value = '2';
            } else {
                $('#deepspeed_stage').value = '';
            }

            // Auto-generate
            setToggle('#auto_generate_enabled', config.auto_generate?.enabled);
            $('#auto_generate_count').value = config.auto_generate?.count || 100;
            $('#auto_generate_min_queue').value = config.auto_generate?.min_queue_depth || 2;
            $('#auto_generate_cooldown').value = config.auto_generate?.cooldown_sec || 180;

            // Self-correction
            setToggle('#self_correction_enabled', config.self_correction?.enabled);
            setToggle('#self_correction_auto_queue', config.self_correction?.auto_queue);
            $('#self_correction_max').value = config.self_correction?.max_examples || 200;

            // Curriculum
            setToggle('#curriculum_enabled', config.curriculum?.enabled);
            $('#curriculum_target').value = config.curriculum?.target_accuracy || 0.80;
            $('#advancement_evals').value = config.curriculum?.advancement_evals || 3;

            // Remote eval
            setToggle('#remote_enabled', config.remote_eval?.enabled);
            if (config.remote_eval?.host) {
                $('#remote_host').value = config.remote_eval.host;
            } else {
                loadDefaultInferenceHost();
            }
            $('#remote_port').value = config.remote_eval?.port || 8765;
            $('#remote_interval').value = config.remote_eval?.eval_interval_steps || 5000;
            setToggle('#remote_sync', config.remote_eval?.sync_checkpoints);

            // Model info AND paths come from /api/run-context (single source of truth)
            // This ensures model identity and paths are consistent with the active campaign
            loadHeroModelInfo();

            // Raw JSON
            $('#rawConfig').textContent = JSON.stringify(config, null, 2);

            // Effective config summary
            updateEffectiveConfig();

            // Add change listeners
            addChangeListeners();
        }

        async function loadDefaultInferenceHost() {
            try {
                const data = await SettingsClient.loadInferenceHosts();
                if (data.hosts?.length > 0) {
                    $('#remote_host').value = data.hosts[0].host;
                }
            } catch (error) {
                $('#remote_host').placeholder = 'Not configured';
            }
        }

        async function loadHeroModelInfo() {
            /**
             * Load model info from /api/run-context (single source of truth).
             * This ensures Model Info AND Paths are consistent and come from
             * the active campaign, not a mix of stale sources.
             */
            try {
                const res = await fetch('/api/run-context');
                if (!res.ok) throw new Error('RunContext API failed');
                const ctx = await res.json();

                // Update Model Info section
                if (ctx.locked) {
                    setText('#locked_base_model', ctx.locked.base_model || '--');
                    setText('#locked_architecture', ctx.locked.architecture || '--');
                    setText('#locked_context', ctx.locked.context_length?.toLocaleString() || '--');
                    setText('#locked_vocab', ctx.locked.vocab_size?.toLocaleString() || '--');
                } else {
                    setText('#locked_base_model', '--');
                    setText('#locked_architecture', '--');
                    setText('#locked_context', '--');
                    setText('#locked_vocab', '--');
                }

                // Update Paths section FROM RUN CONTEXT (not root config)
                setText('#path_model', ctx.model_path || '--');
                setText('#path_current', ctx.current_model_dir || '--');

                // Show warnings if any
                if (ctx._warnings?.length > 0) {
                    console.warn('[Settings] RunContext warnings:', ctx._warnings);
                }

                // Log what we're showing
                console.log(`[Settings] Model Info for: ${ctx.hero_name || 'Unknown'} (${ctx.hero_id || 'legacy'})`);

            } catch (error) {
                console.error('Failed to load run context:', error);
                setText('#locked_base_model', 'Error loading');
                setText('#locked_architecture', '--');
                setText('#locked_context', '--');
                setText('#locked_vocab', '--');
            }
        }

        function addChangeListeners() {
            $$('.form-input, .form-select').forEach(el => {
                el.addEventListener('input', checkForChanges);
                el.addEventListener('change', checkForChanges);
            });
        }

        function checkForChanges() {
            const current = gatherFormData();
            hasChanges = JSON.stringify(current) !== JSON.stringify(originalConfig);

            $('#btn-save').disabled = !hasChanges;
            $('#btn-reset').disabled = !hasChanges;

            if (hasChanges) {
                setText('#saveStatus', 'Unsaved changes');
                $('#saveStatus').style.color = 'var(--color-warning)';
            } else {
                setText('#saveStatus', '');
            }

            updateEffectiveConfig();
        }

        function updateEffectiveConfig() {
            const current = gatherFormData();
            // Show a subset of key values
            const summary = {
                batch_size: current.batch_size,
                gradient_accumulation: current.gradient_accumulation,
                effective_batch: current.batch_size * current.gradient_accumulation,
                learning_rate: current.learning_rate,
                precision: current.hyperparams?.fp_precision,
                max_length: current.max_length,
                gradient_checkpointing: current.hyperparams?.use_gradient_checkpointing,
                save_steps: current.save_steps,
                eval_steps: current.eval_steps
            };
            $('#effectiveConfig').textContent = JSON.stringify(summary, null, 2);
        }

        function gatherFormData() {
            const config = JSON.parse(JSON.stringify(originalConfig || {}));

            // Training
            config.batch_size = parseInt($('#batch_size').value);
            config.gradient_accumulation = parseInt($('#gradient_accumulation').value);
            config.learning_rate = parseFloat($('#learning_rate').value);
            config.max_length = parseInt($('#max_length').value);
            config.log_steps = parseInt($('#log_steps').value);
            config.eval_steps = parseInt($('#eval_steps').value);
            config.save_steps = parseInt($('#save_steps').value);

            // Hyperparams nested
            config.hyperparams = config.hyperparams || {};
            config.hyperparams.batch_size = config.batch_size;
            config.hyperparams.gradient_accumulation = config.gradient_accumulation;
            config.hyperparams.learning_rate = config.learning_rate;
            config.hyperparams.max_length = config.max_length;
            config.hyperparams.fp_precision = $('#fp_precision').value;
            config.hyperparams.use_gradient_checkpointing = getToggle('#use_gradient_checkpointing');

            // Memory optimization
            config.training_mode = $('#training_mode').value;
            config.optimizer = config.optimizer || {};
            config.optimizer.type = $('#optimizer_type').value;

            // DeepSpeed config path
            config.environment = config.environment || {};
            const dsStage = $('#deepspeed_stage').value;
            if (dsStage === '3') {
                config.environment.deepspeed_config = 'configs/ds_zero3_offload.json';
            } else if (dsStage === '2') {
                config.environment.deepspeed_config = 'configs/ds_zero2_offload.json';
            } else {
                config.environment.deepspeed_config = null;
            }

            // Auto-generate
            config.auto_generate = config.auto_generate || {};
            config.auto_generate.enabled = getToggle('#auto_generate_enabled');
            config.auto_generate.count = parseInt($('#auto_generate_count').value);
            config.auto_generate.min_queue_depth = parseInt($('#auto_generate_min_queue').value);
            config.auto_generate.cooldown_sec = parseInt($('#auto_generate_cooldown').value);

            // Self-correction
            config.self_correction = config.self_correction || {};
            config.self_correction.enabled = getToggle('#self_correction_enabled');
            config.self_correction.auto_queue = getToggle('#self_correction_auto_queue');
            config.self_correction.max_examples = parseInt($('#self_correction_max').value);

            // Curriculum
            config.curriculum = config.curriculum || {};
            config.curriculum.enabled = getToggle('#curriculum_enabled');
            config.curriculum.target_accuracy = parseFloat($('#curriculum_target').value);
            config.curriculum.advancement_evals = parseInt($('#advancement_evals').value);

            // Remote eval
            config.remote_eval = config.remote_eval || {};
            config.remote_eval.enabled = getToggle('#remote_enabled');
            config.remote_eval.host = $('#remote_host').value;
            config.remote_eval.port = parseInt($('#remote_port').value);
            config.remote_eval.eval_interval_steps = parseInt($('#remote_interval').value);
            config.remote_eval.sync_checkpoints = getToggle('#remote_sync');

            return config;
        }

        // ============================================
        // BUTTON HANDLERS
        // ============================================

        $('#btn-save').addEventListener('click', async () => {
            const status = $('#saveStatus');
            status.textContent = 'Saving...';
            status.style.color = 'var(--color-warning)';

            try {
                const config = gatherFormData();
                await SettingsClient.save(config);

                status.textContent = 'Saved!';
                status.style.color = 'var(--color-success)';
                originalConfig = JSON.parse(JSON.stringify(config));
                hasChanges = false;
                $('#btn-save').disabled = true;
                $('#btn-reset').disabled = true;
                $('#rawConfig').textContent = JSON.stringify(config, null, 2);

                setTimeout(() => setText('#saveStatus', ''), 2000);
            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                status.style.color = 'var(--color-danger)';
            }
        });

        $('#btn-reset').addEventListener('click', () => {
            populateForm(originalConfig);
            hasChanges = false;
            $('#btn-save').disabled = true;
            $('#btn-reset').disabled = true;
            setText('#saveStatus', '');
        });

        $('#btn-save-default').addEventListener('click', async () => {
            const status = $('#saveStatus');
            try {
                await SettingsClient.saveAsDefault();
                status.textContent = 'Saved as default!';
                status.style.color = 'var(--color-success)';
                setTimeout(() => setText('#saveStatus', ''), 2000);
            } catch (error) {
                status.textContent = error.message;
                status.style.color = 'var(--color-danger)';
            }
        });

        $('#btn-restore-defaults').addEventListener('click', async () => {
            if (!confirm('Restore config from saved defaults? Current settings will be backed up.')) return;

            try {
                const result = await SettingsClient.restoreDefault();
                if (result.config) {
                    originalConfig = JSON.parse(JSON.stringify(result.config));
                    populateForm(result.config);
                    hasChanges = false;
                    $('#btn-save').disabled = true;
                    $('#btn-reset').disabled = true;
                }
                const status = $('#saveStatus');
                status.textContent = 'Restored!';
                status.style.color = 'var(--color-success)';
                setTimeout(() => setText('#saveStatus', ''), 2000);
            } catch (error) {
                const status = $('#saveStatus');
                status.textContent = error.message;
                status.style.color = 'var(--color-danger)';
            }
        });

        // ============================================
        // VRAM CALCULATOR (Hero-aware)
        // ============================================

        // These will be populated from /api/hero-model-info
        let vramProfile = null;
        let heroDefaults = null;
        let heroSizeB = null;
        let selectedGpuVram = 24;

        // Optimizer memory factors (relative to full AdamW)
        const OPTIMIZER_FACTORS = {
            adamw: 1.0,
            adamw_8bit: 0.25,
            galore: 0.25,
            galore_8bit: 0.0625,  // ~16x reduction
            muon: 0.5
        };

        // Training mode factors
        const TRAINING_MODE_FACTORS = {
            full: { model: 1.0, optimizer: 1.0, gradients: 1.0 },
            lora: { model: 1.0, optimizer: 0.05, gradients: 0.05 },
            qlora: { model: 0.5, optimizer: 0.03, gradients: 0.03 }
        };

        /**
         * Estimate VRAM breakdown using hero's VRAM profile.
         * Matches the formula in guild/heroes/types.py VRAMProfile.estimate_breakdown()
         */
        function estimateVramBreakdown(batchSize, maxLength, precision, gradientCheckpointing, trainingMode, optimizerType, deepspeedStage) {
            if (!vramProfile) {
                // Fallback to hardcoded 0.6B model defaults if no profile loaded
                vramProfile = {
                    base_memory_gb: 1.2,
                    per_batch_gb: 0.8,
                    optimizer_overhead_gb: 0.6
                };
            }

            const base = vramProfile.base_memory_gb;
            const perBatch = vramProfile.per_batch_gb;
            const opt = vramProfile.optimizer_overhead_gb;

            // Precision factor
            const prec = (precision || '').toLowerCase();
            let precisionFactor = 1.0;
            if (prec === 'fp32') precisionFactor = 2.0;

            // Length & checkpoint factors
            const lengthFactor = Math.max(maxLength, 1) / 2048.0;
            const checkpointFactor = gradientCheckpointing ? 0.35 : 1.0;

            // Training mode factors
            const modeFactors = TRAINING_MODE_FACTORS[trainingMode] || TRAINING_MODE_FACTORS.full;

            // Optimizer type factor
            const optFactor = OPTIMIZER_FACTORS[optimizerType] || 1.0;

            // DeepSpeed factors
            let dsModelFactor = 1.0;
            let dsOptimizerFactor = 1.0;
            let dsGradientFactor = 1.0;

            if (deepspeedStage === 2 || deepspeedStage === '2') {
                dsOptimizerFactor = 0.0;  // ZeRO-2 offloads optimizer to CPU
            } else if (deepspeedStage === 3 || deepspeedStage === '3') {
                dsModelFactor = 0.3;
                dsOptimizerFactor = 0.0;
                dsGradientFactor = 0.3;
            }

            // Components
            const modelMem = base * precisionFactor * modeFactors.model * dsModelFactor;
            const optimizerMem = opt * precisionFactor * modeFactors.optimizer * optFactor * dsOptimizerFactor;
            const activationTotal = perBatch * batchSize * lengthFactor * checkpointFactor * precisionFactor;

            // Split activations into gradients vs activations
            const gradientsMem = activationTotal * 0.4 * modeFactors.gradients * dsGradientFactor;
            const activationsMem = activationTotal * 0.6;

            const total = modelMem + optimizerMem + gradientsMem + activationsMem;

            // Build mode info string
            const modeInfo = [];
            if (trainingMode !== 'full') modeInfo.push(trainingMode.toUpperCase());
            if (optimizerType !== 'adamw') modeInfo.push(optimizerType);
            if (deepspeedStage) modeInfo.push(`ZeRO-${deepspeedStage}`);

            return {
                model: modelMem,
                optimizer: optimizerMem,
                gradients: gradientsMem,
                activations: activationsMem,
                total: total,
                modeInfo: modeInfo.length > 0 ? modeInfo.join(' + ') : 'Full FT'
            };
        }

        function calculateVram() {
            const batchSize = parseInt($('#batch_size')?.value) || 1;
            const maxLength = parseInt($('#max_length')?.value) || 2048;
            const precision = $('#fp_precision')?.value || 'bf16';
            const gradCheckpoint = getToggle('#use_gradient_checkpointing');
            const trainingMode = $('#training_mode')?.value || 'full';
            const optimizerType = $('#optimizer_type')?.value || 'adamw';
            const deepspeedStage = $('#deepspeed_stage')?.value || '';

            const vram = estimateVramBreakdown(batchSize, maxLength, precision, gradCheckpoint, trainingMode, optimizerType, deepspeedStage);
            updateVramUI(vram);
        }

        function updateVramUI(vram) {
            const maxDisplay = Math.max(selectedGpuVram * 1.2, vram.total * 1.1);

            const totalEl = $('#vramTotal');
            totalEl.textContent = `${vram.total.toFixed(1)} GB`;
            totalEl.className = 'vram-total';
            if (vram.total <= selectedGpuVram * 0.7) totalEl.classList.add('safe');
            else if (vram.total <= selectedGpuVram * 0.9) totalEl.classList.add('warning');
            else totalEl.classList.add('danger');

            const pct = (val) => `${(val / maxDisplay * 100).toFixed(1)}%`;
            $('#vramModel').style.width = pct(vram.model);
            $('#vramOptimizer').style.width = pct(vram.optimizer);
            $('#vramGradients').style.width = pct(vram.gradients);
            $('#vramActivations').style.width = pct(vram.activations);

            $('#vramLimit').style.left = `${(selectedGpuVram / maxDisplay * 100)}%`;

            setText('#vramModelVal', `${vram.model.toFixed(1)}GB`);
            setText('#vramOptimizerVal', `${vram.optimizer.toFixed(1)}GB`);
            setText('#vramGradientsVal', `${vram.gradients.toFixed(1)}GB`);
            setText('#vramActivationsVal', `${vram.activations.toFixed(1)}GB`);

            // Enhanced tips based on mode and VRAM usage
            const tip = $('#vramTip');
            const headroom = selectedGpuVram - vram.total;
            const ratio = selectedGpuVram > 0 ? vram.total / selectedGpuVram : 0;

            // Mode info header
            let tipContent = vram.modeInfo ? `<strong style="color: var(--color-gold);">${vram.modeInfo}</strong><br>` : '';

            if (vram.total > selectedGpuVram) {
                tipContent += `<strong>DANGER</strong> ‚Äì Over limit! Try GaLore 8-bit, QLoRA, or ZeRO-3.`;
            } else if (ratio > 0.9) {
                tipContent += `<strong>WARNING</strong> ‚Äì Very tight fit. May OOM during training spikes.`;
            } else if (ratio > 0.7) {
                tipContent += `<strong>CAUTION</strong> ‚Äì Leave ~2GB for CUDA kernels. ~${headroom.toFixed(1)}GB headroom.`;
            } else if (headroom > 10) {
                tipContent += `<strong>SAFE</strong> ‚Äì Plenty of headroom (~${headroom.toFixed(1)}GB). Consider larger batch size.`;
            } else {
                tipContent += `<strong>GOOD</strong> ‚Äì Comfortable fit with ~${headroom.toFixed(1)}GB headroom.`;
            }

            // Add model-specific tip for 4B+ models when using full FT
            const trainingMode = $('#training_mode')?.value || 'full';
            const optimizerType = $('#optimizer_type')?.value || 'adamw';
            if (heroSizeB && heroSizeB >= 4 && trainingMode === 'full' && optimizerType === 'adamw') {
                tipContent += `<br><small style="color: var(--text-muted);">4B+ full FT with AdamW needs ~32GB. Try GaLore 8-bit or QLoRA.</small>`;
            }

            tip.innerHTML = tipContent;
        }

        /**
         * Load VRAM profile from hero-model-info API
         */
        async function loadVramProfile() {
            try {
                const res = await fetch('/api/hero-model-info');
                if (!res.ok) return;
                const info = await res.json();

                if (info.vram_profile) {
                    vramProfile = info.vram_profile;
                }
                if (info.training_defaults) {
                    heroDefaults = info.training_defaults;
                }
                if (info.size_b) {
                    heroSizeB = info.size_b;
                }

                console.log(`[VRAM] Loaded profile for ${info.hero_name || 'unknown'} (${info.size_b || '?'}B)`);
                calculateVram();
            } catch (err) {
                console.warn('[VRAM] Could not load hero profile, using defaults:', err);
            }
        }

        $$('.vram-gpu-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                selectedGpuVram = parseInt(btn.dataset.vram);
                $$('.vram-gpu-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                calculateVram();
            });
        });

        ['batch_size', 'max_length', 'fp_precision', 'training_mode', 'optimizer_type', 'deepspeed_stage'].forEach(id => {
            const el = $(`#${id}`);
            if (el) {
                el.addEventListener('input', calculateVram);
                el.addEventListener('change', calculateVram);
            }
        });

        // ============================================
        // SCHEDULER
        // ============================================

        async function loadScheduler() {
            try {
                const [status, presets] = await Promise.all([
                    SettingsClient.loadScheduler(),
                    SettingsClient.loadSchedulerPresets()
                ]);
                schedulerStatus = status;
                renderSchedulerUI(status, presets.presets || []);
            } catch (error) {
                console.error('Failed to load scheduler:', error);
            }
        }

        function renderSchedulerUI(status, presets) {
            // Presets
            const presetsEl = $('#schedulerPresets');
            if (presetsEl && presets.length > 0) {
                presetsEl.innerHTML = presets.map(p => `
                    <div class="preset-card" data-preset="${p.id}">
                        <div class="preset-card__name">${p.id.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</div>
                        <div class="preset-card__desc">${p.description || ''}</div>
                    </div>
                `).join('');

                presetsEl.querySelectorAll('.preset-card').forEach(card => {
                    card.addEventListener('click', () => applyPreset(card.dataset.preset));
                });
            }

            // Strategy
            $$('.strategy-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.strategy === status.strategy);
                card.addEventListener('click', () => {
                    $$('.strategy-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    checkForChanges();
                });
            });

            // Skill configs
            const skillsEl = $('#skillConfigs');
            if (skillsEl && status.skills) {
                const icons = { sy: 'üß©', bin: 'üî¢' };
                skillsEl.innerHTML = status.skills.map(s => `
                    <div class="skill-config-card ${s.enabled ? '' : 'disabled'}" data-skill="${s.id}">
                        <div class="form-toggle ${s.enabled ? 'active' : ''}" id="skill_${s.id}_enabled"></div>
                        <div class="skill-info">
                            <div class="skill-name">${icons[s.id] || '‚ö°'} ${s.id.toUpperCase()}</div>
                            <div class="skill-level">L${s.current_level}/${s.max_level} ${s.current_level >= s.max_level ? '<span class="mastered">Mastered</span>' : ''}</div>
                        </div>
                        <div class="skill-input-group">
                            <label>Priority</label>
                            <input type="number" min="1" max="99" value="${s.priority}" id="skill_${s.id}_priority">
                        </div>
                        <div class="skill-input-group">
                            <label>Weight</label>
                            <input type="number" min="0" max="10" step="0.5" value="${s.weight}" id="skill_${s.id}_weight">
                        </div>
                    </div>
                `).join('');

                // Attach toggle handlers
                skillsEl.querySelectorAll('.form-toggle').forEach(toggle => {
                    toggle.addEventListener('click', () => {
                        toggle.classList.toggle('active');
                        toggle.closest('.skill-config-card').classList.toggle('disabled', !toggle.classList.contains('active'));
                        checkForChanges();
                    });
                });
            }

            // Next decision
            if (status.next_decision) {
                const d = status.next_decision;
                setText('#nextDecisionValue', `${d.skill_id.toUpperCase()} Level ${d.level} √ó ${d.count}`);
                setText('#nextDecisionReason', d.reason);
            }
        }

        async function applyPreset(presetId) {
            try {
                const result = await SettingsClient.applySchedulerPreset(presetId);
                schedulerStatus = result.status;
                renderSchedulerUI(result.status, []);

                $$('.preset-card').forEach(card => {
                    card.classList.toggle('active', card.dataset.preset === presetId);
                });

                const status = $('#saveStatus');
                status.textContent = `Applied: ${presetId.replace(/_/g, ' ')}`;
                status.style.color = 'var(--color-success)';
                setTimeout(() => setText('#saveStatus', ''), 2000);
            } catch (error) {
                const status = $('#saveStatus');
                status.textContent = error.message;
                status.style.color = 'var(--color-danger)';
            }
        }

        // ============================================
        // TIME DISPLAY
        // ============================================

        function updateTime() {
            setText('#timeDisplay', Format.timestamp(new Date()));
        }
        setInterval(updateTime, 1000);
        updateTime();

        // ============================================
        // INIT
        // ============================================

        // Load hero VRAM profile first, then config, then calculate
        loadVramProfile().then(() => {
            loadConfig().then(() => calculateVram());
        });
        loadScheduler();
    </script>
</body>
</html>
