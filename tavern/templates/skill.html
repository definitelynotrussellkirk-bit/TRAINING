<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skill Details - Realm of Training</title>
    <!-- Shared theme -->
    <link rel="stylesheet" href="/static/css/theme.css?v=1">
    <link rel="stylesheet" href="/static/css/game.css?v=3">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Skill page specific styles */
        .skill-page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .skill-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .skill-icon-large {
            font-size: 64px;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            border: 2px solid var(--skill-color, #888);
            box-shadow: 0 0 20px var(--skill-color, #888);
        }

        .skill-title-block {
            flex: 1;
        }

        .skill-title {
            font-family: 'Cinzel', serif;
            font-size: 2.5em;
            color: var(--skill-color, #ffd700);
            margin: 0;
            text-shadow: 0 0 10px var(--skill-color, #ffd700);
        }

        .skill-subtitle {
            color: #aaa;
            font-size: 1.1em;
            margin-top: 5px;
        }

        .skill-badges {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .skill-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .skill-badge.active {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
            color: #4CAF50;
        }

        .skill-stats-row {
            display: flex;
            gap: 15px;
            margin-left: auto;
        }

        .skill-stat-box {
            text-align: center;
            padding: 15px 25px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .skill-stat-value {
            font-size: 2em;
            font-weight: 600;
            color: #fff;
        }

        .skill-stat-label {
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Grid layout for content */
        .skill-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .skill-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
        }

        .skill-card h3 {
            font-family: 'Cinzel', serif;
            color: #ffd700;
            margin: 0 0 15px 0;
            font-size: 1.2em;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
            padding-bottom: 10px;
        }

        .skill-card.full-width {
            grid-column: 1 / -1;
        }

        /* Description */
        .skill-description {
            color: #ccc;
            line-height: 1.6;
            font-size: 1em;
        }

        .rpg-description {
            font-style: italic;
            color: #b8a060;
            padding: 15px;
            background: rgba(184, 160, 96, 0.1);
            border-left: 3px solid #b8a060;
            margin-top: 15px;
        }

        /* Level progression */
        .level-bar {
            height: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .level-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--skill-color, #8B5CF6), var(--skill-color-light, #a78bfa));
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .level-markers {
            display: flex;
            justify-content: space-between;
            color: #666;
            font-size: 0.8em;
        }

        /* Level tiers table */
        .level-tiers {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .level-tiers th {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #888;
            font-weight: 500;
        }

        .level-tiers td {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: #ccc;
        }

        .level-tiers tr.current {
            background: rgba(139, 92, 246, 0.2);
        }

        .level-tiers tr.mastered td {
            color: #4CAF50;
        }

        /* Accuracy history */
        .accuracy-chart {
            height: 150px;
            display: flex;
            align-items: flex-end;
            gap: 4px;
            padding: 10px 0;
        }

        .accuracy-bar {
            flex: 1;
            background: linear-gradient(to top, var(--skill-color, #8B5CF6), transparent);
            border-radius: 3px 3px 0 0;
            min-width: 8px;
            position: relative;
        }

        .accuracy-bar:hover::after {
            content: attr(data-value);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75em;
            white-space: nowrap;
        }

        /* Tags */
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            font-size: 0.85em;
            color: #aaa;
        }

        /* API info */
        .api-info {
            font-family: monospace;
            background: rgba(0, 0, 0, 0.4);
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .api-endpoint {
            color: #4CAF50;
        }

        /* Back button */
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #888;
            text-decoration: none;
            margin-bottom: 20px;
            padding: 8px 16px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
        }

        .back-link:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 60px;
            color: #888;
        }

        .loading-spinner {
            font-size: 3em;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Threshold list */
        .threshold-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
        }

        .threshold-item {
            text-align: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
        }

        .threshold-level {
            font-size: 0.8em;
            color: #888;
        }

        .threshold-value {
            font-size: 1.1em;
            color: #4CAF50;
        }

        /* Eval Results Section */
        .eval-results-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .eval-result-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .eval-result-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(4px);
        }

        .eval-result-icon {
            font-size: 1.2em;
        }

        .eval-result-info {
            flex: 1;
        }

        .eval-result-id {
            font-family: monospace;
            font-size: 0.9em;
            color: #ccc;
        }

        .eval-result-status {
            font-size: 0.8em;
            color: #888;
        }

        .eval-result-status.correct {
            color: #4CAF50;
        }

        .eval-result-status.incorrect {
            color: #f44336;
        }

        /* Eval Preview Modal */
        .eval-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .eval-modal.active {
            display: flex;
        }

        .eval-modal-content {
            background: #1a1a2e;
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .eval-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
        }

        .eval-modal-title {
            font-family: 'Cinzel', serif;
            color: #ffd700;
            margin: 0;
            font-size: 1.2em;
        }

        .eval-modal-counter {
            color: #888;
            font-size: 0.9em;
        }

        .eval-modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
        }

        .eval-modal-close:hover {
            color: #fff;
        }

        .eval-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .eval-section {
            margin-bottom: 20px;
        }

        .eval-section-label {
            font-size: 0.85em;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .eval-section-content {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-word;
            color: #ccc;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .eval-section-content.expected {
            border-left: 3px solid #4CAF50;
        }

        .eval-section-content.model {
            border-left: 3px solid #8B5CF6;
        }

        .eval-section-content.empty {
            color: #666;
            font-style: italic;
        }

        .eval-modal-footer {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 15px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
        }

        .eval-nav-btn {
            padding: 10px 25px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.4);
            color: #ccc;
            cursor: pointer;
            transition: all 0.2s;
        }

        .eval-nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .eval-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .level-select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.4);
            color: #ccc;
            font-size: 0.9em;
        }

        /* Clickable level rows */
        .level-tiers tbody tr {
            cursor: pointer;
            transition: all 0.2s;
        }

        .level-tiers tbody tr:hover {
            background: rgba(255, 215, 0, 0.1);
        }

        .level-tiers tbody tr.selected {
            background: rgba(139, 92, 246, 0.3);
            border-left: 3px solid #8B5CF6;
        }

        .level-tiers tbody tr .view-evals {
            font-size: 0.75em;
            color: #888;
            margin-left: 8px;
        }

        .level-tiers tbody tr:hover .view-evals {
            color: #ffd700;
        }
    </style>
</head>
<body>
    <!-- TITLE BAR -->
    <header class="game-header">
        <div class="header-left">
            <h1 class="game-title">Realm of Training</h1>
        </div>
        <div class="header-right">
            <a href="/" class="back-link" style="margin: 0;">
                <span>‚Üê Back to Game</span>
            </a>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="skill-page">
        <div id="loading" class="loading">
            <div class="loading-spinner">‚öôÔ∏è</div>
            <p>Loading skill data...</p>
        </div>

        <div id="content" style="display: none;">
            <!-- Skill Header -->
            <div class="skill-header" id="skillHeader">
                <div class="skill-icon-large" id="skillIcon">üß©</div>
                <div class="skill-title-block">
                    <h1 class="skill-title" id="skillName">Loading...</h1>
                    <p class="skill-subtitle" id="skillRpgName">-</p>
                    <div class="skill-badges">
                        <span class="skill-badge" id="categoryBadge">-</span>
                        <span class="skill-badge" id="versionBadge">v-</span>
                        <span class="skill-badge active" id="activeBadge" style="display: none;">ACTIVE</span>
                    </div>
                </div>
                <div class="skill-stats-row">
                    <div class="skill-stat-box">
                        <div class="skill-stat-value" id="masteredLevel">0</div>
                        <div class="skill-stat-label">Mastered</div>
                    </div>
                    <div class="skill-stat-box">
                        <div class="skill-stat-value" id="trainingLevel">1</div>
                        <div class="skill-stat-label">Training</div>
                    </div>
                    <div class="skill-stat-box">
                        <div class="skill-stat-value" id="accuracy">0%</div>
                        <div class="skill-stat-label">Accuracy</div>
                    </div>
                </div>
            </div>

            <!-- Content Grid -->
            <div class="skill-content">
                <!-- Description -->
                <div class="skill-card">
                    <h3>üìú Description</h3>
                    <p class="skill-description" id="skillDescription">-</p>
                    <div class="rpg-description" id="rpgDescription">-</div>
                </div>

                <!-- Progression -->
                <div class="skill-card">
                    <h3>üìà Progression</h3>
                    <div class="level-bar">
                        <div class="level-fill" id="levelFill" style="width: 0%;"></div>
                    </div>
                    <div class="level-markers">
                        <span>L1</span>
                        <span id="maxLevelMarker">L50</span>
                    </div>
                    <p style="color: #888; font-size: 0.9em; margin-top: 15px;">
                        <span id="evalCount">0</span> evals at current level
                        (<span id="totalEvals">0</span> total)
                    </p>
                </div>

                <!-- Accuracy History -->
                <div class="skill-card">
                    <h3>üéØ Recent Accuracy</h3>
                    <div class="accuracy-chart" id="accuracyChart">
                        <p style="color: #666; width: 100%; text-align: center;">No evaluation data yet</p>
                    </div>
                </div>

                <!-- Accuracy Thresholds -->
                <div class="skill-card">
                    <h3>üèÜ Accuracy Thresholds</h3>
                    <div class="threshold-list" id="thresholdList">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- Level Progression Details -->
                <div class="skill-card full-width">
                    <h3>‚¨ÜÔ∏è Level Progression</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table class="level-tiers" id="levelTiersTable">
                            <thead>
                                <tr>
                                    <th>Level</th>
                                    <th>Name</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="levelTiersBody">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Recent Eval Results -->
                <div class="skill-card full-width">
                    <h3>üî¨ Recent Evaluation Results
                        <select class="level-select" id="evalLevelSelect" style="margin-left: auto; float: right;">
                            <option value="">Current Level</option>
                        </select>
                    </h3>
                    <div id="evalResultsContent">
                        <p class="no-data">Loading evaluation data...</p>
                    </div>
                </div>

                <!-- Tags -->
                <div class="skill-card">
                    <h3>üè∑Ô∏è Tags</h3>
                    <div class="tag-list" id="tagList">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- API Info -->
                <div class="skill-card">
                    <h3>üîå API</h3>
                    <div class="api-info">
                        <p><strong>URL:</strong> <span class="api-endpoint" id="apiUrl">-</span></p>
                        <p><strong>Endpoints:</strong></p>
                        <ul id="apiEndpoints" style="margin: 5px 0 0 20px; color: #888;">
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- NAVIGATION (dynamic) -->
    <nav class="game-nav" id="bottomNav"></nav>
    <script src="/static/js/nav.js"></script>

    <!-- Validation Set Modal -->
    <div class="eval-modal" id="validationModal">
        <div class="eval-modal-content">
            <div class="eval-modal-header">
                <h3 class="eval-modal-title" id="validationModalTitle">Level 1 Validation Set</h3>
                <span class="eval-modal-counter" id="validationModalCounter">1/5</span>
                <button class="eval-modal-close" onclick="closeValidationModal()">&times;</button>
            </div>
            <div class="eval-modal-body">
                <div class="eval-section">
                    <div class="eval-section-label">üìù Problem</div>
                    <div class="eval-section-content" id="validationPrompt" style="max-height: 300px; overflow-y: auto;">-</div>
                </div>
                <div class="eval-section">
                    <div class="eval-section-label">‚úÖ Expected Answer</div>
                    <div class="eval-section-content expected" id="validationExpected">-</div>
                </div>
            </div>
            <div class="eval-modal-footer">
                <button class="eval-nav-btn" onclick="prevValidation()">‚óÄ Prev</button>
                <button class="eval-nav-btn" onclick="nextValidation()">Next ‚ñ∂</button>
            </div>
        </div>
    </div>

    <!-- Eval Preview Modal -->
    <div class="eval-modal" id="evalModal">
        <div class="eval-modal-content">
            <div class="eval-modal-header">
                <h3 class="eval-modal-title" id="evalModalTitle">Evaluation Result</h3>
                <span class="eval-modal-counter" id="evalModalCounter">1/20</span>
                <button class="eval-modal-close" onclick="closeEvalModal()">&times;</button>
            </div>
            <div class="eval-modal-body">
                <div class="eval-section">
                    <div class="eval-section-label">‚úÖ Expected Answer</div>
                    <div class="eval-section-content expected" id="evalExpected">-</div>
                </div>
                <div class="eval-section">
                    <div class="eval-section-label">ü§ñ Model Output</div>
                    <div class="eval-section-content model" id="evalModelAnswer">-</div>
                </div>
            </div>
            <div class="eval-modal-footer">
                <button class="eval-nav-btn" onclick="prevEval()">‚óÄ Prev</button>
                <button class="eval-nav-btn" onclick="nextEval()">Next ‚ñ∂</button>
            </div>
        </div>
    </div>

    <script>
        // Get skill ID from URL
        const pathParts = window.location.pathname.split('/');
        const skillId = pathParts[pathParts.length - 1];

        // Fetch and render skill data
        async function loadSkillData() {
            try {
                const response = await fetch(`/skill-data/${skillId}`);
                if (!response.ok) {
                    throw new Error(`Skill not found: ${skillId}`);
                }
                const data = await response.json();
                renderSkill(data);
            } catch (error) {
                document.getElementById('loading').innerHTML = `
                    <p style="color: #f44336;">Error: ${error.message}</p>
                    <a href="/" class="back-link">‚Üê Back to Game</a>
                `;
            }
        }

        function renderSkill(data) {
            const config = data.config;
            const state = data.state;
            const display = config.display || {};

            // Set CSS variable for skill color
            const skillColor = display.color || '#888';
            document.documentElement.style.setProperty('--skill-color', skillColor);

            // Header
            document.getElementById('skillIcon').textContent = display.icon || '‚öîÔ∏è';
            document.getElementById('skillName').textContent = config.rpg_name || config.name;
            document.getElementById('skillRpgName').textContent = config.name + ' - ' + (config.category || 'general');
            document.getElementById('categoryBadge').textContent = config.category || 'general';
            document.getElementById('versionBadge').textContent = 'v' + (config.version || '1.0');

            if (data.is_active) {
                document.getElementById('activeBadge').style.display = 'inline';
            }

            // Stats
            document.getElementById('masteredLevel').textContent = state.mastered_level;
            document.getElementById('trainingLevel').textContent = state.training_level;
            document.getElementById('accuracy').textContent = state.accuracy + '%';

            // Description
            document.getElementById('skillDescription').textContent = config.description || '-';
            document.getElementById('rpgDescription').textContent = config.rpg_description || '-';

            // Level progress bar
            const maxLevel = config.max_level || 50;
            const progress = (state.mastered_level / maxLevel) * 100;
            document.getElementById('levelFill').style.width = progress + '%';
            document.getElementById('maxLevelMarker').textContent = 'L' + maxLevel;

            // Populate level select dropdown
            populateLevelSelect(maxLevel);
            document.getElementById('evalCount').textContent = state.eval_count;
            document.getElementById('totalEvals').textContent = state.total_evals;

            // Accuracy chart
            if (state.accuracy_history && state.accuracy_history.length > 0) {
                const chartEl = document.getElementById('accuracyChart');
                chartEl.innerHTML = '';
                const maxAcc = 100;
                state.accuracy_history.forEach(entry => {
                    const acc = (entry.accuracy || 0) * 100;
                    const bar = document.createElement('div');
                    bar.className = 'accuracy-bar';
                    bar.style.height = (acc / maxAcc * 100) + '%';
                    bar.setAttribute('data-value', acc.toFixed(1) + '% L' + (entry.training_level || entry.level || '?'));
                    bar.title = `${acc.toFixed(1)}% at L${entry.training_level || entry.level || '?'}`;
                    chartEl.appendChild(bar);
                });
            }

            // Accuracy thresholds
            const thresholds = config.accuracy_thresholds || {};
            const thresholdEl = document.getElementById('thresholdList');
            thresholdEl.innerHTML = '';
            Object.entries(thresholds).sort((a, b) => parseInt(a[0]) - parseInt(b[0])).forEach(([level, threshold]) => {
                const item = document.createElement('div');
                item.className = 'threshold-item';
                if (parseInt(level) <= state.mastered_level) {
                    item.style.borderLeft = '3px solid #4CAF50';
                }
                item.innerHTML = `
                    <div class="threshold-level">L${level}</div>
                    <div class="threshold-value">${(threshold * 100).toFixed(0)}%</div>
                `;
                thresholdEl.appendChild(item);
            });

            // Level tiers
            const levelProg = config.level_progression || {};
            const tiersBody = document.getElementById('levelTiersBody');
            tiersBody.innerHTML = '';
            Object.entries(levelProg).sort((a, b) => parseInt(a[0]) - parseInt(b[0])).forEach(([level, info]) => {
                const row = document.createElement('tr');
                const lvl = parseInt(level);
                if (lvl === state.training_level) row.className = 'current';
                if (lvl <= state.mastered_level) row.className = 'mastered';

                // Format details based on skill type
                let details = '';
                if (info.words) {
                    // SY skill
                    details = `Words: ${info.words}, Syllables: ${info.syllables}, Zipf: ${info.zipf}, Overlap: ${info.overlap}%, Herrings: ${info.herrings}`;
                } else if (info.bits) {
                    // BIN skill
                    details = `${info.bits}-bit, Max: ${info.max_unsigned}, Symbols: ${info.symbols || 'no'}`;
                } else {
                    details = JSON.stringify(info).slice(0, 80);
                }

                row.innerHTML = `
                    <td><strong>L${level}</strong> <span class="view-evals">üìã view problems</span></td>
                    <td>${info.name || info.desc || '-'}</td>
                    <td style="font-size: 0.85em; color: #888;">${details}</td>
                `;
                row.dataset.level = level;
                row.addEventListener('click', () => selectLevelForEvals(parseInt(level)));
                tiersBody.appendChild(row);
            });

            // Tags
            const tags = config.tags || [];
            const tagList = document.getElementById('tagList');
            tagList.innerHTML = '';
            tags.forEach(tag => {
                const tagEl = document.createElement('span');
                tagEl.className = 'tag';
                tagEl.textContent = tag;
                tagList.appendChild(tagEl);
            });

            // API info
            const api = config.api || {};
            document.getElementById('apiUrl').textContent = api.url || '-';
            const endpointsList = document.getElementById('apiEndpoints');
            endpointsList.innerHTML = '';
            const endpoints = api.endpoints || {};
            Object.entries(endpoints).forEach(([name, endpoint]) => {
                const li = document.createElement('li');
                li.textContent = `${name}: ${endpoint}`;
                endpointsList.appendChild(li);
            });

            // Show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            // Load eval results after skill data
            loadEvalResults();
        }

        // ============================================
        // EVAL RESULTS
        // ============================================

        let evalResults = [];
        let currentEvalIndex = 0;

        async function loadEvalResults(level = null) {
            try {
                const url = level
                    ? `/api/evals/${skillId}?level=${level}`
                    : `/api/evals/${skillId}`;

                const response = await fetch(url);
                if (!response.ok) return;

                const data = await response.json();
                renderEvalResults(data);
            } catch (error) {
                console.error('Failed to load eval results:', error);
            }
        }

        function renderEvalResults(data) {
            const container = document.getElementById('evalResultsContent');
            const levelSelect = document.getElementById('evalLevelSelect');

            // Store results for modal navigation
            evalResults = data.latest?.results || [];

            if (!data.latest || evalResults.length === 0) {
                const levelMsg = selectedLevel
                    ? `No evaluation data for Level ${selectedLevel} yet.`
                    : 'No evaluation data available for this skill yet.';
                container.innerHTML = `<p class="no-data">${levelMsg}</p>`;
                return;
            }

            // Check if this eval matches the selected level
            if (selectedLevel && data.latest.level !== selectedLevel) {
                container.innerHTML = `<p class="no-data">No evaluation data for Level ${selectedLevel} yet. Latest eval was for Level ${data.latest.level}.</p>`;
                return;
            }

            const latest = data.latest;
            const correct = latest.correct || 0;
            const total = latest.total || evalResults.length;
            const accuracy = (latest.accuracy * 100).toFixed(1);
            const passThreshold = 80;
            const passed = latest.accuracy * 100 >= passThreshold;

            let html = `
                <div style="margin-bottom: 15px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>Level ${latest.level}</strong>
                            <span style="color: #888; margin-left: 10px;">${latest.level_name || ''}</span>
                        </div>
                        <div style="text-align: right;">
                            <span style="font-size: 1.3em; font-weight: bold; color: ${passed ? '#4CAF50' : '#f44336'};">
                                ${accuracy}%
                            </span>
                            <span style="color: #888; margin-left: 5px;">(${correct}/${total})</span>
                        </div>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.85em; color: #888;">
                        Step ${latest.step?.toLocaleString() || '-'} ‚Ä¢
                        ${latest.timestamp ? new Date(latest.timestamp).toLocaleString() : '-'}
                        ${passed ? '<span style="color: #4CAF50; margin-left: 10px;">‚úì PASSED (‚â•80%)</span>' : '<span style="color: #f44336; margin-left: 10px;">‚úó Need ‚â•80% to advance</span>'}
                    </div>
                </div>

                <div class="eval-results-list">
            `;

            evalResults.forEach((result, index) => {
                const icon = result.correct ? '‚úÖ' : '‚ùå';
                const statusClass = result.correct ? 'correct' : 'incorrect';

                html += `
                    <div class="eval-result-item" onclick="showEvalModal(${index})">
                        <span class="eval-result-icon">${icon}</span>
                        <div class="eval-result-info">
                            <div class="eval-result-id">${result.problem_id || `Problem ${index + 1}`}</div>
                            <div class="eval-result-status ${statusClass}">
                                ${result.correct ? 'Correct' : 'Incorrect'}
                                ${result.partial_score > 0 ? ` (${(result.partial_score * 100).toFixed(0)}% partial)` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function showEvalModal(index) {
            if (index < 0 || index >= evalResults.length) return;

            currentEvalIndex = index;
            const result = evalResults[index];

            document.getElementById('evalModalTitle').textContent =
                result.problem_id || `Problem ${index + 1}`;
            document.getElementById('evalModalCounter').textContent =
                `${index + 1}/${evalResults.length}`;

            const expectedEl = document.getElementById('evalExpected');
            const modelEl = document.getElementById('evalModelAnswer');

            expectedEl.textContent = result.expected || '(no expected answer)';
            expectedEl.classList.toggle('empty', !result.expected);

            modelEl.textContent = result.model_answer || '(no model output)';
            modelEl.classList.toggle('empty', !result.model_answer);

            document.getElementById('evalModal').classList.add('active');
        }

        function closeEvalModal() {
            document.getElementById('evalModal').classList.remove('active');
        }

        function prevEval() {
            if (currentEvalIndex > 0) {
                showEvalModal(currentEvalIndex - 1);
            }
        }

        function nextEval() {
            if (currentEvalIndex < evalResults.length - 1) {
                showEvalModal(currentEvalIndex + 1);
            }
        }

        // Close modal on escape or click outside
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeEvalModal();
            if (e.key === 'ArrowLeft') prevEval();
            if (e.key === 'ArrowRight') nextEval();
        });

        document.getElementById('evalModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('eval-modal')) {
                closeEvalModal();
            }
        });

        // Level select dropdown filters eval results (different from clicking level rows)
        document.getElementById('evalLevelSelect')?.addEventListener('change', (e) => {
            const level = e.target.value || null;
            selectedLevel = level ? parseInt(level) : null;
            loadEvalResults(selectedLevel);
        });

        let selectedLevel = null;

        // ============================================
        // VALIDATION SET (browse test problems)
        // ============================================

        let validationProblems = [];
        let currentValidationIndex = 0;

        function selectLevelForEvals(level) {
            // When clicking a level row, show the validation set for that level
            loadValidationSet(level);
        }

        async function loadValidationSet(level) {
            try {
                const response = await fetch(`/api/validation/${skillId}?level=${level}`);
                if (!response.ok) throw new Error('Failed to load validation set');

                const data = await response.json();

                if (data.error) {
                    alert(data.error);
                    return;
                }

                validationProblems = data.problems || [];
                currentValidationIndex = 0;

                if (validationProblems.length === 0) {
                    alert(`No validation problems available for Level ${level}`);
                    return;
                }

                document.getElementById('validationModalTitle').textContent =
                    `Level ${level} Validation Set`;

                showValidationProblem(0);
                document.getElementById('validationModal').classList.add('active');

            } catch (error) {
                console.error('Failed to load validation set:', error);
                alert('Failed to load validation set. Is the skill API running?');
            }
        }

        function showValidationProblem(index) {
            if (index < 0 || index >= validationProblems.length) return;

            currentValidationIndex = index;
            const problem = validationProblems[index];

            document.getElementById('validationModalCounter').textContent =
                `${index + 1}/${validationProblems.length}`;
            document.getElementById('validationPrompt').textContent =
                problem.prompt || '(no prompt)';
            document.getElementById('validationExpected').textContent =
                problem.expected || '(no expected answer)';
        }

        function closeValidationModal() {
            document.getElementById('validationModal').classList.remove('active');
        }

        function prevValidation() {
            if (currentValidationIndex > 0) {
                showValidationProblem(currentValidationIndex - 1);
            }
        }

        function nextValidation() {
            if (currentValidationIndex < validationProblems.length - 1) {
                showValidationProblem(currentValidationIndex + 1);
            }
        }

        // Close validation modal on click outside
        document.getElementById('validationModal')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('eval-modal')) {
                closeValidationModal();
            }
        });

        function populateLevelSelect(maxLevel) {
            const select = document.getElementById('evalLevelSelect');
            if (!select) return;

            select.innerHTML = '<option value="">All Levels</option>';
            for (let i = 1; i <= maxLevel; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = `Level ${i}`;
                select.appendChild(opt);
            }
        }

        // Load on page load
        loadSkillData();
    </script>
</body>
</html>
