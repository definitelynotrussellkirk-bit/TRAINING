<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temple of Diagnostics | Realm of Training</title>
    <link rel="stylesheet" href="/static/css/theme.css?v=1">
    <link rel="stylesheet" href="/static/css/game.css?v=3">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        .temple-main {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 1.5rem;
            padding: 1.5rem;
            height: calc(100vh - 140px);
            overflow: hidden;
        }

        /* Cleric panel */
        .cleric-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .cleric-portrait {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a1a2e 0%, #2a2a4e 100%);
            border: 3px solid rgba(200, 230, 255, 0.4);
            margin: 0 auto 1rem;
            font-size: 3.5rem;
            box-shadow: 0 0 30px rgba(200, 230, 255, 0.15);
            transition: all 0.3s ease;
        }

        .cleric-portrait.casting {
            animation: castingPulse 1s ease-in-out infinite;
            border-color: #00ffff;
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.3);
        }

        .cleric-portrait.healthy {
            border-color: #4CAF50;
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.3);
        }

        .cleric-portrait.warning {
            border-color: #ffa726;
            box-shadow: 0 0 30px rgba(255, 167, 38, 0.3);
        }

        .cleric-portrait.danger {
            border-color: #ff6b6b;
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.3);
        }

        @keyframes castingPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .cleric-title {
            text-align: center;
            font-family: var(--font-display);
            font-size: 1.2rem;
            color: var(--color-gold);
            margin-bottom: 0.5rem;
        }

        .cleric-dialogue {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 1.5rem;
            min-height: 3rem;
            transition: opacity 0.3s ease;
        }

        /* Rituals section */
        .rituals-section h3 {
            font-family: var(--font-display);
            color: var(--color-gold);
            font-size: 1rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .ritual-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .ritual-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .ritual-group-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 0.25rem;
        }

        .ritual-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            color: var(--text-primary);
            width: 100%;
        }

        .ritual-btn:hover {
            border-color: var(--color-gold);
            background: var(--bg-card);
        }

        .ritual-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ritual-btn.running {
            border-color: #00ffff;
            animation: runningPulse 1.5s ease-in-out infinite;
        }

        @keyframes runningPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 255, 255, 0.3); }
            50% { box-shadow: 0 0 15px 3px rgba(0, 255, 255, 0.2); }
        }

        .ritual-icon {
            font-size: 1.3rem;
            width: 28px;
            text-align: center;
        }

        .ritual-info {
            flex: 1;
            min-width: 0;
        }

        .ritual-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .ritual-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Results panel */
        .results-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .results-header h2 {
            font-family: var(--font-display);
            color: var(--color-gold);
            font-size: 1.2rem;
            margin: 0;
        }

        .result-summary {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-dark);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .result-summary.ok { border-left: 4px solid #4CAF50; }
        .result-summary.warn { border-left: 4px solid #ffa726; }
        .result-summary.fail { border-left: 4px solid #ff6b6b; }
        .result-summary.skip { border-left: 4px solid #666; }

        .summary-icon {
            font-size: 2rem;
        }

        .summary-text h3 {
            margin: 0;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .summary-meta {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 4px;
        }

        .summary-counts {
            display: flex;
            gap: 1rem;
            margin-left: auto;
        }

        .count-badge {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .count-badge.ok { background: rgba(76, 175, 80, 0.2); color: #4CAF50; }
        .count-badge.warn { background: rgba(255, 167, 38, 0.2); color: #ffa726; }
        .count-badge.fail { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }

        /* Checks list */
        .checks-container {
            flex: 1;
            overflow-y: auto;
        }

        .category-group {
            margin-bottom: 1rem;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-dark);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            user-select: none;
        }

        .category-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .category-icon {
            font-size: 1rem;
        }

        .category-name {
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .category-count {
            margin-left: auto;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .checks-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .check-row {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-dark);
            border-radius: 8px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .check-row:hover {
            border-color: var(--border-color);
        }

        .check-row.ok { border-left: 3px solid #4CAF50; }
        .check-row.warn { border-left: 3px solid #ffa726; }
        .check-row.fail { border-left: 3px solid #ff6b6b; }
        .check-row.skip { border-left: 3px solid #666; }

        .check-icon {
            font-size: 1rem;
            width: 20px;
            text-align: center;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .check-content {
            flex: 1;
            min-width: 0;
        }

        .check-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .check-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .check-remediation {
            font-size: 0.75rem;
            color: #ffa726;
            margin-top: 6px;
            padding: 4px 8px;
            background: rgba(255, 167, 38, 0.1);
            border-radius: 4px;
            display: none;
        }

        .check-row.fail .check-remediation,
        .check-row.warn .check-remediation {
            display: block;
        }

        .check-details {
            margin-top: 8px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            display: none;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .check-row.expanded .check-details {
            display: block;
        }

        .check-duration {
            color: var(--text-muted);
            font-size: 0.75rem;
            font-family: monospace;
            flex-shrink: 0;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state h3 {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        /* Ritual selector badges */
        .ritual-category-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 3px;
            background: var(--bg-card);
            color: var(--text-muted);
            margin-left: auto;
        }
    </style>
</head>
<body>
    <!-- TITLE BAR -->
    <header class="game-header">
        <div class="header-left">
            <h1 class="game-title">üèõÔ∏è Temple of Diagnostics</h1>
        </div>
        <div class="header-center">
            <div class="resource-bar">
                <div class="resource">
                    <span class="resource-icon">ü©∫</span>
                    <span class="resource-label">CHECKS</span>
                    <span class="resource-value" id="totalChecks">0</span>
                </div>
                <div class="resource">
                    <span class="resource-icon">‚úÖ</span>
                    <span class="resource-label">PASSED</span>
                    <span class="resource-value" id="passedChecks">0</span>
                </div>
            </div>
        </div>
        <div class="header-right">
            <div class="time-display" id="timeDisplay">--:--:--</div>
        </div>
    </header>

    <!-- MAIN TEMPLE AREA -->
    <main class="temple-main">
        <!-- Cleric Panel -->
        <aside class="cleric-panel">
            <div class="cleric-portrait" id="clericPortrait">üßô</div>
            <div class="cleric-title">The Cleric</div>
            <p class="cleric-dialogue" id="clericDialogue">
                "Speak your doubts, and I shall test the Realm.
                Through sacred rituals, we reveal what lies hidden."
            </p>

            <div class="rituals-section">
                <h3>Sacred Rituals</h3>
                <div class="ritual-list" id="ritualList">
                    <div class="empty-state">
                        <p>Loading rituals...</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Results Panel -->
        <section class="results-panel">
            <div class="results-header">
                <h2>Ritual Results</h2>
                <span id="lastRunTime" style="color: var(--text-muted); font-size: 0.8rem;"></span>
            </div>

            <div id="resultSummary" class="result-summary" style="display: none;">
                <div class="summary-icon" id="summaryIcon"></div>
                <div class="summary-text">
                    <h3 id="summaryTitle">-</h3>
                    <div class="summary-meta" id="summaryMeta">-</div>
                </div>
                <div class="summary-counts" id="summaryCounts"></div>
            </div>

            <div class="checks-container" id="checksContainer">
                <div class="empty-state">
                    <h3>No Ritual Cast</h3>
                    <p>Select a ritual from the left to begin diagnostics</p>
                </div>
            </div>
        </section>
    </main>

    <!-- NAVIGATION (dynamic) -->
    <nav class="game-nav" id="bottomNav"></nav>
    <script src="/static/js/nav.js"></script>

    <script>
        // Constants
        const STATUS_ICONS = {
            'ok': '‚úÖ',
            'warn': '‚ö†Ô∏è',
            'fail': '‚ùå',
            'skip': '‚è≠Ô∏è'
        };

        const RITUAL_ICONS = {
            'quick': '‚ö°',
            'api': 'üåê',
            'forge': 'üî•',
            'weaver': 'üï∏Ô∏è',
            'champion': 'üèÜ',
            'oracle': 'üîÆ',
            'guild': '‚öîÔ∏è',
            'scribe': 'üìú',
            'deep': 'üåä'
        };

        const KIND_LABELS = {
            'healthcheck': 'ü©∫ Health Checks',
            'eval': 'üìä Evaluation',
            'training': 'üéØ Training',
            'infra': 'üîß Infrastructure',
            'meta': '‚ú® Meta'
        };

        const KIND_ORDER = ['healthcheck', 'eval', 'training', 'infra', 'meta'];

        const CATEGORY_ICONS = {
            'network': 'üåê',
            'storage': 'üíæ',
            'hardware': 'üñ•Ô∏è',
            'daemon': 'üëª',
            'model': 'ü§ñ',
            'inference': 'üîÆ',
            'skills': 'üìö',
            'ritual': '‚ú®',
            'default': 'üìã'
        };

        const CLERIC_DIALOGUES = {
            idle: [
                "Speak your doubts, and I shall test the Realm.",
                "The sacred stones await your command.",
                "What mysteries shall we uncover today?"
            ],
            casting: [
                "The ritual begins... sacred energies flow...",
                "Reading the signs... interpreting the omens...",
                "Communing with the systems..."
            ],
            healthy: [
                "The Realm's aura is strong today! All systems thrive.",
                "Excellent! The training grounds pulse with vitality.",
                "The forces align perfectly. Continue your journey!"
            ],
            warning: [
                "I sense disturbances in the data streams...",
                "Caution, traveler. Some paths require attention.",
                "Minor shadows cloud the horizon. Review the warnings."
            ],
            danger: [
                "Dark forces corrupt the training grounds!",
                "Grave troubles plague the Realm. Action is needed!",
                "The systems cry out for healing. Attend to them!"
            ]
        };

        let currentRunning = null;

        // Time display
        function updateTime() {
            document.getElementById('timeDisplay').textContent = new Date().toLocaleTimeString();
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Cleric dialogue
        function setClericDialogue(category) {
            const dialogues = CLERIC_DIALOGUES[category] || CLERIC_DIALOGUES.idle;
            const dialogue = dialogues[Math.floor(Math.random() * dialogues.length)];
            document.getElementById('clericDialogue').textContent = `"${dialogue}"`;
        }

        function setClericState(state) {
            const portrait = document.getElementById('clericPortrait');
            portrait.className = 'cleric-portrait';
            if (state) portrait.classList.add(state);
        }

        // Load rituals
        async function loadRituals() {
            try {
                const res = await fetch('/api/temple/rituals');
                const data = await res.json();

                if (!data.ok) throw new Error(data.error || 'Failed to load');

                const rituals = data.rituals || {};
                const listEl = document.getElementById('ritualList');

                if (Object.keys(rituals).length === 0) {
                    listEl.innerHTML = '<div class="empty-state"><p>No rituals available</p></div>';
                    return;
                }

                // Group by kind
                const byKind = {};
                Object.values(rituals).forEach(r => {
                    const kind = r.kind || 'healthcheck';
                    if (!byKind[kind]) byKind[kind] = [];
                    byKind[kind].push(r);
                });

                // Build HTML with groups
                let html = '';
                KIND_ORDER.forEach(kind => {
                    if (!byKind[kind] || byKind[kind].length === 0) return;

                    const kindLabel = KIND_LABELS[kind] || kind;
                    const ritualList = byKind[kind].sort((a, b) => {
                        // Quick first, deep last within kind
                        if (a.id === 'quick') return -1;
                        if (b.id === 'quick') return 1;
                        if (a.id === 'deep') return 1;
                        if (b.id === 'deep') return -1;
                        return a.name.localeCompare(b.name);
                    });

                    html += `<div class="ritual-group">
                        <div class="ritual-group-label">${kindLabel}</div>
                        ${ritualList.map(r => `
                            <button class="ritual-btn" data-ritual="${r.id}" onclick="runRitual('${r.id}')">
                                <span class="ritual-icon">${r.icon || RITUAL_ICONS[r.id] || 'üîÆ'}</span>
                                <div class="ritual-info">
                                    <div class="ritual-name">${r.name}</div>
                                    <div class="ritual-desc">${r.description}</div>
                                </div>
                            </button>
                        `).join('')}
                    </div>`;
                });

                listEl.innerHTML = html;

            } catch (err) {
                console.error('Failed to load rituals:', err);
                document.getElementById('ritualList').innerHTML =
                    `<div class="empty-state"><p>Error: ${err.message}</p></div>`;
            }
        }

        // Run ritual
        async function runRitual(ritualId) {
            if (currentRunning) return;

            currentRunning = ritualId;
            const btn = document.querySelector(`[data-ritual="${ritualId}"]`);
            if (btn) {
                btn.classList.add('running');
                btn.disabled = true;
            }

            setClericState('casting');
            setClericDialogue('casting');

            document.getElementById('checksContainer').innerHTML =
                '<div class="empty-state"><p>Casting ritual...</p></div>';
            document.getElementById('resultSummary').style.display = 'none';

            try {
                const res = await fetch('/api/temple/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ritual_id: ritualId })
                });

                const data = await res.json();
                if (!data.ok) throw new Error(data.error || 'Ritual failed');

                renderResults(data.ritual);

            } catch (err) {
                console.error('Ritual failed:', err);
                document.getElementById('checksContainer').innerHTML =
                    `<div class="empty-state"><h3>Ritual Failed</h3><p>${err.message}</p></div>`;
                setClericState('danger');
                setClericDialogue('danger');
            } finally {
                currentRunning = null;
                if (btn) {
                    btn.classList.remove('running');
                    btn.disabled = false;
                }
            }
        }

        function renderResults(ritual) {
            // Update Cleric state based on results
            if (ritual.status === 'ok') {
                setClericState('healthy');
                setClericDialogue('healthy');
            } else if (ritual.status === 'warn') {
                setClericState('warning');
                setClericDialogue('warning');
            } else {
                setClericState('danger');
                setClericDialogue('danger');
            }

            // Update summary
            const summaryEl = document.getElementById('resultSummary');
            summaryEl.className = `result-summary ${ritual.status}`;
            summaryEl.style.display = 'flex';

            document.getElementById('summaryIcon').textContent = STATUS_ICONS[ritual.status] || '‚ùì';
            document.getElementById('summaryTitle').textContent = ritual.name;

            const duration = ritual.duration_ms ? `${ritual.duration_ms.toFixed(0)}ms` : '-';
            document.getElementById('summaryMeta').textContent = `Completed in ${duration}`;

            // Count by status
            const counts = { ok: 0, warn: 0, fail: 0, skip: 0 };
            (ritual.checks || []).forEach(c => counts[c.status]++);

            document.getElementById('summaryCounts').innerHTML = `
                <span class="count-badge ok">‚úÖ ${counts.ok}</span>
                <span class="count-badge warn">‚ö†Ô∏è ${counts.warn}</span>
                <span class="count-badge fail">‚ùå ${counts.fail}</span>
            `;

            // Update header stats
            document.getElementById('totalChecks').textContent = ritual.checks?.length || 0;
            document.getElementById('passedChecks').textContent = counts.ok;

            document.getElementById('lastRunTime').textContent =
                `Last run: ${new Date().toLocaleTimeString()}`;

            // Group checks by category
            const grouped = {};
            (ritual.checks || []).forEach(check => {
                const cat = check.category || 'default';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(check);
            });

            // Render grouped checks
            const container = document.getElementById('checksContainer');

            if (Object.keys(grouped).length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No checks in this ritual</p></div>';
                return;
            }

            container.innerHTML = Object.entries(grouped).map(([category, checks]) => {
                const catIcon = CATEGORY_ICONS[category] || CATEGORY_ICONS.default;
                const catFails = checks.filter(c => c.status === 'fail').length;
                const catWarns = checks.filter(c => c.status === 'warn').length;

                return `
                    <div class="category-group">
                        <div class="category-header">
                            <span class="category-icon">${catIcon}</span>
                            <span class="category-name">${category}</span>
                            <span class="category-count">
                                ${checks.length} check${checks.length !== 1 ? 's' : ''}
                                ${catFails ? ` ¬∑ ${catFails} failed` : ''}
                                ${catWarns ? ` ¬∑ ${catWarns} warnings` : ''}
                            </span>
                        </div>
                        <div class="checks-list">
                            ${checks.map(renderCheck).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCheck(check) {
            const duration = check.duration_ms ? `${check.duration_ms.toFixed(0)}ms` : '';
            const remediation = check.remediation
                ? `<div class="check-remediation">üí° ${escapeHtml(check.remediation)}</div>`
                : '';
            const details = JSON.stringify(check.details, null, 2);

            return `
                <div class="check-row ${check.status}" onclick="this.classList.toggle('expanded')">
                    <div class="check-icon">${STATUS_ICONS[check.status] || '‚ùì'}</div>
                    <div class="check-content">
                        <div class="check-name">${escapeHtml(check.name)}</div>
                        <div class="check-desc">${escapeHtml(check.description || '')}</div>
                        ${remediation}
                        <pre class="check-details">${escapeHtml(details)}</pre>
                    </div>
                    <div class="check-duration">${duration}</div>
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadRituals();
            setClericDialogue('idle');
        });
    </script>
</body>
</html>
